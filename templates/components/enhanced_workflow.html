<!-- Enhanced Booking Workflow UI Component -->
<div id="enhanced-workflow-{{ booking.id }}" class="enhanced-workflow-container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-project-diagram"></i> Enhanced Booking Workflow
                <span class="badge badge-light ml-2">{{ booking.booking_reference }}</span>
            </h5>
        </div>

        <div class="card-body">
            <!-- Workflow Progress Bar -->
            <!-- Progress Bar -->
            <div class="workflow-progress mb-4">
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar {% if booking.status == 'quoted' %}bg-warning{% elif booking.status == 'paid' and booking.invoice_status == 'synchronized' %}bg-success{% elif booking.status == 'vouchered' %}bg-primary{% else %}bg-secondary{% endif %}"
                        role="progressbar"
                        style="width: {% if booking.status == 'quoted' %}33%{% elif booking.status == 'paid' and booking.invoice_status == 'synchronized' %}66%{% elif booking.status == 'vouchered' %}100%{% else %}0%{% endif %}"
                        aria-valuenow="{% if booking.status == 'quoted' %}33{% elif booking.status == 'paid' and booking.invoice_status == 'synchronized' %}66{% elif booking.status == 'vouchered' %}100{% else %}0{% endif %}"
                        aria-valuemin="0" aria-valuemax="100">
                        {% if booking.status == 'quoted' %}Step 1: Quoted
                        {% elif booking.status == 'paid' and booking.invoice_status == 'synchronized' %}Step 2: Paid +
                        Auto Synced
                        {% elif booking.status == 'vouchered' %}Step 3: Vouchered (Complete)
                        {% else %}{{ booking.status|title }}
                        {% endif %}
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <small
                        class="{% if booking.status in ['quoted', 'paid', 'vouchered'] %}text-success font-weight-bold{% else %}text-muted{% endif %}">
                        <i class="fas fa-quote-right"></i> Quoted
                    </small>
                    <small
                        class="{% if booking.status == 'paid' and booking.invoice_status == 'synchronized' or booking.status == 'vouchered' %}text-success font-weight-bold{% else %}text-muted{% endif %}">
                        <i class="fas fa-credit-card"></i> Paid + Auto Synced
                    </small>
                    <small
                        class="{% if booking.status == 'vouchered' %}text-success font-weight-bold{% else %}text-muted{% endif %}">
                        <i class="fas fa-ticket-alt"></i> Vouchered
                    </small>
                </div>
            </div> <!-- Current Status Display -->
            <div class="current-status mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="status-item">
                            <label class="font-weight-bold">Current Status:</label>
                            <span
                                class="badge badge-{% if booking.status == 'quoted' %}info{% elif booking.status == 'paid' %}success{% elif booking.status == 'vouchered' %}primary{% else %}secondary{% endif %} ml-2">
                                {{ booking.status|title }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="status-item">
                            <label class="font-weight-bold">Invoice Status:</label>
                            <span
                                class="badge badge-{% if booking.invoice_status == 'synchronized' %}success{% elif booking.invoice_status == 'paid' %}info{% else %}secondary{% endif %} ml-2">
                                {{ booking.invoice_status|title if booking.invoice_status else 'Not Set' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Actions -->
            <div class="workflow-actions">
                <!-- Step 1: Make as Paid + Auto Sync (from quoted) -->
                {% if booking.status == 'quoted' %}
                <div class="workflow-step active">
                    <h6 class="text-primary">
                        <i class="fas fa-rocket"></i> Step 1: Mark as Paid + Auto Sync to Invoice
                    </h6>
                    <p class="text-muted">Mark this booking as paid and automatically synchronize all data to invoice
                        system.</p>

                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Auto Sync Feature:</strong> Payment confirmation will automatically sync complete
                        booking data to invoice system.
                    </div>

                    <form class="workflow-form" data-action="make-paid" data-booking-id="{{ booking.id }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Payment Method</label>
                                    <select name="payment_method" class="form-control">
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="credit_card">Credit Card</option>
                                        <option value="cash">Cash</option>
                                        <option value="online_payment">Online Payment</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Payment Amount (THB)</label>
                                    <input type="number" name="payment_amount" class="form-control"
                                        value="{{ booking.total_amount or '' }}" step="0.01">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Payment Reference</label>
                                    <input type="text" name="payment_reference" class="form-control"
                                        placeholder="Transaction ID, Check number, etc.">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Invoice Number</label>
                                    <input type="text" name="invoice_number" class="form-control"
                                        value="{{ booking.invoice_number or 'INV-' + booking.booking_reference }}"
                                        placeholder="Invoice number">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Payment Notes</label>
                            <textarea name="payment_notes" class="form-control" rows="2"
                                placeholder="Additional payment information..."></textarea>
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="auto_sync_{{ booking.id }}"
                                    name="auto_sync" checked>
                                <label class="custom-control-label" for="auto_sync_{{ booking.id }}">
                                    <strong>Auto Sync to Invoice System</strong> (Recommended)
                                </label>
                            </div>
                            <small class="text-muted">Automatically synchronize complete booking data to invoice
                                system</small>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-rocket"></i> Mark as Paid + Auto Sync
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- Step 2: Mark as Vouchered (from paid + synced) -->
                {% if booking.status == 'paid' and booking.invoice_status == 'synchronized' %}
                <div class="workflow-step active">
                    <h6 class="text-primary">
                        <i class="fas fa-ticket-alt"></i> Step 2: Mark as Vouchered
                    </h6>
                    <p class="text-muted">Generate voucher and complete the booking workflow.</p>

                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle"></i>
                        <strong>Ready for Vouchering:</strong> Payment confirmed and data synchronized to invoice
                        system.
                    </div>

                    <form class="workflow-form" data-action="mark-vouchered" data-booking-id="{{ booking.id }}">
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input"
                                    id="generate_voucher_pdf_{{ booking.id }}" name="generate_voucher_pdf" checked>
                                <label class="custom-control-label" for="generate_voucher_pdf_{{ booking.id }}">
                                    Generate Voucher PDF
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input"
                                    id="send_confirmation_email_{{ booking.id }}" name="send_confirmation_email">
                                <label class="custom-control-label" for="send_confirmation_email_{{ booking.id }}">
                                    Send Confirmation Email
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Voucher Notes</label>
                            <textarea name="voucher_notes" class="form-control" rows="2"
                                placeholder="Final notes for voucher..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-flag-checkered"></i> Mark as Vouchered
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- Manual Sync (if auto sync failed) -->
                {% if booking.status == 'paid' and booking.invoice_status != 'synchronized' %}
                <div class="workflow-step active">
                    <h6 class="text-warning">
                        <i class="fas fa-exclamation-triangle"></i> Manual Sync Required
                    </h6>
                    <p class="text-muted">Auto sync failed. Please manually synchronize to invoice system.</p>

                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Auto Sync Failed:</strong> Manual synchronization is required before vouchering.
                    </div>

                    <form class="workflow-form" data-action="sync-invoice" data-booking-id="{{ booking.id }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Invoice Number</label>
                                    <input type="text" name="invoice_number" class="form-control"
                                        value="{{ booking.invoice_number }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Invoice Due Date</label>
                                    <input type="date" name="invoice_due_date" class="form-control">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-sync"></i> Manual Sync to Invoice
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- Workflow Completed -->
                {% if booking.status == 'vouchered' %}
                <div class="workflow-step completed">
                    <h6 class="text-success">
                        <i class="fas fa-check-circle"></i> Workflow Completed!
                    </h6>
                    <p class="text-success">This booking has completed the full workflow process.</p>

                    <div class="completion-info">
                        <div class="row">
                            {% if booking.vouchered_at %}
                            <div class="col-md-6">
                                <small class="text-muted">Completed on:</small><br>
                                <strong>{{ booking.vouchered_at.strftime('%Y-%m-%d %H:%M') }}</strong>
                            </div>
                            {% endif %}
                            <div class="col-md-6">
                                <small class="text-muted">Invoice Number:</small><br>
                                <strong>{{ booking.invoice_number or 'N/A' }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Workflow JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle workflow form submissions
        document.querySelectorAll('.workflow-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const action = this.dataset.action;
                const bookingId = this.dataset.bookingId;
                const formData = new FormData(this);

                // Convert form data to object
                const data = {};
                formData.forEach((value, key) => {
                    if (key.endsWith('[]')) {
                        // Handle array fields
                        const arrayKey = key.slice(0, -2);
                        if (!data[arrayKey]) data[arrayKey] = [];
                        data[arrayKey].push(value);
                    } else if (this.querySelector(`[name="${key}"][type="checkbox"]`)) {
                        // Handle checkbox fields
                        data[key] = this.querySelector(`[name="${key}"]:checked`) ? true : false;
                    } else {
                        data[key] = value;
                    }
                });

                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitBtn.disabled = true;

                // Determine URL based on action
                let url;
                switch (action) {
                    case 'make-paid':
                        url = `/booking/${bookingId}/workflow-make-paid`;
                        break;
                    case 'sync-invoice':
                        url = `/booking/${bookingId}/workflow-sync-invoice`;
                        break;
                    case 'mark-vouchered':
                        url = `/booking/${bookingId}/workflow-mark-vouchered`;
                        break;
                    default:
                        console.error('Unknown workflow action:', action);
                        return;
                }

                // Submit to enhanced workflow endpoint
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value || ''
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Show success message
                            showAlert('success', result.message);

                            // Reload page to show next step
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showAlert('error', result.message);
                        }
                    })
                    .catch(error => {
                        console.error('Workflow error:', error);
                        showAlert('error', 'An error occurred during workflow processing.');
                    })
                    .finally(() => {
                        // Restore button state
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            });
        });

        function showAlert(type, message) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;

            // Insert at top of workflow container
            const container = document.querySelector('.enhanced-workflow-container');
            container.insertBefore(alertDiv, container.firstChild);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    });
</script>

<!-- Enhanced Workflow CSS -->
<style>
    .enhanced-workflow-container {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .workflow-progress .progress {
        background-color: #e9ecef;
        border-radius: 4px;
    }

    .workflow-step {
        padding: 20px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
    }

    .workflow-step.active {
        border-color: #007bff;
        background-color: #fff;
    }

    .workflow-step.completed {
        border-color: #28a745;
        background-color: #d4edda;
    }

    .workflow-step h6 {
        margin-bottom: 10px;
        font-weight: 600;
    }

    .status-item {
        margin-bottom: 10px;
    }

    .status-item label {
        margin-bottom: 0;
        margin-right: 8px;
    }

    .completion-info {
        background-color: rgba(40, 167, 69, 0.1);
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
    }

    .workflow-form .form-group:last-child {
        margin-bottom: 0;
    }

    .workflow-form button[type="submit"] {
        min-width: 150px;
    }
</style>