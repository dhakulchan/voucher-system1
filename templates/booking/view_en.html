{% extends "base.html" %}

{% block title %}Booking Details{% endblock %}

{% block extra_head %}
<!-- Cache buster for JavaScript updates -->
<meta name="js-version" content="v2.1.{{ range(1000, 9999) | random }}">
<style>
    /* Products & Calculation Table Styling */
    .products-calculation-table {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    .products-calculation-table th {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        border: none;
        padding: 12px 8px;
    }

    .products-calculation-table td {
        padding: 12px 8px;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }

    .products-calculation-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.001);
        transition: all 0.2s ease;
    }

    .products-calculation-table .product-name {
        font-weight: 600;
        color: #2c3e50;
    }

    .products-calculation-table .quantity-badge {
        background: linear-gradient(45deg, #3498db, #5dade2);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .products-calculation-table .price-positive {
        color: #27ae60;
        font-weight: 600;
    }

    .products-calculation-table .price-negative {
        color: #e74c3c;
        font-weight: 600;
    }

    .products-calculation-table .amount-positive {
        color: #27ae60;
        font-weight: 700;
        font-size: 1.05rem;
    }

    .products-calculation-table .amount-negative {
        color: #e74c3c;
        font-weight: 700;
        font-size: 1.05rem;
    }

    .products-calculation-table tfoot {
        background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
    }

    .products-calculation-table tfoot td {
        font-weight: 700;
        font-size: 1.1rem;
        color: #2c3e50;
        border: none;
        padding: 15px 8px;
    }

    .total-badge {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
    }

    .products-section-header {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-weight: 600;
    }

    /* Admin Notes & Manager Memos Tabs Styling */
    #adminTabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-weight: 500;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }

    #adminTabs .nav-link:hover {
        border-color: #dee2e6;
        background-color: #f8f9fa;
        color: #495057;
    }

    #adminTabs .nav-link.active {
        color: #495057;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        border-bottom-color: transparent;
        font-weight: 600;
    }

    #adminTabs .nav-link.active[aria-controls="admin-notes-panel"] {
        border-bottom-color: #dc3545;
    }

    #adminTabs .nav-link.active[aria-controls="manager-memos-panel"] {
        border-bottom-color: #0dcaf0;
    }

    .admin-content-border {
        border-left: 4px solid #dc3545;
        padding-left: 1rem;
    }

    .manager-content-border {
        border-left: 4px solid #0dcaf0;
        padding-left: 1rem;
    }

    /* Payment Card Enhancements */
    .payment-card {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .payment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .payment-card-header {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        border: none;
        padding: 15px 20px;
    }

    .grand-total-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        border-left: 4px solid #27ae60;
    }

    /* Quote/Invoice External Link Styling */
    .quote-number-link,
    .invoice-number-link {
        transition: all 0.3s ease;
        text-decoration: none !important;
        position: relative;
    }

    .quote-number-link:hover,
    .invoice-number-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        opacity: 0.9;
    }

    .quote-number-link .fas.fa-external-link-alt,
    .invoice-number-link .fas.fa-external-link-alt {
        font-size: 0.8em;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .quote-number-link:hover .fas.fa-external-link-alt,
    .invoice-number-link:hover .fas.fa-external-link-alt {
        opacity: 1;
        color: #0d6efd;
    }

    /* Action Buttons Styling */
    .btn-outline-primary:hover,
    .btn-outline-info:hover,
    .btn-outline-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* External Link Indicator */
    .external-link-badge {
        position: relative;
    }

    .external-link-badge::after {
        content: '\f35d';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: -2px;
        right: -2px;
        font-size: 0.6em;
        color: #28a745;
        opacity: 0.8;
    }

    /* Status badges with better contrast */
    .badge.bg-success {
        background-color: #198754 !important;
    }

    .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #000 !important;
    }

    .badge.bg-info {
        background-color: #0dcaf0 !important;
        color: #000 !important;
    }

    .badge.bg-secondary {
        background-color: #6c757d !important;
    }

    /* Action buttons section styling */
    .action-buttons-section h6 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #6c757d;
    }

    .action-buttons-section .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        margin-bottom: 0.25rem;
    }

    /* Multi-Platform Share Modal Styles */
    .share-platform-btn {
        aspect-ratio: 1;
        border-radius: 10px;
        transition: all 0.3s ease;
        font-size: 0.85rem;
        border: none;
    }

    .share-platform-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .share-platform-btn i {
        transition: all 0.3s ease;
    }

    .share-platform-btn:hover i {
        transform: scale(1.1);
    }

    #shareModal .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    #shareModal .modal-header {
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        border-bottom: none;
    }

    #shareModal .modal-footer {
        border-top: 1px solid #dee2e6;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
    }

    /* Enhanced Share Button Styles */
    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #218838, #1ea080);
        transform: translateY(-1px);
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff, #6610f2);
        border: none;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3, #520dc2);
        transform: translateY(-1px);
    }

    .btn-info {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
        border: none;
    }

    .btn-info:hover {
        background: linear-gradient(135deg, #138496, #59359a);
        transform: translateY(-1px);
    }

    .btn-dark {
        background: linear-gradient(135deg, #343a40, #495057);
        border: none;
    }

    .btn-dark:hover {
        background: linear-gradient(135deg, #23272b, #3d4142);
        transform: translateY(-1px);
    }

    /* Admin & Management Section Styling */
    .admin-management-card {
        transition: all 0.3s ease;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .admin-management-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .admin-notes-section {
        position: relative;
        overflow: hidden;
    }

    .admin-notes-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, #dc3545, #e74c3c);
    }

    .manager-memos-section {
        position: relative;
        overflow: hidden;
    }

    .manager-memos-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, #17a2b8, #20c997);
    }

    .admin-icon-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    .admin-icon-circle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .admin-content-box {
        transition: all 0.2s ease;
        border: 1px solid #e9ecef;
    }

    .admin-content-box:hover {
        border-color: #dee2e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .operation-notes-card {
        transition: all 0.3s ease;
    }

    .operation-notes-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    }

    .operation-placeholder {
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
        opacity: 0.7;
    }

    /* Activity Logs Styles */
    .activity-logs-container {
        max-height: none;
    }

    .activity-log-item {
        transition: background-color 0.2s ease;
    }

    .activity-log-item:hover {
        background-color: #f8f9fa;
        border-radius: 6px;
        margin: -4px;
        padding: 8px 4px !important;
    }

    .activity-icon {
        width: 24px;
        font-size: 1.1rem;
    }

    .activity-action {
        font-size: 0.95rem;
        color: #2c3e50;
    }

    .activity-description {
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .activity-time {
        font-size: 0.8rem;
    }

    .text-purple {
        color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Booking Data for JavaScript -->
<div id="booking-data" style="display: none;" data-booking-id="{{ booking.id|default(0) }}"
    data-booking-reference="{{ booking.booking_reference|default('') }}"
    data-booking-status="{{ booking.status|default('pending')|lower }}">
</div>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Booking Details View-en
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('booking.list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Bookings
            </a>
            {% if booking.status in ['confirmed','completed'] %}
            <!-- Show Open Voucher button if invoice exists and booking is confirmed (paid) -->
            {% if booking.invoice_number and booking.status == 'confirmed' %}
            <a href="{{ url_for('voucher.view', id=booking.id) }}" class="btn btn-primary">
                <i class="fas fa-ticket-alt me-2"></i>Open Voucher
            </a>
            {% elif booking.invoice_number %}
            <span class="text-muted small">Voucher available after invoice is paid</span>
            {% else %}
            <span class="text-muted small">Voucher available after invoice is created and paid</span>
            {% endif %}
            {% elif booking.status not in ['draft', 'pending', 'confirmed', 'quoted', 'cancelled'] %}
            <a href="{{ url_for('voucher.view', id=booking.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-ticket-alt me-2"></i>Generate Voucher
            </a>
            {% endif %}
            <a href="{{ url_for('booking.edit', id=booking.id) }}" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>View/Edit Booking
            </a>

            {% if booking.status != 'cancelled' %}
            <!-- Cancel Booking Button -->
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelBookingModal">
                <i class="fas fa-times me-2"></i>Cancel Booking
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Enhanced Workflow Progress Component -->
    {% include 'booking/workflow_progress.html' %}

    <!-- Enhanced Booking Actions Section with Status-Based Document Generation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        {% if booking.status in ['pending', 'confirmed'] %}
                        <i class="fas fa-file-alt me-2"></i>ðŸ“‹ Service Proposal
                        {% elif booking.status == 'quoted' %}
                        <i class="fas fa-calculator me-2"></i>ðŸ’° Quote PDF/PNG
                        {% elif booking.status == 'paid' %}
                        <i class="fas fa-receipt me-2"></i>ðŸ§¾ Quote / Provisional Receipt
                        {% elif booking.status in ['vouchered', 'completed'] %}
                        <i class="fas fa-ticket-alt me-2"></i>ðŸŽ« Tour Voucher PDF/PNG
                        {% else %}
                        <i class="fas fa-file-alt me-2"></i>ðŸ“‹ Service Proposal
                        {% endif %}
                    </h5>
                    <small class="text-light">
                        {% if booking.status in ['pending', 'confirmed', 'paid'] %}
                        ClassicPDFGenerator â€¢ Public PDF Route
                        {% elif booking.status == 'quoted' %}
                        Jinja2(3.1.4) + WeasyPrint(62.3) â€¢ quote_template_final_v2.html
                        {% elif booking.status in ['vouchered', 'completed'] %}
                        Jinja2(3.1.4) + WeasyPrint(62.3) â€¢ tour_voucher_template_v2_sample.html
                        {% else %}
                        ClassicPDFGenerator â€¢ Public PDF Route
                        {% endif %}
                    </small>
                </div>
                <div class="card-body">
                    <!-- Backend User Actions -->
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="fas fa-user-shield me-2"></i>Backend User Actions:
                        </h6>
                        <div class="btn-group mb-3" role="group">
                            {% if booking.status == 'quoted' %}
                            <a href="{{ url_for('booking.generate_quote_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-primary" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF
                            </a>
                            <a href="{{ url_for('booking.generate_quote_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-info" target="_blank">
                                <i class="fas fa-image me-2"></i>Download PNG
                            </a>
                            {% elif booking.status == 'paid' %}
                            <a href="{{ url_for('booking.generate_quote_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-primary" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF
                            </a>
                            <a href="{{ url_for('booking.generate_quote_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-info" target="_blank">
                                <i class="fas fa-image me-2"></i>Download PNG
                            </a>
                            {% elif booking.status in ['vouchered', 'completed'] %}
                            <a href="{{ url_for('voucher.generate_pdf', id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-primary" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF
                            </a>
                            <a href="{{ url_for('voucher.voucher_png_combined', id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-info" target="_blank">
                                <i class="fas fa-image me-2"></i>Download PNG
                            </a>
                            {% else %}
                            <a href="{{ url_for('booking.generate_booking_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-primary" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF
                            </a>
                            <a href="{{ url_for('booking.generate_service_proposal_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-info" target="_blank">
                                <i class="fas fa-image me-2"></i>Download PNG
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Public Sharing Actions -->
                    <div class="mb-4">
                        <h6 class="text-success">
                            <i class="fas fa-share-alt me-2"></i>Public Sharing (Token: departure_date + 120 days):
                        </h6>

                        <!-- Token Management -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-warning btn-sm"
                                        onclick="resetShareToken(getCurrentBookingId())">
                                        <i class="fas fa-redo me-1"></i>Reset Token
                                    </button>
                                    <button class="btn btn-secondary btn-sm"
                                        onclick="lockShareToken(getCurrentBookingId())">
                                        <i class="fas fa-lock me-1"></i>Lock Token
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>Expires: departure_date + 120 days
                                </small>
                            </div>
                        </div>

                        <!-- Sharing Buttons -->
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="sendToLineOA(getCurrentBookingId())">
                                        <i class="fab fa-line me-2" style="color: white;"></i>Send to Line OA
                                    </button>
                                    <button class="btn btn-primary"
                                        onclick="copyEnhancedMessage(getCurrentBookingId())">
                                        <i class="fas fa-copy me-2"></i>Copy Message
                                    </button>
                                    <button class="btn btn-info" onclick="openPublicSharePage(getCurrentBookingId())">
                                        <i class="fas fa-external-link-alt me-2"></i>Open Public Share Page
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-dark" onclick="emailLinkMessage(getCurrentBookingId())">
                                        <i class="fas fa-envelope me-2"></i>Email Link-Message
                                    </button>
                                    <button class="btn btn-secondary"
                                        onclick="shareToSocialMedia(getCurrentBookingId())">
                                        <i class="fas fa-share-nodes me-2"></i>Share Public Page-App
                                    </button>
                                    <button class="btn btn-outline-primary"
                                        onclick="getShareStatus(getCurrentBookingId())">
                                        <i class="fas fa-info-circle me-2"></i>Share Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Email Actions -->
                    <div>
                        <h6 class="text-muted">
                            <i class="fas fa-envelope me-2"></i>Direct Email Actions:
                        </h6>
                        <div class="btn-group" role="group">
                            {% if booking.status == 'quoted' %}
                            <a href="{{ url_for('booking.email_quote_pdf', booking_id=booking.id) }}"
                                class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-envelope me-2"></i>Email Quote PDF
                            </a>
                            {% else %}
                            <a href="{{ url_for('booking.email_booking_pdf', booking_id=booking.id) }}"
                                class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-envelope me-2"></i>Email Booking PDF
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Booking Status Alert -->
        <div class="col-12">
            <!-- Social Media Actions -->
            <div class="mb-3">
                <button class="btn btn-outline-primary me-2"
                    onclick="try { shareToSocialMedia(getCurrentBookingId(), 'quote'); } catch(e) { console.error('shareToSocialMedia error:', e); }">
                    <i class="fas fa-share-alt me-2"></i>Social Media
                </button>
                <button class="btn btn-outline-secondary"
                    onclick="try { openSharePage(getCurrentBookingId(), 'quote'); } catch(e) { console.error('openSharePage error:', e); }">
                    <i class="fas fa-external-link-alt me-2"></i>Open Share Page
                </button>
            </div>
        </div>
        {% if booking.status not in ['quoted', 'paid', 'vouchered', 'draft', 'cancelled'] %}
        <!-- Booking PDF/PNG Buttons for Non-Quoted Status (excluding draft and cancelled) -->
        <a href="{{ url_for('booking.generate_booking_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
            class="btn btn-info" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Booking PDF
        </a>

        <!-- Email Booking PDF Button -->
        <a href="{{ url_for('booking.email_booking_pdf', booking_id=booking.id) }}" class="btn btn-outline-info">
            <i class="fas fa-envelope me-2"></i>Email Booking PDF
        </a>
        <!-- Booking PNG with Share Options -->
        <div class="btn-group" role="group">
            <a href="{{ url_for('booking.generate_booking_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                class="btn btn-secondary" target="_blank">
                <i class="fas fa-image me-2"></i>Booking PNG
            </a>
            <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { shareToLineOA(getCurrentBookingId()); } catch(e) { console.error('shareToLineOA error:', e); }">
                        <i class="fab fa-line me-2" style="color: #00B900;"></i>Send to Line OA
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { copyLineMessage(getCurrentBookingId()); } catch(e) { console.error('copyLineMessage error:', e); }">
                        <i class="fas fa-copy me-2"></i>Copy Line Message
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { sharePublic(getCurrentBookingId(), event); } catch(e) { console.error('sharePublic error:', e); }">
                        <i class="fas fa-share-alt me-2"></i>Share Public Link
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Booking Status Alert -->
<div class="row mb-4">
    <div class="col-12">
        {% if booking.status == 'pending' %}
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-clock me-2"></i>
            <strong>Status: Pending</strong> - This booking is awaiting confirmation
        </div>
        {% elif booking.status == 'confirmed' %}
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Status: Confirmed</strong> - This booking has been confirmed
        </div>
        {% elif booking.status == 'completed' %}
        <div class="alert alert-info" role="alert">
            <i class="fas fa-flag-checkered me-2"></i>
            <strong>Status: Completed</strong> - The tour has been completed
        </div>
        {% elif booking.status == 'cancelled' %}
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-times-circle me-2"></i>
            <strong>Status: Cancelled</strong> - This booking has been cancelled
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Customer Information -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>Customer Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Name:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.customer.name }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Email:</strong>
                    </div>
                    <div class="col-sm-8">
                        <a href="mailto:{{ booking.customer.email }}" class="text-decoration-none">
                            {{ booking.customer.email }}
                        </a>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Phone:</strong>
                    </div>
                    <div class="col-sm-8">
                        <a href="tel:{{ booking.customer.phone }}" class="text-decoration-none">
                            {{ booking.customer.phone }}
                        </a>
                    </div>
                </div>
                {% if booking.customer.nationality %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Nationality:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.customer.nationality }}
                    </div>
                </div>
                {% endif %}
                {% if booking.customer.address %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Address:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.customer.address }}
                    </div>
                </div>
                {% endif %}
                {% if booking.customer.notes %}
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Notes:</strong>
                    </div>
                    <div class="col-sm-8">
                        <small class="text-muted">{{ booking.customer.notes|replace('\n', '<br>')|replace('</p>', '
                            </p><br>')|safe }}</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Booking Information -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-check me-2"></i>Booking Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Reference:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-primary">{{ booking.booking_reference }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Type:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-secondary text-capitalize">{{ booking.booking_type }}</span>
                    </div>
                </div>
                {% if booking.arrival_date %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Traveling from:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.arrival_date.strftime('%d/%m/%Y') }}
                    </div>
                </div>
                {% endif %}
                {% if booking.departure_date %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Traveling to:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.departure_date.strftime('%d/%m/%Y') }}
                    </div>
                </div>
                {% endif %}

                <!-- Time Management -->
                {% if booking.time_limit %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong><i class="fas fa-clock me-1 text-warning"></i>Time Limit:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-warning text-dark">
                            {{ booking.time_limit.strftime('%d/%m/%Y %H:%M') }}
                        </span>
                        <small class="text-muted d-block">Booking confirmation deadline</small>
                    </div>
                </div>
                {% endif %}
                {% if booking.due_date %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong><i class="fas fa-calendar-check me-1 text-info"></i>Due Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-info">
                            {{ booking.due_date.strftime('%d/%m/%Y') }}
                        </span>
                        <small class="text-muted d-block">Payment or action due date</small>
                    </div>
                </div>
                {% endif %}

                <!-- Party Code -->
                {% if booking.party_code %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Party Code:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-info">{{ booking.party_code }}</span>
                    </div>
                </div>
                {% endif %}
                <!-- Passenger Details -->
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Passengers:</strong>
                    </div>
                    <div class="col-sm-8">
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-primary">Adults: {{ booking.adults or 0 }}</span>
                            <span class="badge bg-info">Children: {{ booking.children or 0 }}</span>
                            <span class="badge bg-warning text-dark">Infants (Under 2Y.): {{ booking.infants or 0
                                }}</span>
                        </div>
                        <div class="mt-2">
                            <strong>Total:</strong> <span class="badge bg-dark">{{ (booking.adults or 0) +
                                (booking.children or 0) + (booking.infants or 0) }}</span> persons
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <strong>Booked:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Admin & Management Section -->
    <div class="col-lg-6 mb-4">
        <div class="card admin-management-card shadow-sm border-0">
            <div class="card-header"
                style="background: linear-gradient(135deg, #fff3cd 0%, #fef9e7 100%); border-bottom: 1px solid #faebcc;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0" style="color: #856404;">
                            <i class="fas fa-shield-alt me-2 text-warning"></i>Admin & Management
                        </h5>
                        <small class="text-muted">
                            <i class="fas fa-lock me-1"></i>Internal Use Only
                        </small>
                    </div>
                    <button class="btn btn-outline-warning btn-sm" type="button" data-bs-toggle="collapse"
                        data-bs-target="#adminManagementContent" aria-expanded="false"
                        aria-controls="adminManagementContent">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="collapse" id="adminManagementContent">
                    <!-- Admin Notes -->
                    <div class="admin-notes-section p-4 border-bottom" style="background-color: #fefefe;">
                        <div class="d-flex align-items-start mb-3">
                            <div class="admin-icon-circle bg-danger rounded-circle p-2 me-3 shadow-sm">
                                <i class="fas fa-user-shield text-white"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="text-danger mb-1 fw-bold">Admin Notes</h6>
                                <small class="text-muted">Critical administrative information</small>
                            </div>
                        </div>
                        <div class="admin-content-box border rounded p-3 bg-white shadow-sm" style="min-height: 80px;">
                            {% if booking.admin_notes %}
                            <div class="text-dark">{{ booking.admin_notes|safe }}</div>
                            {% else %}
                            <div class="text-muted d-flex align-items-center justify-content-center h-100">
                                <i class="fas fa-info-circle me-2"></i>None
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Manager Memos -->
                    <div class="manager-memos-section p-4" style="background-color: #fefefe;">
                        <div class="d-flex align-items-start mb-3">
                            <div class="admin-icon-circle bg-info rounded-circle p-2 me-3 shadow-sm">
                                <i class="fas fa-clipboard-list text-white"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="text-info mb-1 fw-bold">Manager Memos</h6>
                                <small class="text-muted">Management instructions and notes</small>
                            </div>
                        </div>
                        <div class="admin-content-box border rounded p-3 bg-white shadow-sm" style="min-height: 80px;">
                            {% if booking.manager_memos %}
                            <div class="text-dark">{{ booking.manager_memos|safe }}</div>
                            {% else %}
                            <div class="text-muted d-flex align-items-center justify-content-center h-100">
                                <i class="fas fa-info-circle me-2"></i>None
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Operation Notes -->
    <div class="col-lg-6 mb-4">
        <div class="card operation-notes-card shadow-sm border-0">
            <div class="card-header" style="background: linear-gradient(135deg, #495057 0%, #6c757d 100%);">
                <h5 class="card-title mb-0 text-white">
                    <i class="fas fa-clipboard me-2"></i>Operation Notes
                </h5>
                <small class="text-light opacity-75">
                    <i class="fas fa-users me-1"></i>Staff only - operational details and reminders
                </small>
            </div>
            <div class="card-body">
                <div class="border rounded p-3 shadow-sm" style="background-color: #f8f9fa; min-height: 120px;">
                    {% if booking.internal_note %}
                    <div class="text-dark">{{ booking.internal_note|replace('\n', '<br>')|replace('</p>', '</p>
                        <br>')|safe }}
                    </div>
                    {% else %}
                    <div class="text-muted d-flex align-items-center justify-content-center h-100">
                        <div class="text-center operation-placeholder">
                            <i class="fas fa-clipboard-check mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
                            <div>Internal</div>
                            <div>OPPPPPPPPPPPPPP</div>
                            <div>P</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div> <!-- Guest Names Section -->
{% if booking.guest_list %}
{% if booking.pickup_point or booking.pickup_time %}
<div class="row mb-3">
    {% if booking.pickup_point %}
    <div class="col-sm-6">
        <div class="row">
            <div class="col-sm-4">
                <strong>Pickup Point:</strong>
            </div>
            <div class="col-sm-8">
                <span class="badge bg-success">{{ booking.pickup_point }}</span>
            </div>
        </div>
    </div>
    {% endif %}
    {% if booking.pickup_time %}
    <div class="col-sm-6">
        <div class="row">
            <div class="col-sm-4">
                <strong>Pickup Time:</strong>
            </div>
            <div class="col-sm-8">
                <span class="badge bg-success">{{ booking.pickup_time }}</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
{% endif %}

<!-- Additional Information -->
<div class="row mb-4">
    {% if booking.description %}
    <div class="col-12 mb-3">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>Service Detail / Itinerary
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ booking.description|replace('\n', '<br>')|replace('</p>', '</p><br>')|safe }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Name List / Rooming List (moved here after Description) -->
    {% if booking.guest_list %}
    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Name List / Rooming List
                </h5>
            </div>
            <div class="card-body">
                {% set clean_flight_info = booking.flight_info|replace('\n', '<br>')|replace('</p>', '</p>
                <br>')|safe %} {% set guest_text = booking.get_guest_list_for_edit() %}
                {% if guest_text.startswith('[') and guest_text.endswith(']') %}
                {# Handle JSON format - remove brackets and quotes #}
                {% set clean_text = guest_text.strip('[]"') %}
                <div class="mb-0">{{ clean_text|replace('\n', '<br>')|safe }}</div>
                {% else %}
                {# Normal text format #}
                <div class="mb-0">{{ guest_text|replace('\n', '<br>')|safe }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Flight Information and Internal Note -->
    <div class="row mb-4">
        {% if booking.flight_info and booking.flight_info.strip() %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plane me-2"></i>Flight Information
                    </h5>
                </div>
                <div class="card-body">
                    {% set clean_flight_info = booking.flight_info|replace('\n', '<br>')|safe %}
                    {% if clean_flight_info and clean_flight_info != '<p></p>' %}
                    <p class="mb-0">{{ clean_flight_info }}</p>
                    {% else %}
                    <p class="mb-0 text-muted">No flight information available</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Special Requests -->
    {% if booking.special_request %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note me-2"></i>Special Requests
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ booking.special_request|replace('\n', '<br>')|safe }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}



    <!-- Payment Information -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card payment-card">
                <div class="card-header payment-card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-money-bill me-2"></i>Payment Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Products & Calculation Section -->
                    {% if booking.get_products() %}
                    <div class="mb-4">
                        <h6 class="products-section-header">
                            <i class="fas fa-calculator me-2"></i>Products & Calculation
                        </h6>
                        <div class="table-responsive">
                            <table class="table products-calculation-table">
                                <thead>
                                    <tr>
                                        <th class="text-center">No.</th>
                                        <th>Products</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in booking.get_products() %}
                                    <tr>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">{{ loop.index }}</span>
                                        </td>
                                        <td>
                                            <span class="product-name">{{ product.name if product.name is defined else
                                                product['name'] }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="quantity-badge">{{ product.quantity if product.quantity is
                                                defined else product.get('quantity', 1) }}</span>
                                        </td>
                                        <td class="text-end">
                                            {% set price = product.price if product.price is defined else
                                            product.get('price', 0) %}
                                            {% if price < 0 %} <span class="price-negative">-{{
                                                "{:,.2f}".format(price * -1) }}</span>
                                                {% else %}
                                                <span class="price-positive">{{ "{:,.2f}".format(price)
                                                    }}</span>
                                                {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% set amount = product.amount if product.amount is defined else
                                            product.get('price', 0) %}
                                            {% if amount < 0 %} <span class="amount-negative">-{{
                                                "{:,.2f}".format(amount * -1) }}</span>
                                                {% else %}
                                                <span class="amount-positive">{{ "{:,.2f}".format(amount)
                                                    }}</span>
                                                {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end">
                                            <i class="fas fa-calculator me-2"></i>Total:
                                        </td>
                                        <td class="text-end">
                                            <span class="total-badge">
                                                {{ "{:,.2f}".format(booking.total_amount|float if booking.total_amount
                                                else
                                                0) }} {{ booking.currency or
                                                'THB' }}
                                            </span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Grand Total Summary -->
                    <div class="grand-total-section">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <h6 class="mb-0">
                                    <i class="fas fa-coins me-2 text-success"></i>
                                    <strong>Grand Total:</strong>
                                </h6>
                            </div>
                            <div class="col-6 text-end">
                                <span class="total-badge">
                                    {{ booking.currency or 'THB' }} {{ "{:,.2f}".format(booking.total_amount|float if
                                    booking.total_amount else 0) }}
                                </span>
                            </div>
                        </div>

                        {% if booking.get_products() %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Product breakdown shows {{ booking.get_products()|length }} item(s) with detailed
                                    pricing
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>Actions & Documents
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Actions Section -->
                    <div class="mb-4">
                        <h6 class="text-info mb-3">
                            <i class="fas fa-cogs me-2"></i>Quick Actions
                        </h6>
                        <div class="d-flex align-items-center justify-content-center">
                            {% if booking.status in ['quoted', 'paid', 'vouchered'] and booking.quotes %}
                            <!-- Show View Quote button only for quoted, paid, or vouchered status -->
                            <a href="{{ url_for('booking.generate_quote_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
                                class="btn btn-outline-info">
                                <i class="fas fa-eye me-2"></i>View Quote
                            </a>
                            {% elif booking.status in ['pending', 'confirmed'] %}
                            <!-- For pending and confirmed status, show no buttons - clean interface -->
                            <div class="text-muted small text-center">
                                {% if booking.status == 'pending' %}
                                <i class="fas fa-hourglass-half me-2"></i>Pending booking confirmation
                                {% else %}
                                <i class="fas fa-check-circle me-2"></i>Booking confirmed - awaiting next step
                                {% endif %}
                            </div>
                            {% elif booking.status == 'draft' %}
                            <!-- For draft status, show info message -->
                            <div class="text-muted small">
                                <i class="fas fa-edit me-2"></i>Complete booking details first
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quote & Invoice Information -->
                    <div class="border-top pt-3">
                        <h6 class="text-secondary mb-3">
                            <i class="fas fa-file-invoice me-2"></i>Document Numbers
                        </h6>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center small">
                                    <strong class="text-muted">Quote Number:</strong>
                                    <div>
                                        <!-- Show quote number only for appropriate statuses -->
                                        {% if booking.status in ['quoted', 'paid', 'vouchered'] and booking.quotes %}
                                        {% set latest_quote = booking.quotes[-1] %}
                                        {% if latest_quote.share_token and latest_quote.is_public %}
                                        <!-- Use public route with direct URL -->
                                        <a href="/quote/public/{{ latest_quote.share_token }}"
                                            class="badge bg-success text-decoration-none"
                                            title="Click to view quote details">
                                            {{ latest_quote.quote_number }} <i class="fas fa-eye ms-1"></i>
                                        </a>
                                        {% else %}
                                        <!-- Show quote number but disable link (no login) -->
                                        <span class="badge bg-secondary" title="Login required to view quote details">
                                            {{ latest_quote.quote_number }} <i class="fas fa-lock ms-1"></i>
                                        </span>
                                        {% endif %}
                                        {% elif booking.status in ['pending', 'confirmed'] %}
                                        <!-- For pending/confirmed status, show appropriate message -->
                                        <span class="text-muted">
                                            {% if booking.status == 'pending' %}
                                            Pending confirmation
                                            {% else %}
                                            Ready for quote
                                            {% endif %}
                                        </span>
                                        {% if booking.quotes %}
                                        <!-- Debug: Show data inconsistency warning for admin -->
                                        <small class="text-warning d-block">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Data inconsistency: Has quotes but status is {{ booking.status }}
                                        </small>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center small">
                                    <strong class="text-muted">Bank Received:</strong>
                                    <div>
                                        {% if booking.bank_received %}
                                        <span class="text-dark">{{ booking.bank_received }}</span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center small">
                                    <strong class="text-muted">Received Date:</strong>
                                    <div>
                                        {% if booking.received_date %}
                                        <span class="text-dark">{{ booking.received_date.strftime('%d/%m/%Y') if
                                            booking.received_date.strftime else booking.received_date }}</span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center small">
                                    <strong class="text-muted">Received Amount:</strong>
                                    <div>
                                        {% if booking.received_amount %}
                                        <span class="text-dark">{{ "{:,.2f}".format(booking.received_amount|float) }}
                                            THB</span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center small">
                                    <strong class="text-muted">Product Type:</strong>
                                    <div>
                                        {% if booking.product_type %}
                                        <span class="text-dark">{{ booking.product_type }}</span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center small">
                                    <strong class="text-muted">Notes:</strong>
                                    <div>
                                        {% if booking.notes %}
                                        <span class="text-dark">{{ booking.notes }}</span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Ninja Integration Removed -->

    <!-- Status Change Actions -->
    {% if booking.status != 'cancelled' %}
    <div class="row">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Status Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        {% if booking.status == 'pending' %}
                        <form method="POST" action="{{ url_for('booking.update_status', id=booking.id) }}"
                            class="d-inline">
                            <input type="hidden" name="status" value="confirmed">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="fas fa-check me-2"></i>Confirm Booking
                            </button>
                        </form>
                        {% endif %}

                        {% if booking.status == 'quoted' %}
                        <form method="POST" action="{{ url_for('booking.mark_as_paid', booking_id=booking.id) }}"
                            class="d-inline">
                            <button type="submit" class="btn btn-success me-2"
                                onclick="return confirm('Are you sure you want to mark this booking as paid? This will auto-sync data to invoices.')">
                                <i class="fas fa-credit-card me-2"></i>Make as Paid
                            </button>
                        </form>
                        {% endif %}

                        {% if booking.status in ['paid', 'vouchered'] %}
                        <form method="POST" action="{{ url_for('booking.mark_as_completed', booking_id=booking.id) }}"
                            class="d-inline">
                            <button type="submit" class="btn btn-primary me-2"
                                onclick="return confirm('Are you sure you want to mark this booking as completed?')">
                                <i class="fas fa-flag-checkered me-2"></i>Mark as Completed
                            </button>
                        </form>
                        {% endif %}

                        {% if booking.status in ['pending', 'confirmed'] %}
                        <form method="POST" action="{{ url_for('booking.update_status', id=booking.id) }}"
                            class="d-inline">
                            <input type="hidden" name="status" value="cancelled">
                            <button type="submit" class="btn btn-danger me-2"
                                onclick="return confirm('Are you sure you want to cancel this booking?')">
                                <i class="fas fa-times me-2"></i>Cancel Booking
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Activity Logs Workflow Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Workflow Activity Logs
                    </h5>
                </div>
                <div class="card-body">
                    <div class="activity-logs-container">
                        {% if activity_logs and activity_logs|length > 0 %}
                        <p class="text-success mb-3">âœ… Found {{ activity_logs|length }} activity logs</p>
                        {% for log in activity_logs %}
                        <div class="activity-log-item d-flex align-items-start mb-3 pb-3 border-bottom"
                            style="border-color: #e9ecef !important;">
                            <div class="activity-icon me-3 mt-1">
                                {% if log.action in ['created', 'booking_created'] %}
                                <i class="fas fa-plus-circle text-success"></i>
                                {% elif log.action in ['updated', 'booking_updated', 'modified'] %}
                                <i class="fas fa-edit text-primary"></i>
                                {% elif log.action in ['status_changed', 'status_updated'] %}
                                <i class="fas fa-exchange-alt text-warning"></i>
                                {% elif log.action in ['payment_received', 'paid'] %}
                                <i class="fas fa-credit-card text-success"></i>
                                {% elif log.action in ['cancelled', 'deleted'] %}
                                <i class="fas fa-times-circle text-danger"></i>
                                {% elif log.action in ['quoted', 'quote_sent', 'quote_created'] %}
                                <i class="fas fa-file-invoice text-info"></i>
                                {% elif log.action in ['vouchered', 'voucher_generated'] %}
                                <i class="fas fa-ticket-alt text-purple"></i>
                                {% else %}
                                <i class="fas fa-info-circle text-secondary"></i>
                                {% endif %}
                            </div>
                            <div class="activity-content flex-grow-1">
                                <div class="activity-action fw-semibold text-dark mb-1">
                                    {{ log.action.replace('_', ' ').title() if log.action else 'No Action' }}
                                </div>
                                {% if log.description %}
                                <div class="activity-description text-muted small mb-1">
                                    {{ log.description }}
                                </div>
                                {% endif %}
                                <div class="activity-time small text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {% if log.created_at %}
                                    {{ log.created_at.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No activity logs available for this booking
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

</div>

<!-- Enhanced Booking JavaScript -->
<script src="{{ url_for('static', filename='js/enhanced-booking-safe.js') }}?v=20251015"></script>
<script>
    // Core function for generating enhanced messages and secure URLs
    async function generateEnhancedMessage(bookingId) {
        try {
            console.log('ðŸ”§ Generating enhanced message for booking:', bookingId);
            const response = await fetch(`/api/share/booking/${bookingId}/url`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'  // Include cookies for authentication
            });

            console.log('ðŸ“¡ Generate message response:', response.status, response.statusText);

            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Please login to access this feature');
                } else if (response.status === 404) {
                    throw new Error('Booking not found');
                } else {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
            }

            const data = await response.json();
            console.log('ðŸ“ Generated data:', data);

            if (data.success) {
                // à¸ªà¸£à¹‰à¸²à¸‡ message à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸° booking
                let message = '';
                const bookingStatus = '{{ booking.status }}';

                if (bookingStatus === 'completed') {
                    message = `à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°
à¸šà¸£à¸´à¸©à¸±à¸— à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯ à¸‚à¸­à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¹€à¸£à¸²à¸”à¸¹à¹à¸¥à¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸‚à¸­à¸‡à¸—à¹ˆà¸²à¸™ à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡ ${data.booking_reference}

ðŸŽ« Tour Voucher: ${data.secure_url}

ðŸ–¼ï¸ Download PNG: ${data.png_url || `${data.secure_url}/png`}

ðŸ“„ Download PDF: ${data.pdf_url || `${data.secure_url}/pdf`}

Thank you for letting us take care of you. Have a safe journey, and we hope to see you again!
à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¹€à¸£à¸²à¸”à¸¹à¹à¸¥à¸—à¹ˆà¸²à¸™ à¸‚à¸­à¹ƒà¸«à¹‰à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ à¹à¸¥à¸°à¸«à¸§à¸±à¸‡à¸§à¹ˆà¸²à¸ˆà¸°à¹„à¸”à¹‰à¸žà¸šà¸à¸±à¸™à¸­à¸µà¸!

à¸•à¸´à¸”à¸•à¹ˆà¸­à¸ªà¸­à¸šà¸–à¸²à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡:
ðŸ“ž Tel: BKK +662 2744216  ðŸ“ž Tel: HKG +852 23921155
ðŸ“§ Email: booking@dhakulchan.com
ðŸ“± Line OA: @dhakulchan | @changuru
ðŸ›ï¸ à¸£à¸¹à¹‰à¸ˆà¸±à¸à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯: https://www.dhakulchan.net/page/about-dhakulchan`;
                } else if (bookingStatus === 'vouchered') {
                    message = `à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°
à¸šà¸£à¸´à¸©à¸±à¸— à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯ à¹à¸ˆà¹‰à¸‡à¸ªà¹ˆà¸‡ Tour Voucher à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡ ${data.booking_reference}
à¸à¸£à¸¸à¸“à¸²à¸„à¸¥à¸´à¸à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸•à¸²à¸¡à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸„à¹ˆà¸°

ðŸŽ« Tour Voucher: ${data.secure_url}

ðŸ–¼ï¸ Download PNG: ${data.png_url || `${data.secure_url}/png`}

ðŸ“„ Download PDF: ${data.pdf_url || `${data.secure_url}/pdf`}

à¸•à¸´à¸”à¸•à¹ˆà¸­à¸ªà¸­à¸šà¸–à¸²à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡:
ðŸ“ž Tel: BKK +662 2744216  ðŸ“ž Tel: HKG +852 23921155
ðŸ“§ Email: booking@dhakulchan.com
ðŸ“± Line OA: @dhakulchan | @changuru
ðŸ›ï¸ à¸£à¸¹à¹‰à¸ˆà¸±à¸à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯: https://www.dhakulchan.net/page/about-dhakulchan`;
                } else {
                    // Default message for other statuses
                    message = `à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°
à¸šà¸£à¸´à¸©à¸±à¸— à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯ à¹à¸ˆà¹‰à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸šà¸£à¸´à¸à¸²à¸£à¸«à¸£à¸·à¸­à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸±à¸§à¸£à¹Œ à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡ ${data.booking_reference}
à¸à¸£à¸¸à¸“à¸²à¸„à¸¥à¸´à¸à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸•à¸²à¸¡à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸„à¹ˆà¸°

ðŸ“‹ Service Proposal: ${data.secure_url}

ðŸ–¼ï¸ Download PNG: ${data.png_url || `${data.secure_url}/png`}

ðŸ“„ Download PDF: ${data.pdf_url || `${data.secure_url}/pdf`}

à¸•à¸´à¸”à¸•à¹ˆà¸­à¸ªà¸­à¸šà¸–à¸²à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡:
ðŸ“ž Tel: BKK +662 2744216  ðŸ“ž Tel: HKG +852 23921155
ðŸ“§ Email: booking@dhakulchan.com
ðŸ“± Line OA: @dhakulchan | @changuru
ðŸ›ï¸ à¸£à¸¹à¹‰à¸ˆà¸±à¸à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯: https://www.dhakulchan.net/page/about-dhakulchan`;
                }

                return { message: message, data: data };
            } else {
                throw new Error(data.error || 'Failed to generate secure URL');
            }
        } catch (error) {
            console.error('âŒ Error generating enhanced message:', error);
            throw error;
        }
    }

    // Missing functions that are called from buttons but not in external JS
    async function copyEnhancedMessage(bookingId) {
        try {
            console.log('ðŸŽ¯ Copy Message button clicked for booking:', bookingId);
            showToast('ðŸ”„ Generating secure message...', 'info');
            const { message } = await generateEnhancedMessage(bookingId);
            console.log('ðŸ“ Message generated:', message);

            if (navigator.clipboard) {
                await navigator.clipboard.writeText(message);
                showToast('âœ… Message copied to clipboard!', 'success');
                console.log('âœ… Message copied via navigator.clipboard');
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('âœ… Message copied to clipboard!', 'success');
                console.log('âœ… Message copied via fallback method');
            }
        } catch (error) {
            console.error('âŒ Copy message error:', error);
            showToast('âŒ Error copying message: ' + error.message, 'error');
        }
    }

    async function resetShareToken(bookingId) {
        try {
            showToast('ðŸ”„ Resetting share token...', 'info');
            const response = await fetch(`/api/booking/${bookingId}/reset-share-token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();

            if (data.success) {
                showToast('âœ… Share token reset successfully!', 'success');
                // Reload page to show new token
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('âŒ Failed to reset share token', 'error');
            }
        } catch (error) {
            showToast('âŒ Error resetting share token: ' + error.message, 'error');
        }
    }

    async function lockShareToken(bookingId) {
        try {
            showToast('ðŸ”„ Locking share token...', 'info');
            const response = await fetch(`/api/booking/${bookingId}/lock-share-token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();

            if (data.success) {
                showToast('ðŸ”’ Share token locked successfully!', 'success');
                // Reload page to show locked status
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('âŒ Failed to lock share token', 'error');
            }
        } catch (error) {
            showToast('âŒ Error locking share token: ' + error.message, 'error');
        }
    }

    async function sendToLineOA(bookingId) {
        try {
            showToast('ðŸ”„ Preparing Line OA message...', 'info');
            const { message } = await generateEnhancedMessage(bookingId);

            // Open Line with pre-filled message
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');

            showToast('ðŸ“± Opening Line OA...', 'success');
        } catch (error) {
            showToast('âŒ Error opening Line OA: ' + error.message, 'error');
        }
    }

    async function openPublicSharePage(bookingId) {
        try {
            showToast('ðŸ”„ Generating secure share page...', 'info');
            const { data } = await generateEnhancedMessage(bookingId);
            window.open(data.secure_url, '_blank');
            showToast('ðŸŒ Opening public share page...', 'success');
        } catch (error) {
            showToast('âŒ Error opening share page: ' + error.message, 'error');
        }
    }

    async function emailLinkMessage(bookingId) {
        try {
            console.log('ðŸŽ¯ Email Link-Message button clicked for booking:', bookingId);
            showToast('ðŸ”„ Preparing to send email...', 'info');

            // Prompt user for email address
            const email = prompt('Enter email address to send the booking link:');
            if (!email) {
                showToast('ðŸ“§ Email sending cancelled', 'info');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('âŒ Please enter a valid email address', 'error');
                return;
            }

            console.log('ðŸ“§ Sending email to:', email);
            showToast('ðŸ“§ Sending email...', 'info');

            // Send email via API
            const response = await fetch(`/api/share/booking/${bookingId}/send-email`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',  // Include cookies for authentication
                body: JSON.stringify({ email: email })
            });

            console.log('ðŸ“¡ Email API response:', response.status, response.statusText);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('ðŸ“§ Email response data:', data);

            if (data.success) {
                showToast(`âœ… Email sent successfully to ${email}!`, 'success');
            } else {
                showToast(`âŒ Failed to send email: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('âŒ Email error:', error);
            showToast('âŒ Error sending email: ' + error.message, 'error');
        }
    }

    async function shareToSocialMedia(bookingId) {
        try {
            showToast('ðŸ”„ Preparing public page share...', 'info');
            const { message, data } = await generateEnhancedMessage(bookingId);

            // à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸šà¸šà¹ƒà¸«à¸¡à¹ˆ (à¸ªà¸±à¹‰à¸™à¸à¸§à¹ˆà¸²à¹€à¸”à¸´à¸¡)
            const shortMessage = `à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°
à¸šà¸£à¸´à¸©à¸±à¸— à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯ à¹à¸ˆà¹‰à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸šà¸£à¸´à¸à¸²à¸£à¸«à¸£à¸·à¸­à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸±à¸§à¸£à¹Œ à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡ ${data.booking_reference}
à¸à¸£à¸¸à¸“à¸²à¸„à¸¥à¸´à¸à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸•à¸²à¸¡à¸¥à¸´à¸‡à¸„à¹Œà¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸„à¹ˆà¸°

ðŸ“‹ Service Proposal-Travel Service: ${data.secure_url}

à¸•à¸´à¸”à¸•à¹ˆà¸­à¸ªà¸­à¸šà¸–à¸²à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡:
ðŸ“ž Tel: BKK +662 2744216  ðŸ“ž Tel: HKG +852 23921155
ðŸ“§ Email: booking@dhakulchan.com
ðŸ“± Line OA: @dhakulchan | @changuru
ðŸ›ï¸ à¸£à¸¹à¹‰à¸ˆà¸±à¸à¸•à¸£à¸°à¸à¸¹à¸¥à¹€à¸‰à¸´à¸™à¸¯: https://www.dhakulchan.net/page/about-dhakulchan`;

            if (navigator.share) {
                await navigator.share({
                    title: `${data.document_title} - ${data.booking_reference}`,
                    text: shortMessage,
                    url: data.secure_url
                });
                showToast('ðŸ“± Shared successfully!', 'success');
            } else {
                // Fallback for browsers without Web Share API
                await navigator.clipboard.writeText(shortMessage);
                showToast('ðŸ“‹ Share content copied to clipboard!', 'success');
            }
        } catch (error) {
            showToast('âŒ Error sharing: ' + error.message, 'error');
        }
    }

    async function getShareStatus(bookingId) {
        try {
            console.log('ðŸŽ¯ Share Status button clicked for booking:', bookingId);
            showToast('ðŸ”„ Checking share status...', 'info');
            const response = await fetch(`/api/share/booking/${bookingId}/status`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'  // Include cookies for authentication
            });
            console.log('ðŸ“¡ Share status response:', response.status, response.statusText);

            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Please login to access this feature');
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            }

            const data = await response.json();
            console.log('ðŸ“Š Share status data:', data);

            if (data.success) {
                showToast(`ðŸ“Š Shares: ${data.share_count || 0} | Views: ${data.view_count || 0}`, 'info');
            } else {
                showToast('âŒ Could not get share status: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('âŒ Share status error:', error);
            showToast('âŒ Error getting share status: ' + error.message, 'error');
        }
    }    // Helper function for toast notifications (if not already defined)
    function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `${message} <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
        document.body.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // Admin & Management Section Enhancements
    document.addEventListener('DOMContentLoaded', function () {
        // Handle collapse toggle with icon rotation
        const adminToggleBtn = document.querySelector('[data-bs-target="#adminManagementContent"]');
        const adminCollapse = document.getElementById('adminManagementContent');

        if (adminToggleBtn && adminCollapse) {
            adminCollapse.addEventListener('show.bs.collapse', function () {
                adminToggleBtn.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
                adminToggleBtn.classList.replace('btn-outline-warning', 'btn-warning');
            });

            adminCollapse.addEventListener('hide.bs.collapse', function () {
                adminToggleBtn.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down');
                adminToggleBtn.classList.replace('btn-warning', 'btn-outline-warning');
            });
        }

        // Add subtle animations to admin content boxes
        const adminContentBoxes = document.querySelectorAll('.admin-content-box');
        adminContentBoxes.forEach(box => {
            box.addEventListener('mouseenter', function () {
                this.style.transform = 'scale(1.02)';
                this.style.transition = 'all 0.2s ease';
            });

            box.addEventListener('mouseleave', function () {
                this.style.transform = 'scale(1)';
            });
        });

        // Add pulse effect to admin icons when content is empty
        const emptyAdminBoxes = document.querySelectorAll('.admin-content-box .text-muted');
        emptyAdminBoxes.forEach(box => {
            if (box.textContent.trim() === 'None') {
                const icon = box.querySelector('i');
                if (icon) {
                    setInterval(() => {
                        icon.style.opacity = '0.3';
                        setTimeout(() => {
                            icon.style.opacity = '0.6';
                        }, 1000);
                    }, 2000);
                }
            }
        });
    });

    // Activity Logs Functions
    function showMoreActivityLogs() {
        // Could implement AJAX call to load more activity logs
        showToast('ðŸ“‹ Loading more activity logs...', 'info');

        setTimeout(() => {
            showToast('â„¹ï¸ All recent activity logs are already displayed', 'info');
        }, 1000);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        // Simple toast implementation - you can enhance this
        const toastHtml = `
            <div class="toast show position-fixed top-0 end-0 m-3" style="z-index: 9999;">
                <div class="toast-body bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} text-white">
                    ${message}
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', toastHtml);

        setTimeout(() => {
            const toasts = document.querySelectorAll('.toast');
            if (toasts.length > 0) {
                toasts[toasts.length - 1].remove();
            }
        }, 3000);
    }
</script>

{% endblock %}