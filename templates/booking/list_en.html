{% extends "base.html" %}

{% block title %}Booking List{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Booking Management
        </h1>
        <div>
            <a href="{{ url_for('booking.create') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Booking
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <!-- Row 1: Primary status cards -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-secondary">
                <div class="card-body text-center">
                    <h5 class="card-title text-secondary">
                        <i class="fas fa-edit fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.draft }}</h3>
                    <p class="text-muted mb-0">Draft</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">
                        <i class="fas fa-clock fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.pending }}</h3>
                    <p class="text-muted mb-0">Pending</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.confirmed }}</h3>
                    <p class="text-muted mb-0">Confirmed</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title text-info">
                        <i class="fas fa-file-invoice fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.quoted }}</h3>
                    <p class="text-muted mb-0">Quoted</p>
                </div>
            </div>
        </div>

        <!-- Row 2: Payment and completion status cards -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">
                        <i class="fas fa-credit-card fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.paid }}</h3>
                    <p class="text-muted mb-0">Paid</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-ticket-alt fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.vouchered }}</h3>
                    <p class="text-muted mb-0">Vouchered</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </h5>
                    <h3 class="mb-0">{{ stats.cancelled }}</h3>
                    <p class="text-muted mb-0">Cancelled</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-search me-2"></i>Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="search"
                        placeholder="Customer, email, booking ref, quote number (QT...), guest name..."
                        value="{{ request.args.get('search', '') }}">
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="status">
                        <option value="">All Statuses</option>
                        <option value="draft" {% if request.args.get('status')=='draft' %}selected{% endif %}>
                            Draft</option>
                        <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>
                            Pending</option>
                        <option value="confirmed" {% if request.args.get('status')=='confirmed' %}selected{% endif %}>
                            Confirmed</option>
                        <option value="cancelled" {% if request.args.get('status')=='cancelled' %}selected{% endif %}>
                            Cancelled</option>
                        <option value="quoted" {% if request.args.get('status')=='quoted' %}selected{% endif %}>
                            Quoted</option>
                        <option value="paid" {% if request.args.get('status')=='paid' %}selected{% endif %}>
                            Paid</option>
                        <option value="vouchered" {% if request.args.get('status')=='vouchered' %}selected{% endif %}>
                            Vouchered</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" name="date_from"
                        value="{{ request.args.get('date_from', '') }}" placeholder="From Date">
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" name="date_to" value="{{ request.args.get('date_to', '') }}"
                        placeholder="To Date">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bookings List -->
    {% if bookings %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Bookings ({{ bookings|length }} found)
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Arrival</th>
                            <th>Guests</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>
                                <strong class="text-primary">{{ booking.booking_reference }}</strong>
                            </td>
                            <td>
                                {% if booking.customer %}
                                <div>
                                    <strong>{{ booking.customer.name }}</strong>
                                </div>
                                <small class="text-muted">{{ booking.customer.email }}</small>
                                {% else %}
                                <span class="text-muted">No Customer</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary text-capitalize">{{ booking.booking_type }}</span>
                            </td>
                            <td>
                                {% if booking.arrival_date %}
                                {{ booking.arrival_date.strftime('%d/%m/%Y') }}
                                {% else %}
                                <span class="text-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ booking.total_pax }}</span>
                            </td>
                            <td>
                                {% if booking.total_amount %}
                                <span class="badge bg-success">
                                    {{ booking.currency or 'THB' }} {{ "{:,.2f}".format(booking.total_amount or 0) }}
                                </span>
                                {% else %}
                                <span class="text-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if booking.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif booking.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                                {% elif booking.status == 'confirmed' %}
                                <span class="badge bg-success">Confirmed</span>
                                {% elif booking.status == 'quoted' %}
                                <span class="badge bg-info">Quoted</span>
                                {% elif booking.status == 'invoiced' %}
                                <span class="badge bg-primary">Invoiced</span>
                                {% elif booking.status == 'paid' %}
                                <span class="badge bg-dark">Paid</span>
                                {% elif booking.status == 'vouchered' %}
                                <span class="badge bg-success">Vouchered</span>
                                {% elif booking.status == 'completed' %}
                                <span class="badge bg-info">Completed</span>
                                {% elif booking.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% else %}
                                <span class="badge bg-light text-dark">{{ booking.status|title }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('booking.view', id=booking.id) }}"
                                        class="btn btn-outline-primary btn-sm" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if booking.status != 'cancelled' %}
                                    <a href="{{ url_for('booking.edit', id=booking.id) }}"
                                        class="btn btn-outline-secondary btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    {#
                                    {% if not booking.invoice_id %}
                                    <form method="POST"
                                        action="{{ url_for('invoice.create_invoice', booking_id=booking.id) }}"
                                        class="d-inline">
                                        <button type="submit" class="btn btn-outline-warning btn-sm"
                                            title="Create Invoice">
                                            <i class="fas fa-file-invoice"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    #}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h4>No Bookings Found</h4>
        <p>No bookings match your search criteria or none have been created yet.</p>
        <a href="{{ url_for('booking.create') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create First Booking
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}