{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #{{ booking.booking_number }} - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div c <div class="card-body">
        <p class="mb-0">
            {% for guest in guests %}
            {% if guest and guest.strip() %}
            {{ guest|replace('\n', '<br>')|replace('</p>', '</p><br>')|replace('/n', '<br>')|replace(',', ',<br>')|safe
        }}{% if not loop.last %}<br>{% endif %}
        {% endif %}
        {% endfor %}
        </p>
    </div>d-body">
    <p class="mb-0">
        {% for guest in guests %}
        {% if guest and guest.strip() %}
        {{ guest|replace('\n', '<br>')|replace('</p>', '</p><br>')|replace('/n', '<br>')|replace(',', ',<br>')|safe
    }}{% if not loop.last %}, {% endif %}
    {% endif %}
    {% endfor %}
    </p>
</div>ass="h2">
<i class="fas fa-eye me-2 text-primary"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #{{ booking.booking_number }}
</h1>
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
        <a href="{{ url_for('booking.edit', id=booking.id) }}" class="btn btn-warning">
            <i class="fas fa-edit me-2"></i>‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        </a>

        {% if booking.status == 'quoted' or booking.status == 'paid' or booking.status == 'vouchered' %}
        <!-- Status-based PDF/PNG Buttons -->
        {% if booking.status == 'quoted' %}
        <!-- Quote Status: Quote PDF -->
        <a href="{{ url_for('booking.generate_quote_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
            class="btn btn-info" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Quote PDF (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)
        </a>
        <a href="{{ url_for('booking.email_quote_pdf', booking_id=booking.id) }}" class="btn btn-outline-info">
            <i class="fas fa-envelope me-2"></i>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå-‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </a>
        {% elif booking.status == 'paid' %}
        <!-- Paid Status: Quote / Provisional Receipt PDF -->
        <a href="{{ url_for('booking.generate_quote_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
            class="btn btn-info" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Quote / Provisional Receipt PDF (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
        </a>
        <a href="{{ url_for('booking.email_quote_pdf', booking_id=booking.id) }}" class="btn btn-outline-info">
            <i class="fas fa-envelope me-2"></i>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå-‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </a>
        {% elif booking.status == 'vouchered' %}
        <!-- Vouchered Status: Tour Voucher PDF -->
        <a href="{{ url_for('voucher.generate_pdf', id=booking.id) }}?v={{ timestamp() }}" class="btn btn-info"
            target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Tour Voucher PDF (‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå)
        </a>
        <a href="{{ url_for('voucher.email_voucher', id=booking.id) }}" class="btn btn-outline-info">
            <i class="fas fa-envelope me-2"></i>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå-‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </a>
        {% endif %}

        <!-- Status-based PNG with Share Options -->
        <div class="btn-group" role="group">
            {% if booking.status == 'quoted' %}
            <a href="{{ url_for('booking.generate_quote_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                class="btn btn-secondary" target="_blank">
                <i class="fas fa-image me-2"></i>Quote PNG (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)
            </a>
            {% elif booking.status == 'paid' %}
            <a href="{{ url_for('booking.generate_quote_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                class="btn btn-secondary" target="_blank">
                <i class="fas fa-image me-2"></i>Quote / Provisional Receipt PNG (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
            </a>
            {% elif booking.status == 'vouchered' %}
            <a href="{{ url_for('voucher.generate_png', id=booking.id) }}?v={{ timestamp() }}" class="btn btn-secondary"
                target="_blank">
                <i class="fas fa-image me-2"></i>Tour Voucher PNG (‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå)
            </a>
            {% endif %}
            <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { shareToLineOA('{{ booking.id|default(0) }}', 'quote'); } catch(e) { console.error('shareToLineOA error:', e); }">
                        <i class="fab fa-line me-2" style="color: #00B900;"></i>‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Line OA
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { copyLineMessage('{{ booking.id|default(0) }}', 'quote'); } catch(e) { console.error('copyLineMessage error:', e); }">
                        <i class="fas fa-copy me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { shareToSocialMedia('{{ booking.id|default(0) }}', 'quote'); } catch(e) { console.error('shareToSocialMedia error:', e); }">
                        <i class="fas fa-share-alt me-2"></i>‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { openSharePage('{{ booking.id|default(0) }}', 'quote'); } catch(e) { console.error('openSharePage error:', e); }">
                        <i class="fas fa-external-link-alt me-2"></i>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå
                    </a>
                </li>
            </ul>
        </div>
        {% elif booking.status not in ['draft', 'cancelled'] %}
        <!-- Service Proposal PDF/PNG Buttons for pending/confirmed and other statuses -->
        {% if booking.status in ['pending', 'confirmed'] %}
        <!-- Pending/Confirmed Status: Service Proposal PDF -->
        <a href="{{ url_for('booking.generate_booking_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
            class="btn btn-info" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Service Proposal PDF (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)
        </a>
        <a href="{{ url_for('booking.email_booking_pdf', booking_id=booking.id) }}" class="btn btn-outline-info">
            <i class="fas fa-envelope me-2"></i>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå-‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </a>
        {% else %}
        <!-- Default Status: Service Proposal PDF -->
        <a href="{{ url_for('booking.generate_booking_pdf', booking_id=booking.id) }}?v={{ timestamp() }}"
            class="btn btn-info" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Service Proposal PDF (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)
        </a>
        <a href="{{ url_for('booking.email_booking_pdf', booking_id=booking.id) }}" class="btn btn-outline-info">
            <i class="fas fa-envelope me-2"></i>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå-‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </a>
        {% endif %}

        <!-- Service Proposal PNG with Share Options -->
        <div class="btn-group" role="group">
            <a href="{{ url_for('booking.generate_booking_png', booking_id=booking.id) }}?v={{ timestamp() }}"
                class="btn btn-secondary" target="_blank">
                <i class="fas fa-image me-2"></i>Service Proposal PNG (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)
            </a>
            <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { shareToLineOA('{{ booking.id|default(0) }}'); } catch(e) { console.error('shareToLineOA error:', e); }">
                        <i class="fab fa-line me-2" style="color: #00B900;"></i>‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Line OA
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { copyLineMessage('{{ booking.id|default(0) }}'); } catch(e) { console.error('copyLineMessage error:', e); }">
                        <i class="fas fa-copy me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { shareToSocialMedia('{{ booking.id|default(0) }}'); } catch(e) { console.error('shareToSocialMedia error:', e); }">
                        <i class="fas fa-share-alt me-2"></i>‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#"
                        onclick="try { openSharePage('{{ booking.id|default(0) }}'); } catch(e) { console.error('openSharePage error:', e); }">
                        <i class="fas fa-external-link-alt me-2"></i>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}

        {% if booking.status == 'confirmed' %}
        <!-- Show voucher button if invoice exists (for demo, would check paid status in production) -->
        {% if booking.invoice_number %}
        <a href="{{ url_for('voucher.view', id=booking.id) }}" class="btn btn-success">
            <i class="fas fa-ticket-alt me-2"></i>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå
        </a>
        {% else %}
        <span class="text-muted small">‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
        {% endif %}
        {% endif %}
    </div>
    <a href="{{ url_for('booking.list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>‡∏Å‡∏•‡∏±‡∏ö
    </a>
</div>
</div>

<!-- Status Alert -->
<div class="row mb-4">
    <div class="col-12">
        {% if booking.status == 'pending' %}
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-clock me-2"></i>
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</strong> - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        </div>
        {% elif booking.status == 'confirmed' %}
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</strong> - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        </div>
        {% elif booking.status == 'completed' %}
        <div class="alert alert-info" role="alert">
            <i class="fas fa-flag-checkered me-2"></i>
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</strong> - ‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        </div>
        {% elif booking.status == 'cancelled' %}
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-times-circle me-2"></i>
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</strong> - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Customer Information -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.customer.first_name }} {{ booking.customer.last_name }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong>
                    </div>
                    <div class="col-sm-8">
                        <a href="mailto:{{ booking.customer.email }}" class="text-decoration-none">
                            {{ booking.customer.email }}
                        </a>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong>
                    </div>
                    <div class="col-sm-8">
                        <a href="tel:{{ booking.customer.phone }}" class="text-decoration-none">
                            {{ booking.customer.phone }}
                        </a>
                    </div>
                </div>
                {% if booking.customer.nationality %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.customer.nationality }}
                    </div>
                </div>
                {% endif %}
                {% if booking.customer.address %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ booking.customer.address }}
                    </div>
                </div>
                {% endif %}
                {% if booking.customer.notes %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong>
                    </div>
                    <div class="col-sm-8">
                        <small class="text-muted">{{ booking.customer.notes|replace('\n', '<br>')|replace('</p>', '</p>
                            <br>')|safe }}</small>
                    </div>
                </div>
                {% endif %}
                <div class="row">
                    <div class="col-sm-4">
                        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="thai-number">{{ booking.customer.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Information -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏à‡∏≠‡∏á:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-primary fs-6">#{{ booking.booking_number }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡∏ß‡∏£‡πå:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-secondary">{{ booking.booking_type }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:</strong>
                    </div>
                    <div class="col-sm-8">
                        {% if booking.arrival_date %}
                        <span class="thai-number">{{ booking.arrival_date.strftime('%d/%m/%Y') }}</span>
                        {% if booking.departure_date %}
                        ‡∏ñ‡∏∂‡∏á <span class="thai-number">{{ booking.departure_date.strftime('%d/%m/%Y') }}</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏</span>
                        {% endif %}
                    </div>
                </div>
                <!-- ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏∏‡πä‡∏õ -->
                {% if booking.party_code %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏∏‡πä‡∏õ:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-info">{{ booking.party_code }}</span>
                    </div>
                </div>
                {% endif %}
                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á -->
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:</strong>
                    </div>
                    <div class="col-sm-8">
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-primary">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà: {{ booking.adults or 0 }}</span>
                            <span class="badge bg-info">‡πÄ‡∏î‡πá‡∏Å: {{ booking.children or 0 }}</span>
                            <span class="badge bg-warning text-dark">‡∏ó‡∏≤‡∏£‡∏Å (‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 2 ‡∏õ‡∏µ): {{ booking.infants or 0
                                }}</span>
                        </div>
                        <div class="mt-2">
                            <strong>‡∏£‡∏ß‡∏°:</strong> <span class="badge bg-dark">{{ (booking.adults or 0) +
                                (booking.children or 0) + (booking.infants or 0) }}</span> ‡∏Ñ‡∏ô
                        </div>
                    </div>
                </div>
                <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ -->
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:</strong>
                    </div>
                    <div class="col-sm-8">
                        {% if booking.quote_number %}
                        <a href="{{ url_for('invoice.view_quote', booking_id=booking.id) }}"
                            class="badge bg-secondary text-decoration-none" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î quote">
                            {{ booking.quote_number }} <i class="fas fa-eye ms-1"></i>
                        </a>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ:</strong>
                    </div>
                    <div class="col-sm-8">
                        {% if booking.invoice_number %}
                        <span class="badge bg-success">{{ booking.invoice_number }}</span>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="thai-number">{{ booking.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                </div>
                <!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á -->
                {% set guests = booking.get_guest_list() %}
                {% if guests %}
                <div class="row">
                    <div class="col-sm-4">
                        <strong>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:</strong>
                    </div>
                    <div class="col-sm-8">
                        <div class="small">{{ guests|join(', ') }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Service Detail / Itinerary (moved above Name List) -->
{% if booking.description %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="background-color: #17a2b8; color: white;">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ booking.description|replace('\n', '<br>')|replace('</p>', '</p><br>')|safe }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á -->
{% set guests = booking.get_guest_list() %}
{% if guests %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                </h5>
            </div>
            <div class="card-body">
                <div class="guest-item" id="guest-list-display-th" style="white-space: pre-line;">
                    {% set guest_text = booking.get_guest_list_for_edit() %}
                    {% if guest_text and guest_text.strip() %}
                    {{ guest_text.strip() }}
                    {% else %}
                    <span class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô -->
<div class="row mb-4">
    {% if booking.flight_info %}
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plane me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏¥‡∏ô
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ booking.flight_info|replace('\n', '<br>')|replace('</p>', '</p><br>')|safe }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if booking.internal_note %}
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard me-2"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0 small text-muted">{{ booking.internal_note|replace('\n', '<br>')|replace('</p>', '</p>
                <br>')|safe }}</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Financial Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="background-color: #28a745; color: white;">
                <h5 class="card-title mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calculator me-2"></i>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
                                <small class="text-muted">(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</small>
                            </label>
                            <div class="p-3 bg-light rounded">
                                <h4 class="mb-0 text-primary">
                                    {% if booking.total_amount %}
                                    ‡∏ø{{ "%.2f"|format(booking.total_amount|float) }}
                                    {% else %}
                                    ‡∏ø0.00
                                    {% endif %}
                                </h4>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-money-bill-wave me-2"></i>‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô
                            </label>
                            <div class="p-3 bg-light rounded">
                                <h5 class="mb-0">
                                    {% if booking.currency %}
                                    {% if booking.currency == 'THB' %}üáπüá≠ ‡∏ö‡∏≤‡∏ó‡πÑ‡∏ó‡∏¢ (THB)
                                    {% elif booking.currency == 'USD' %}üá∫üá∏ ‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡∏™‡∏´‡∏£‡∏±‡∏ê (USD)
                                    {% elif booking.currency == 'EUR' %}üá™üá∫ ‡∏¢‡∏π‡πÇ‡∏£ (EUR)
                                    {% elif booking.currency == 'GBP' %}üá¨üáß ‡∏õ‡∏≠‡∏ô‡∏î‡πå‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (GBP)
                                    {% elif booking.currency == 'JPY' %}üáØüáµ ‡πÄ‡∏¢‡∏ô‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô (JPY)
                                    {% elif booking.currency == 'CNY' %}üá®üá≥ ‡∏´‡∏¢‡∏ß‡∏ô‡∏à‡∏µ‡∏ô (CNY)
                                    {% elif booking.currency == 'SGD' %}üá∏üá¨ ‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå (SGD)
                                    {% elif booking.currency == 'MYR' %}üá≤üáæ ‡∏£‡∏¥‡∏á‡∏Å‡∏¥‡∏ï‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢ (MYR)
                                    {% elif booking.currency == 'AUD' %}üá¶üá∫ ‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢ (AUD)
                                    {% elif booking.currency == 'CAD' %}üá®üá¶ ‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå‡πÅ‡∏Ñ‡∏ô‡∏≤‡∏î‡∏≤ (CAD)
                                    {% else %}{{ booking.currency }}
                                    {% endif %}
                                    {% else %}
                                    üáπüá≠ ‡∏ö‡∏≤‡∏ó‡πÑ‡∏ó‡∏¢ (THB)
                                    {% endif %}
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tour Details and Special Requests -->
<div class="row">
    <div class="col-lg-8 mb-4">
        {% if booking.special_request %}
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sticky-note me-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ booking.special_request|replace('\n', '<br>')|replace('</p>', '</p><br>')|safe }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Admin Notes -->
        {% if booking.admin_notes %}
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fas fa-user-shield me-2"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
                        <span class="badge bg-light text-dark ms-2">
                            <i class="fas fa-lock me-1"></i>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                        </span>
                    </span>
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse"
                        data-bs-target="#adminNotesContent" aria-expanded="false" aria-controls="adminNotesContent">
                        <i class="fas fa-eye me-1"></i>‡πÅ‡∏™‡∏î‡∏á
                    </button>
                </h5>
            </div>
            <div class="collapse" id="adminNotesContent">
                <div class="card-body">
                    <div class="alert alert-danger mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    </div>
                    <div class="mb-0" style="white-space: pre-line;">{{ booking.admin_notes|replace('\r\n',
                        '<br>')|replace('\n', '<br>')|replace('</p>', '</p><br>')|safe }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Manager Memos -->
        {% if booking.manager_memos %}
        <div class="card mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fas fa-clipboard-list me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                        <span class="badge bg-light text-dark ms-2">
                            <i class="fas fa-briefcase me-1"></i>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                        </span>
                    </span>
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse"
                        data-bs-target="#managerMemosContent" aria-expanded="false" aria-controls="managerMemosContent">
                        <i class="fas fa-eye me-1"></i>‡πÅ‡∏™‡∏î‡∏á
                    </button>
                </h5>
            </div>
            <div class="collapse" id="managerMemosContent">
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£:</strong> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                    </div>
                    <div class="mb-0" style="white-space: pre-line;">{{ booking.manager_memos|replace('\r\n',
                        '<br>')|replace('\n', '<br>')|replace('</p>', '</p><br>')|safe }}</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Payment Information -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-money-bill me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="thai-number">{{ booking.total_pax }}</span> √ó
                            <span class="thai-number">{{ "{:,.0f}".format((booking.total_amount or 0) /
                                booking.total_pax if
                                booking.total_pax > 0 else 0) }}</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <strong class="text-success thai-number">{{ "{:,.2f}".format(booking.total_amount or 0)
                                }}</strong>
                            ‡∏ö‡∏≤‡∏ó
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    {% if not booking.quote_id %}
                    <form method="POST" action="{{ url_for('invoice.create_quote', booking_id=booking.id) }}"
                        class="d-inline">
                        <button type="submit" class="btn btn-outline-info">
                            <i class="fas fa-file-alt me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Quote
                        </button>
                    </form>
                    {% else %}
                    <span class="text-muted">Quote ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Related Vouchers -->
    {% if booking.vouchers %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-ticket-alt me-2"></i>‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                        <span class="badge bg-light text-dark ms-2 thai-number">{{ booking.vouchers|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£</th>
                                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                    <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for voucher in booking.vouchers %}
                                <tr>
                                    <td>
                                        <span class="fw-bold text-primary">#{{ voucher.voucher_number }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ voucher.voucher_type }}</span>
                                    </td>
                                    <td>
                                        {% if voucher.status == 'active' %}
                                        <span class="badge bg-success">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span>
                                        {% elif voucher.status == 'used' %}
                                        <span class="badge bg-secondary">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</span>
                                        {% elif voucher.status == 'expired' %}
                                        <span class="badge bg-danger">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="thai-number">{{ voucher.created_at.strftime('%d/%m/%Y %H:%M')
                                            }}</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('voucher.view', id=voucher.id) }}"
                                                class="btn btn-outline-primary btn-sm" title="‡∏î‡∏π‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('voucher.download', id=voucher.id) }}"
                                                class="btn btn-outline-success btn-sm" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {#
    Invoice Ninja Integration - ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-receipt me-2"></i>‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Invoice Ninja
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="me-3"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Quote:</strong></span>
                                {% if booking.quote_id %}
                                <span class="badge bg-info">{{ booking.quote_id }}</span>
                                {% else %}
                                <span class="badge bg-secondary">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Quote</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="me-3"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Invoice:</strong></span>
                                {% if booking.invoice_id %}
                                <span class="badge bg-warning">{{ booking.invoice_id }}</span>
                                {% else %}
                                <span class="badge bg-secondary">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Invoice</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="btn-group" role="group">
                        {% if not booking.quote_id %}
                        <form method="POST" action="{{ url_for('invoice.create_quote', booking_id=booking.id) }}"
                            class="d-inline">
                            <button type="submit" class="btn btn-outline-info me-2">
                                <i class="fas fa-file-alt me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Quote
                            </button>
                        </form>
                        {% endif %}

                        {% if not booking.invoice_id %}
                        <form method="POST" action="{{ url_for('invoice.create_invoice', booking_id=booking.id) }}"
                            class="d-inline">
                            <button type="submit" class="btn btn-outline-warning me-2">
                                <i class="fas fa-file-invoice me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Invoice
                            </button>
                        </form>
                        {% endif %}

                        {% if booking.invoice_id %}
                        <form method="POST" action="{{ url_for('invoice.send_invoice', booking_id=booking.id) }}"
                            class="d-inline">
                            <button type="submit" class="btn btn-outline-primary me-2">
                                <i class="fas fa-envelope me-2"></i>‡∏™‡πà‡∏á Invoice ‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                            </button>
                        </form>

                        <!-- Mark as Paid with Password Protection -->
                        {% if not booking.is_paid %}
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal"
                            data-bs-target="#markPaidModal" data-booking-id="{{ booking.id }}"
                            data-invoice-number="{{ booking.invoice_number }}"
                            data-quote-number="{{ booking.quote_number }}"
                            data-invoice-status="{{ booking.invoice_status }}">
                            <i class="fas fa-check-circle me-2"></i>‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-success me-2" data-bs-toggle="modal"
                            data-bs-target="#confirmPaidModal" data-booking-id="{{ booking.id }}"
                            data-invoice-number="{{ booking.invoice_number }}"
                            data-quote-number="{{ booking.quote_number }}"
                            data-invoice-status="{{ booking.invoice_status }}"
                            title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á">
                            <i class="fas fa-check-circle me-1"></i>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    #} <!-- Status Change Actions -->
    {% if booking.status != 'cancelled' %}
    <div class="row">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        {% if booking.status == 'pending' %}
                        <form method="POST" action="{{ url_for('booking.update_status', id=booking.id) }}"
                            class="d-inline">
                            <input type="hidden" name="status" value="confirmed">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="fas fa-check me-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                            </button>
                        </form>
                        {% endif %}

                        {% if booking.status in ['pending', 'confirmed'] %}
                        <form method="POST" action="{{ url_for('booking.update_status', id=booking.id) }}"
                            class="d-inline">
                            <input type="hidden" name="status" value="cancelled">
                            <button type="submit" class="btn btn-danger me-2"
                                onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                                <i class="fas fa-times me-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        // Auto-refresh page every 30 seconds for status updates
        setTimeout(function () {
            location.reload();
        }, 30000);

        // Handle collapse toggle for Admin Notes and Manager Memos
        document.addEventListener('DOMContentLoaded', function () {
            const adminNotesCollapse = document.getElementById('adminNotesContent');
            const managerMemosCollapse = document.getElementById('managerMemosContent');

            if (adminNotesCollapse) {
                const adminButton = document.querySelector('[data-bs-target="#adminNotesContent"]');
                adminNotesCollapse.addEventListener('show.bs.collapse', function () {
                    if (adminButton) {
                        adminButton.innerHTML = '<i class="fas fa-eye-slash me-1"></i>‡∏ã‡πà‡∏≠‡∏ô';
                    }
                });
                adminNotesCollapse.addEventListener('hide.bs.collapse', function () {
                    if (adminButton) {
                        adminButton.innerHTML = '<i class="fas fa-eye me-1"></i>‡πÅ‡∏™‡∏î‡∏á';
                    }
                });
            }

            if (managerMemosCollapse) {
                const managerButton = document.querySelector('[data-bs-target="#managerMemosContent"]');
                managerMemosCollapse.addEventListener('show.bs.collapse', function () {
                    if (managerButton) {
                        managerButton.innerHTML = '<i class="fas fa-eye-slash me-1"></i>‡∏ã‡πà‡∏≠‡∏ô';
                    }
                });
                managerMemosCollapse.addEventListener('hide.bs.collapse', function () {
                    if (managerButton) {
                        managerButton.innerHTML = '<i class="fas fa-eye me-1"></i>‡πÅ‡∏™‡∏î‡∏á';
                    }
                });
            }
        });
    </script>

    <!-- Mark as Paid Modal (Thai) -->
    <div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="markPaidModalLabel">
                        <i class="fas fa-check-circle me-2"></i>‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="‡∏õ‡∏¥‡∏î"></button>
                </div>
                <form id="markPaidForm" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö:</strong>
                            ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="quoteNumberEdit" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Quote:</label>
                                <input type="text" class="form-control" id="quoteNumberEdit" name="quote_number"
                                    placeholder="QT0344997">
                            </div>
                            <div class="col-md-6">
                                <label for="invoiceNumberEdit" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Invoice:</label>
                                <input type="text" class="form-control" id="invoiceNumberEdit" name="invoice_number"
                                    placeholder="AR0388592">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="statusEdit" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Invoice:</label>
                            <select class="form-select" id="statusEdit" name="invoice_status">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                                <option value="unknown">Unknown</option>
                                <option value="draft">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="sent">Sent</option>
                                <option value="viewed">Viewed</option>
                                <option value="approved">Approved</option>
                                <option value="partial">Partial</option>
                                <option value="paid">Paid</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="reversed">Reversed</option>
                                <option value="overdue">Overdue</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="payment_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="payment_password" name="payment_password"
                                placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" required>
                            <small class="form-text text-muted">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle me-1"></i>‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Paid Status Modal (Thai) -->
    <div class="modal fade" id="confirmPaidModal" tabindex="-1" aria-labelledby="confirmPaidModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="confirmPaidModalLabel">
                        <i class="fas fa-check-circle me-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="‡∏õ‡∏¥‡∏î"></button>
                </div>
                <form id="confirmPaidForm" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</strong>
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô "PAID" ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå
                            ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="confirmQuoteNumberEdit" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Quote:</label>
                                <input type="text" class="form-control" id="confirmQuoteNumberEdit" name="quote_number"
                                    placeholder="QT0344997">
                            </div>
                            <div class="col-md-6">
                                <label for="confirmInvoiceNumberEdit" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Invoice:</label>
                                <input type="text" class="form-control" id="confirmInvoiceNumberEdit"
                                    name="invoice_number" placeholder="AR0388592">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirmStatusEdit" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Invoice:</label>
                            <select class="form-select" id="confirmStatusEdit" name="invoice_status">
                                <option value="paid" selected>Paid</option>
                                <option value="partial">Partial</option>
                                <option value="approved">Approved</option>
                                <option value="sent">Sent</option>
                                <option value="viewed">Viewed</option>
                                <option value="pending">Pending</option>
                                <option value="draft">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="unknown">Unknown</option>
                            </select>
                            <small class="form-text text-muted">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô "Paid" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</small>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_payment_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="confirm_payment_password"
                                name="payment_password" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" required>
                            <small class="form-text text-muted">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</small>
                        </div>

                        <!-- Hidden field to maintain paid status -->
                        <input type="hidden" name="maintain_paid_status" value="true">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle me-1"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Payment Status Modal (Thai) -->
    <div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="editPaymentModalLabel">
                        <i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
                </div>
                <form id="editPaymentForm" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö:</strong>
                            ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô
                            "‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß"
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editQuoteNumberEdit" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Quote:</label>
                                <input type="text" class="form-control" id="editQuoteNumberEdit" name="quote_number"
                                    placeholder="QT0344997">
                            </div>
                            <div class="col-md-6">
                                <label for="editInvoiceNumberEdit" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Invoice:</label>
                                <input type="text" class="form-control" id="editInvoiceNumberEdit" name="invoice_number"
                                    placeholder="AR0388592">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editStatusEdit" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Invoice ‡πÉ‡∏´‡∏°‡πà:</label>
                            <select class="form-select" id="editStatusEdit" name="invoice_status">
                                <option value="unknown">Unknown</option>
                                <option value="draft">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="sent">Sent</option>
                                <option value="viewed">Viewed</option>
                                <option value="approved">Approved</option>
                                <option value="partial">Partial</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="reversed">Reversed</option>
                                <option value="overdue">Overdue</option>
                                <option value="pending">Pending</option>
                            </select>
                            <small class="form-text text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ "Unknown")</small>
                        </div>

                        <div class="mb-3">
                            <label for="edit_payment_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="edit_payment_password"
                                name="payment_password" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" required>
                            <small class="form-text text-muted">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-undo me-1"></i>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Handle Mark as Paid Modal (Thai)
        const markPaidModal = document.getElementById('markPaidModal');
        if (markPaidModal) {
            markPaidModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const invoiceNumber = button.getAttribute('data-invoice-number');
                const quoteNumber = button.getAttribute('data-quote-number');
                const invoiceStatus = button.getAttribute('data-invoice-status');

                const form = document.getElementById('markPaidForm');
                const invoiceEdit = document.getElementById('invoiceNumberEdit');
                const quoteEdit = document.getElementById('quoteNumberEdit');
                const statusEdit = document.getElementById('statusEdit');

                form.action = `/booking/${bookingId}/mark-paid`;
                invoiceEdit.value = invoiceNumber || '';
                quoteEdit.value = quoteNumber || '';
                statusEdit.value = invoiceStatus || '';
            });

            // Clear fields when modal is hidden
            markPaidModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('payment_password').value = '';
                document.getElementById('invoiceNumberEdit').value = '';
                document.getElementById('quoteNumberEdit').value = '';
                document.getElementById('statusEdit').value = '';
            });
        }

        // Handle Confirm Paid Status Modal (Thai)
        const confirmPaidModal = document.getElementById('confirmPaidModal');
        if (confirmPaidModal) {
            confirmPaidModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const invoiceNumber = button.getAttribute('data-invoice-number');
                const quoteNumber = button.getAttribute('data-quote-number');
                const invoiceStatus = button.getAttribute('data-invoice-status');

                const form = document.getElementById('confirmPaidForm');
                const invoiceEdit = document.getElementById('confirmInvoiceNumberEdit');
                const quoteEdit = document.getElementById('confirmQuoteNumberEdit');
                const statusEdit = document.getElementById('confirmStatusEdit');

                form.action = `/booking/${bookingId}/mark-paid`;
                invoiceEdit.value = invoiceNumber || '';
                quoteEdit.value = quoteNumber || '';
                // Default to 'paid' for confirmation, but show current status if it's already paid-related
                statusEdit.value = (invoiceStatus === 'paid' || invoiceStatus === 'partial') ? invoiceStatus : 'paid';
            });

            // Clear fields when modal is hidden
            confirmPaidModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('confirm_payment_password').value = '';
                document.getElementById('confirmInvoiceNumberEdit').value = '';
                document.getElementById('confirmQuoteNumberEdit').value = '';
                document.getElementById('confirmStatusEdit').value = 'paid';
            });
        }

        // Handle Edit Payment Status Modal (Thai)
        const editPaymentModal = document.getElementById('editPaymentModal');
        if (editPaymentModal) {
            editPaymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const invoiceNumber = button.getAttribute('data-invoice-number');
                const quoteNumber = button.getAttribute('data-quote-number');
                const invoiceStatus = button.getAttribute('data-invoice-status');

                const form = document.getElementById('editPaymentForm');
                const invoiceEdit = document.getElementById('editInvoiceNumberEdit');
                const quoteEdit = document.getElementById('editQuoteNumberEdit');
                const statusEdit = document.getElementById('editStatusEdit');

                form.action = `/booking/${bookingId}/unmark-paid`;
                invoiceEdit.value = invoiceNumber || '';
                quoteEdit.value = quoteNumber || '';
                statusEdit.value = invoiceStatus || 'unknown';
            });

            // Clear fields when modal is hidden
            editPaymentModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('edit_payment_password').value = '';
                document.getElementById('editInvoiceNumberEdit').value = '';
                document.getElementById('editQuoteNumberEdit').value = '';
                document.getElementById('editStatusEdit').value = 'unknown';
            });
        }

        // Quote Share Functions (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå Quote)
        async function shareToLineOA(bookingId, type = 'quote') {
            console.log(`Sharing ${type} to Line OA for booking ${bookingId}`);

            try {
                // Get booking status from page - use the booking object from template
                const bookingStatus = '{{ booking.status }}';

                let message;
                if (type === 'quote') {
                    // Status-based document names for quote type
                    let documentName;
                    if (bookingStatus === 'quoted') {
                        documentName = 'Quote (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)';
                    } else if (bookingStatus === 'paid') {
                        documentName = 'Quote / Provisional Receipt (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)';
                    } else if (bookingStatus === 'vouchered') {
                        documentName = 'Tour Voucher (‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå)';
                    } else {
                        documentName = '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
                    }

                    message = `üìã ${documentName} - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π: ${window.location.origin}/booking/view/${bookingId}`;
                } else {
                    // For booking type, determine document type based on status
                    let documentName, statusText;
                    if (bookingStatus === 'pending') {
                        documentName = 'Service Proposal (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)';
                        statusText = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                    } else if (bookingStatus === 'confirmed') {
                        documentName = 'Service Proposal (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)';
                        statusText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (bookingStatus === 'quoted') {
                        documentName = 'Quote (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)';
                        statusText = '‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (bookingStatus === 'paid') {
                        documentName = 'Quote / Provisional Receipt (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)';
                        statusText = '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (bookingStatus === 'vouchered') {
                        documentName = 'Tour Voucher (‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå)';
                        statusText = '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß';
                    } else {
                        documentName = 'Service Proposal (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)';
                        statusText = bookingStatus;
                    }

                    // Generate public URLs with 120-day token
                    const response = await fetch(`/api/share/booking/${bookingId}/url`);
                    const data = await response.json();

                    if (data.success) {
                        const publicUrl = data.secure_url;
                        const timestamp = new Date().toLocaleString('th-TH');

                        message = `üìã ${documentName} - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId} (${statusText})\n\n` +
                            `üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ 120 ‡∏ß‡∏±‡∏ô): ${publicUrl}\n` +
                            `üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF: ${publicUrl}/pdf\n` +
                            `üñºÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PNG: ${publicUrl}/png\n\n` +
                            `‚è∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${timestamp}\n` +
                            `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${window.location.origin}/booking/view/${bookingId}`;
                    } else {
                        // Fallback to regular URLs
                        message = `üìã ${documentName} - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId} (${statusText})\n\n` +
                            `üìÑ ‡∏î‡∏π PDF: ${window.location.origin}/booking/${bookingId}/pdf\n` +
                            `üñºÔ∏è ‡∏î‡∏π PNG: ${window.location.origin}/booking/${bookingId}/png\n\n` +
                            `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${window.location.origin}/booking/view/${bookingId}`;
                    }
                }

                const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
                window.open(lineUrl, '_blank');
            } catch (error) {
                console.error('Error generating share URL:', error);
                // Fallback to simple message
                const message = `üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π: ${window.location.origin}/booking/view/${bookingId}`;
                const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
                window.open(lineUrl, '_blank');
            }
        }

        async function copyLineMessage(bookingId, type = 'quote') {
            try {
                // Get booking status from template
                const bookingStatus = '{{ booking.status }}';

                let message;
                if (type === 'quote') {
                    // Status-based document names for quote type
                    let documentName;
                    if (bookingStatus === 'quoted') {
                        documentName = 'Quote (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)';
                    } else if (bookingStatus === 'paid') {
                        documentName = 'Quote / Provisional Receipt (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)';
                    } else if (bookingStatus === 'vouchered') {
                        documentName = 'Tour Voucher (‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå)';
                    } else {
                        documentName = '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
                    }

                    message = `üìã ${documentName} - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π: ${window.location.origin}/booking/view/${bookingId}`;
                } else {
                    // For booking type, determine document type based on status
                    let documentName, statusText;
                    if (bookingStatus === 'pending') {
                        documentName = 'Service Proposal (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)';
                        statusText = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                    } else if (bookingStatus === 'confirmed') {
                        documentName = 'Service Proposal (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)';
                        statusText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (bookingStatus === 'quoted') {
                        documentName = 'Quote (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)';
                        statusText = '‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (bookingStatus === 'paid') {
                        documentName = 'Quote / Provisional Receipt (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)';
                        statusText = '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                    } else if (bookingStatus === 'vouchered') {
                        documentName = 'Tour Voucher (‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå)';
                        statusText = '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß';
                    } else {
                        documentName = 'Service Proposal (‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)';
                        statusText = bookingStatus;
                    }

                    // Show loading indicator
                    const loadingMessage = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞...';
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(loadingMessage);
                    }

                    // Fetch public URL with 120-day token
                    const response = await fetch(`/api/share/booking/${bookingId}/url`);
                    const data = await response.json();

                    if (data.success) {
                        const publicUrl = data.secure_url;
                        const timestamp = new Date().toLocaleString('th-TH');

                        message = `üìã ${documentName} - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId} (${statusText})\n\n` +
                            `üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ 120 ‡∏ß‡∏±‡∏ô): ${publicUrl}\n` +
                            `üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF: ${publicUrl}/pdf\n` +
                            `üñºÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PNG: ${publicUrl}/png\n\n` +
                            `‚è∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${timestamp}\n` +
                            `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${window.location.origin}/booking/view/${bookingId}`;
                    } else {
                        // Fallback to regular URLs
                        message = `üìã ${documentName} - ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId} (${statusText})\n\n` +
                            `üìÑ ‡∏î‡∏π PDF: ${window.location.origin}/booking/${bookingId}/pdf\n` +
                            `üñºÔ∏è ‡∏î‡∏π PNG: ${window.location.origin}/booking/${bookingId}/png\n\n` +
                            `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${window.location.origin}/booking/view/${bookingId}`;
                    }
                }

                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(message);
                    alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡πÅ‡∏•‡πâ‡∏ß!');
                } else {
                    fallbackCopyTextToClipboard(message);
                }
            } catch (error) {
                console.error('Error generating share URL:', error);
                // Fallback to simple message
                const message = `üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π: ${window.location.origin}/booking/view/${bookingId}`;
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(message);
                    alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line ‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)!');
                } else {
                    fallbackCopyTextToClipboard(message);
                }
            }
        }

        function shareToSocialMedia(bookingId, type = 'quote') {
            const url = `${window.location.origin}/booking/view/${bookingId}`;
            const message = type === 'quote' ?
                `üìã ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π: ${url}` :
                `üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á #${bookingId}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π: ${url}`;

            // Show enhanced share modal
            showEnhancedShareModalThai(bookingId, type, url, message);
        }

        /**
         * Enhanced Share Modal with Multiple Platforms (Thai Version)
         */
        function showEnhancedShareModalThai(bookingId, type, url, message) {
            // Create enhanced modal HTML matching the design in the image (Thai version)
            const modalHtml = `
                <div class="modal fade" id="enhancedShareModalThai" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <!-- Header with close button -->
                            <div class="modal-header border-0 position-relative" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white;">
                                <div class="d-flex align-items-center w-100">
                                    <i class="fas fa-arrow-left me-3" style="font-size: 1.2rem; cursor: pointer;" 
                                       onclick="document.getElementById('enhancedShareModalThai').querySelector('.btn-close').click()"></i>
                                    <h5 class="modal-title mb-0 flex-grow-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå</h5>
                                    <button type="button" class="btn-close btn-close-white border-0 bg-transparent" 
                                            data-bs-dismiss="modal" aria-label="Close">
                                        <i class="fas fa-times" style="font-size: 1.2rem;"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Success message -->
                            <div class="px-4 py-2 bg-light">
                                <div class="text-success small">
                                    <i class="fas fa-check-circle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î ‡πÅ‡∏•‡πâ‡∏ß
                                </div>
                            </div>

                            <!-- Platform options -->
                            <div class="modal-body p-4">
                                <!-- Row 1: WhatsApp & Line -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <button class="btn w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 border-0 rounded-3" 
                                                style="background-color: #25D366; color: white; min-height: 80px;"
                                                onclick="shareToWhatsAppThai('${message}')">
                                            <i class="fab fa-whatsapp" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                            <span style="font-size: 1rem; font-weight: 500;">WhatsApp</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 border-0 rounded-3" 
                                                style="background-color: #00B900; color: white; min-height: 80px;"
                                                onclick="shareToLineThai('${message}')">
                                            <i class="fab fa-line" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                            <span style="font-size: 1rem; font-weight: 500;">Line</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Row 2: Facebook & Email -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <button class="btn w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 border-0 rounded-3" 
                                                style="background-color: #1877F2; color: white; min-height: 80px;"
                                                onclick="shareToFacebookThai('${url}')">
                                            <i class="fab fa-facebook-f" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                            <span style="font-size: 1rem; font-weight: 500;">Facebook</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 border-0 rounded-3" 
                                                style="background-color: #00BCD4; color: white; min-height: 80px;"
                                                onclick="shareToEmailThai('${message}', '${url}')">
                                            <i class="fas fa-envelope" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                            <span style="font-size: 1rem; font-weight: 500;">Email</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Row 3: Telegram & Twitter -->
                                <div class="row g-3 mb-4">
                                    <div class="col-6">
                                        <button class="btn w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 border-0 rounded-3" 
                                                style="background-color: #0088CC; color: white; min-height: 80px;"
                                                onclick="shareToTelegramThai('${message}')">
                                            <i class="fab fa-telegram-plane" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                            <span style="font-size: 1rem; font-weight: 500;">Telegram</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4 border-0 rounded-3" 
                                                style="background-color: #1DA1F2; color: white; min-height: 80px;"
                                                onclick="shareToTwitterThai('${message}', '${url}')">
                                            <i class="fab fa-twitter" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                                            <span style="font-size: 1rem; font-weight: 500;">Twitter</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Action buttons -->
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button class="btn btn-outline-primary w-100 py-3 rounded-3" 
                                                onclick="copyMessageToClipboardThai('${message}')">
                                            <i class="fas fa-copy me-2"></i>Copy Message
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-secondary w-100 py-3 rounded-3" 
                                                onclick="openSharePageThai('${url}')">
                                            <i class="fas fa-external-link-alt me-2"></i>Open Page
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer -->
                            <div class="modal-footer border-0 justify-content-center bg-light">
                                <small class="text-muted d-flex align-items-center">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    ‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('enhancedShareModalThai');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('enhancedShareModalThai'));
            modal.show();

            // Auto-copy message to clipboard when modal opens
            copyMessageToClipboardThai(message, false);

            // Clean up when modal is hidden
            document.getElementById('enhancedShareModalThai').addEventListener('hidden.bs.modal', () => {
                modalContainer.remove();
            });
        }

        // Platform-specific share functions (Thai version)
        function shareToWhatsAppThai(message) {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function shareToLineThai(message) {
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');
        }

        function shareToFacebookThai(url) {
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(facebookUrl, '_blank');
        }

        function shareToEmailThai(message, url) {
            const subject = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå";
            const body = `${message}\n\n‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á: ${url}`;
            const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = emailUrl;
        }

        function shareToTelegramThai(message) {
            const telegramUrl = `https://t.me/share/url?text=${encodeURIComponent(message)}`;
            window.open(telegramUrl, '_blank');
        }

        function shareToTwitterThai(message, url) {
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            window.open(twitterUrl, '_blank');
        }

        function copyMessageToClipboardThai(message, showAlert = true) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(message).then(() => {
                    if (showAlert) {
                        // Show success feedback
                        const toast = document.createElement('div');
                        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
                        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
                        toast.innerHTML = `
                            <div class="d-flex">
                                <div class="toast-body">
                                    <i class="fas fa-check-circle me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß!
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }
                }).catch(err => {
                    fallbackCopyTextToClipboard(message);
                });
            } else {
                fallbackCopyTextToClipboard(message);
            }
        }

        function openSharePageThai(url) {
            window.open(url + '?share=1', '_blank');
        }

        /**
         * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå (Public Share Page) ‡∏û‡∏£‡πâ‡∏≠‡∏° secure token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ 30 ‡∏ß‡∏±‡∏ô
         */
        async function openSharePage(bookingId, type = 'quote') {
            const button = event ? event.target : document.querySelector(`[onclick*="openSharePage('${bookingId}')"]`);
            const originalText = button ? button.textContent : '‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå';

            try {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ loading
                if (button) {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...';
                    button.disabled = true;
                }

                // ‡∏î‡∏∂‡∏á secure token-based URL (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ 30 ‡∏ß‡∏±‡∏ô)
                const response = await fetch(`/api/share/booking/${bookingId}/url`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
                    window.open(data.secure_url, '_blank');

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    showToast('üîó ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô', 'success');
                } else {
                    throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏î‡πâ');
                }

            } catch (error) {
                console.error('Error creating secure share link:', error);
                showToast(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            } finally {
                // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
                if (button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß!');
                } else {
                    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ');
            }

            document.body.removeChild(textArea);
        }

        // Unicode decoder for Thai text in view page
        function decodeUnicodeInElement(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.textContent) {
                try {
                    // Decode Unicode escape sequences
                    let decoded = element.textContent.replace(/\\u[\dA-F]{4}/gi, function (match) {
                        return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
                    });
                    element.textContent = decoded;
                } catch (e) {
                    console.log('Unicode decode error for ' + elementId + ':', e);
                }
            }
        }

        // Apply Unicode decoding to guest list
        decodeUnicodeInElement('guest-list-display-th');

        // Also check for other elements that might need decoding
        const textElements = document.querySelectorAll('.guest-item, .special-request-text, .admin-notes-text, .manager-memos-text');
        textElements.forEach(function (element) {
            if (element.textContent && element.textContent.includes('\\u')) {
                try {
                    let decoded = element.textContent.replace(/\\u[\dA-F]{4}/gi, function (match) {
                        return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
                    });
                    element.textContent = decoded;
                } catch (e) {
                    console.log('Unicode decode error:', e);
                }
            }
        });
    </script>
    {% endblock %}