{% extends "base.html" %}

{% block title %}{% if invoice %}Edit{% else %}Create{% endif %} Thai Invoice{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-file-invoice me-2"></i>{% if invoice %}Edit{% else %}Create{% endif %} Thai Invoice
            </h2>
        </div>
    </div>

    <form method="POST"
        action="{% if invoice %}{{ url_for('account_report.thai_invoice_edit', invoice_id=invoice.id) }}{% else %}{{ url_for('account_report.thai_invoice_create') }}{% endif %}">
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ข้อมูลลูกค้า (Customer Information)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ลูกค้า (Customer)</label>
                                <select name="customer_id" class="form-select" id="customerSelect">
                                    <option value="">-- เลือกลูกค้า (Select Customer) --</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" {% if invoice and invoice.customer_id==customer.id
                                        %}selected{% endif %}>
                                        {{ customer.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ชื่อลูกค้า (Customer Name) *</label>
                                <input type="text" name="cust_name" class="form-control"
                                    value="{{ invoice.cust_name if invoice else '' }}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ชื่อบริษัท (Company Name)</label>
                                <input type="text" name="company_name" class="form-control"
                                    value="{{ invoice.company_name if invoice else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">เบอร์โทรศัพท์ (Company Tel)</label>
                                <input type="text" name="company_tel" class="form-control"
                                    value="{{ invoice.company_tel if invoice else '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">เลขผู้เสียภาษี (Tax ID)</label>
                                <input type="text" name="company_taxid" class="form-control"
                                    value="{{ invoice.company_taxid if invoice else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ผู้ติดต่อ (Contact)</label>
                                <input type="text" name="company_contact" class="form-control"
                                    value="{{ invoice.company_contact if invoice else '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ที่อยู่บริษัท (Company Address)</label>
                            <textarea name="company_address" class="form-control"
                                rows="3">{{ invoice.company_address if invoice else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">รายละเอียดการเดินทาง (Travel Details)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">จำนวนผู้เดินทาง (Total Pax) *</label>
                                <input type="number" name="total_pax" class="form-control" min="0"
                                    value="{{ invoice.total_pax if invoice else 0 }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">วันที่เดินทางมา (Arrival Date)</label>
                                <input type="date" name="arrival_date" class="form-control"
                                    value="{{ invoice.arrival_date.strftime('%Y-%m-%d') if invoice and invoice.arrival_date else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">วันที่เดินทางกลับ (Departure Date)</label>
                                <input type="date" name="departure_date" class="form-control"
                                    value="{{ invoice.departure_date.strftime('%Y-%m-%d') if invoice and invoice.departure_date else '' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รายชื่อผู้เดินทาง (Guest List)</label>
                            <textarea name="guest_list" class="form-control" rows="4"
                                placeholder="กรอกรายชื่อผู้เดินทาง ทีละบรรทัด">{{ invoice.guest_list if invoice else '' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ข้อมูลเที่ยวบิน (Flight Info)</label>
                            <textarea name="flight_info" class="form-control" rows="3"
                                placeholder="รายละเอียดเที่ยวบิน">{{ invoice.flight_info if invoice else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">รายละเอียดทางการเงิน (Financial Details)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ค่าตั๋วเครื่องบิน (Air Ticket Cost - THB)</label>
                            <input type="number" name="air_ticket_cost" class="form-control" step="0.01" min="0"
                                value="{{ invoice.air_ticket_cost if invoice else 0 }}" id="airTicketCost">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ค่าพาหนะ (Transportation Fee - THB)</label>
                            <input type="number" name="transportation_fee" class="form-control" step="0.01" min="0"
                                value="{{ invoice.transportation_fee if invoice else 0 }}" id="transportationFee">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ค่าใช้จ่ายล่วงหน้า (Advance Expense - THB)</label>
                            <input type="number" name="advance_expense" class="form-control" step="0.01" min="0"
                                value="{{ invoice.advance_expense if invoice else 0 }}" id="advanceExpense">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ค่าทัวร์ (Tour Fee - THB)</label>
                            <input type="number" name="tour_fee" class="form-control" step="0.01" min="0"
                                value="{{ invoice.tour_fee if invoice else 0 }}" id="tourFee">
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label">ภาษีมูลค่าเพิ่ม (VAT - THB)</label>
                            <input type="number" name="vat" class="form-control" step="0.01" min="0"
                                value="{{ invoice.vat if invoice else 0 }}" id="vat">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ภาษีหัก ณ ที่จ่าย (Withholding Tax - THB)</label>
                            <input type="number" name="withholding_tax" class="form-control" step="0.01" min="0"
                                value="{{ invoice.withholding_tax if invoice else 0 }}" id="withholdingTax">
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label"><strong>รวมค่าทัวร์ทั้งหมด (Total Tour Fee - THB)</strong></label>
                            <input type="number" name="total_tour_fee" class="form-control" step="0.01" min="0"
                                value="{{ invoice.total_tour_fee if invoice else 0 }}" id="totalTourFee" readonly>
                            <small class="text-muted">คำนวณอัตโนมัติ (Auto-calculated)</small>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-info btn-lg">
                        <i class="fas fa-save me-2"></i>{% if invoice %}อัพเดท (Update){% else %}สร้าง (Create){% endif
                        %} Invoice
                    </button>
                    <a href="{{ url_for('account_report.thai_invoice_list') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>ยกเลิก (Cancel)
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Auto-calculate total
    function calculateTotal() {
        const airTicket = parseFloat(document.getElementById('airTicketCost').value) || 0;
        const transportation = parseFloat(document.getElementById('transportationFee').value) || 0;
        const advance = parseFloat(document.getElementById('advanceExpense').value) || 0;
        const tourFee = parseFloat(document.getElementById('tourFee').value) || 0;
        const vat = parseFloat(document.getElementById('vat').value) || 0;
        const withholdingTax = parseFloat(document.getElementById('withholdingTax').value) || 0;

        const total = airTicket + transportation + advance + tourFee + vat - withholdingTax;
        document.getElementById('totalTourFee').value = total.toFixed(2);
    }

    // Add event listeners
    document.getElementById('airTicketCost').addEventListener('input', calculateTotal);
    document.getElementById('transportationFee').addEventListener('input', calculateTotal);
    document.getElementById('advanceExpense').addEventListener('input', calculateTotal);
    document.getElementById('tourFee').addEventListener('input', calculateTotal);
    document.getElementById('vat').addEventListener('input', calculateTotal);
    document.getElementById('withholdingTax').addEventListener('input', calculateTotal);

    // Calculate on page load
    calculateTotal();
</script>
{% endblock %}