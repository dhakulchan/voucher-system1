<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Auto Completion Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-card.success {
            border-left-color: #28a745;
        }

        .status-card.warning {
            border-left-color: #ffc107;
        }

        .status-card.danger {
            border-left-color: #dc3545;
        }

        .booking-table {
            font-size: 0.9rem;
        }

        .refresh-btn {
            position: relative;
        }

        .refresh-btn.loading {
            color: transparent;
        }

        .refresh-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border-radius: 50%;
            border: 2px solid #ccc;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-robot"></i> Booking Auto Completion Dashboard</h1>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <a href="{{ url_for('booking.list') }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Bookings
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card" id="status-today">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">Eligible Today</h6>
                                <h4 class="mb-0" id="eligible-count">-</h4>
                            </div>
                            <div>
                                <i class="fas fa-calendar-check fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card" id="status-upcoming">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">Upcoming (7 days)</h6>
                                <h4 class="mb-0" id="upcoming-count">-</h4>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card success" id="status-system">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">System Status</h6>
                                <h6 class="mb-0" id="system-status">Active</h6>
                            </div>
                            <div>
                                <i class="fas fa-heartbeat fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">Last Updated</h6>
                                <small class="text-muted" id="last-update">-</small>
                            </div>
                            <div>
                                <i class="fas fa-history fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="runAutoCompletion()">
                                    <i class="fas fa-play"></i> Run Auto Completion Now
                                </button>
                                <small class="text-muted">Process all eligible bookings immediately</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-info w-100" onclick="loadEligibleBookings()">
                                    <i class="fas fa-list"></i> View Eligible Bookings
                                </button>
                                <small class="text-muted">Show bookings eligible today</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="loadUpcomingCompletions()">
                                    <i class="fas fa-eye"></i> Preview Upcoming
                                </button>
                                <small class="text-muted">Preview next 7 days</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-table"></i> <span id="results-title">Bookings</span></h5>
                    </div>
                    <div class="card-body">
                        <div id="results-container">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <p>Select an action above to view results</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Dashboard functionality
        let lastUpdate = new Date();

        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading...</p>
                </div>
            `;
        }

        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error: ${message}
                </div>
            `;
        }

        function updateLastUpdate() {
            lastUpdate = new Date();
            document.getElementById('last-update').textContent = lastUpdate.toLocaleString();
        }

        function loadSystemStatus() {
            fetch('/admin/auto-completion/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('eligible-count').textContent = data.data.eligible_today;
                        document.getElementById('upcoming-count').textContent = data.data.upcoming_7_days;
                        document.getElementById('system-status').textContent = data.data.system_active ? 'Active' : 'Inactive';

                        // Update card colors based on counts
                        const todayCard = document.getElementById('status-today');
                        todayCard.className = `card status-card ${data.data.eligible_today > 0 ? 'warning' : 'success'}`;

                        updateLastUpdate();
                    }
                })
                .catch(error => {
                    console.error('Error loading system status:', error);
                });
        }

        function runAutoCompletion() {
            if (!confirm('Are you sure you want to run auto completion now? This will update eligible bookings to "Completed" status.')) {
                return;
            }

            const button = event.target;
            button.classList.add('loading');
            button.disabled = true;

            fetch('/admin/auto-completion/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    button.classList.remove('loading');
                    button.disabled = false;

                    if (data.success) {
                        showResults('Completion Results', data.data.results, 'completion');
                        loadSystemStatus(); // Refresh status
                        alert(`Completion finished: ${data.data.successful} successful, ${data.data.failed} failed`);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    button.classList.remove('loading');
                    button.disabled = false;
                    alert('Error: ' + error.message);
                });
        }

        function loadEligibleBookings() {
            showLoading('results-container');
            document.getElementById('results-title').textContent = 'Eligible Bookings (Today)';

            fetch('/admin/auto-completion/eligible')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showResults('Eligible Bookings', data.data, 'eligible');
                    } else {
                        showError('results-container', data.error);
                    }
                })
                .catch(error => {
                    showError('results-container', error.message);
                });
        }

        function loadUpcomingCompletions() {
            showLoading('results-container');
            document.getElementById('results-title').textContent = 'Upcoming Completions (7 Days)';

            fetch('/admin/auto-completion/preview?days=7')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showResults('Upcoming Completions', data.data, 'upcoming');
                    } else {
                        showError('results-container', data.error);
                    }
                })
                .catch(error => {
                    showError('results-container', error.message);
                });
        }

        function showResults(title, data, type) {
            let html = '';

            if (type === 'eligible') {
                if (data.length === 0) {
                    html = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No bookings eligible for completion today.</div>';
                } else {
                    html = `
                        <div class="table-responsive">
                            <table class="table table-striped booking-table">
                                <thead>
                                    <tr>
                                        <th>Booking Ref</th>
                                        <th>Status</th>
                                        <th>Departure Date</th>
                                        <th>Amount</th>
                                        <th>Customer ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.forEach(booking => {
                        html += `
                            <tr>
                                <td><strong>${booking.booking_reference}</strong></td>
                                <td><span class="badge bg-warning">${booking.status}</span></td>
                                <td>${booking.departure_date || 'N/A'}</td>
                                <td>${booking.total_amount} ${booking.currency}</td>
                                <td>${booking.customer_id}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                }
            } else if (type === 'upcoming') {
                if (data.length === 0) {
                    html = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No upcoming completions in the next 7 days.</div>';
                } else {
                    data.forEach(candidate => {
                        html += `
                            <div class="mb-3">
                                <h6><i class="fas fa-calendar"></i> Completion Date: ${candidate.completion_date} (Departure: ${candidate.departure_date})</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Booking Ref</th>
                                                <th>Status</th>
                                                <th>Customer ID</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        candidate.bookings.forEach(booking => {
                            html += `
                                <tr>
                                    <td><strong>${booking.reference}</strong></td>
                                    <td><span class="badge bg-info">${booking.status}</span></td>
                                    <td>${booking.customer_id}</td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table></div></div>';
                    });
                }
            } else if (type === 'completion') {
                if (data.length === 0) {
                    html = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No bookings were processed.</div>';
                } else {
                    html = `
                        <div class="table-responsive">
                            <table class="table table-striped booking-table">
                                <thead>
                                    <tr>
                                        <th>Booking Ref</th>
                                        <th>Departure Date</th>
                                        <th>Status</th>
                                        <th>Result</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.forEach(result => {
                        const statusBadge = result.success ?
                            '<span class="badge bg-success">Success</span>' :
                            '<span class="badge bg-danger">Failed</span>';
                        html += `
                            <tr>
                                <td><strong>${result.booking_reference}</strong></td>
                                <td>${result.departure_date || 'N/A'}</td>
                                <td><span class="badge bg-secondary">${result.old_status}</span></td>
                                <td>${statusBadge}</td>
                                <td class="small">${result.message}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                }
            }

            document.getElementById('results-container').innerHTML = html;
        }

        function refreshDashboard() {
            loadSystemStatus();
            document.getElementById('results-container').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>Dashboard refreshed. Select an action above to view results.</p>
                </div>
            `;
            document.getElementById('results-title').textContent = 'Bookings';
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', function () {
            loadSystemStatus();
        });

        // Auto refresh every 5 minutes
        setInterval(loadSystemStatus, 300000);
    </script>
</body>

</html>