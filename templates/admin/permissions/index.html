{% extends "base.html" %}

{% block title %}Permission Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="fas fa-user-shield me-2"></i>Permission Management
        </h1>
    </div>

    <div class="row">
        <!-- Role Permissions -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Role Permissions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">กำหนดสิทธิ์เริ่มต้นสำหรับแต่ละ Role</p>

                    <div class="list-group">
                        {% for role in roles %}
                        <a href="{{ url_for('permissions.view_role', role=role.role) }}"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge {{ get_role_badge(role.role) }} me-2">{{ role.role }}</span>
                                <br>
                                <small class="text-muted">{{ role.description }}</small>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- User-Specific Permissions -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-user-cog me-2"></i>User-Specific Permissions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">กำหนดสิทธิ์พิเศษสำหรับผู้ใช้แต่ละคน</p>

                    <div class="mb-3">
                        <input type="text" id="userSearch" class="form-control" placeholder="ค้นหาผู้ใช้...">
                    </div>

                    <div class="list-group" style="max-height: 600px; overflow-y: auto;">
                        {% for user in users %}
                        <a href="{{ url_for('permissions.view_user', user_id=user.id) }}"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center user-item"
                            data-username="{{ user.username }}" data-email="{{ user.email }}">
                            <div>
                                <strong>{{ user.username }}</strong>
                                <span class="badge {{ get_role_badge(user.role) }} ms-2">{{ user.role }}</span>
                                {% if user.custom_permissions %}
                                <span class="badge bg-warning text-dark ms-1">
                                    <i class="fas fa-star"></i> Custom
                                </span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ user.email }}</small>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Permission Guide -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Permission System Guide
                    </h5>
                </div>
                <div class="card-body">
                    <h6>วิธีการทำงาน:</h6>
                    <ul>
                        <li><strong>Role Permissions:</strong> สิทธิ์เริ่มต้นสำหรับทุกคนใน Role นั้นๆ</li>
                        <li><strong>User-Specific Permissions:</strong> สิทธิ์พิเศษสำหรับผู้ใช้แต่ละคน (จะแทนที่ Role
                            Permissions)</li>
                        <li>ระบบจะใช้ User-Specific Permissions ก่อน หากไม่มีจะใช้ Role Permissions</li>
                    </ul>

                    <h6 class="mt-4">Permission Modules:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><code>sidebar_menus</code> - รายการเมนูที่เห็นใน Sidebar</li>
                                <li><code>bookings</code> - จัดการการจอง (view_all, view_own, create, edit_all,
                                    edit_own, delete)</li>
                                <li><code>customers</code> - จัดการลูกค้า (view_all, view_own, create, edit_all,
                                    edit_own, delete)</li>
                                <li><code>quotes</code> - ใบเสนอราคา (view, create, edit, delete)</li>
                                <li><code>vouchers</code> - ใบบัตรทัวร์ (view, create, edit, delete)</li>
                                <li><code>suppliers</code> - ผู้จัดหา (view, create, edit, delete)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><code>invoices</code> - ใบแจ้งหนี้ (view, create, edit, delete)</li>
                                <li><code>reports</code> - รายงาน (view, export)</li>
                                <li><code>users</code> - จัดการผู้ใช้ (view, create, edit, delete, manage_roles,
                                    manage_permissions)</li>
                                <li><code>financial</code> - ข้อมูลการเงิน (view, edit)</li>
                                <li><code>admin_notes</code> - โน้ตแอดมิน (view, edit)</li>
                                <li><code>system</code> - ตั้งค่าระบบ (configure)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // User search functionality
    document.getElementById('userSearch').addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const userItems = document.querySelectorAll('.user-item');

        userItems.forEach(item => {
            const username = item.dataset.username.toLowerCase();
            const email = item.dataset.email.toLowerCase();

            if (username.includes(searchTerm) || email.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>

{% endblock %}