{% extends "base.html" %}

{% block title %}Edit Role Permissions - {{ role }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="fas fa-user-shield me-2"></i>Edit Role Permissions:
            <span class="badge {{ get_role_badge(role) }}">{{ role }}</span>
        </h1>
        <a href="{{ url_for('permissions.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form id="rolePermissionForm" method="POST" action="{{ url_for('permissions.update_role', role=role) }}">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Role Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Role Name</label>
                            <input type="text" class="form-control" value="{{ role }}" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control"
                                rows="2">{{ role_perms.description }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Menus -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-bars me-2"></i>Sidebar Menus</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% set available_menus = [
                            ('dashboard', 'Dashboard', 'tachometer-alt'),
                            ('queue_management', 'Queue Management', 'list-ol'),
                            ('bookings', 'Bookings', 'calendar-check'),
                            ('customers', 'Customers', 'users'),
                            ('quotes', 'Quotes', 'file-alt'),
                            ('vouchers', 'Vouchers', 'ticket-alt'),
                            ('suppliers', 'Suppliers', 'truck-loading'),
                            ('invoices', 'Invoices', 'file-invoice'),
                            ('reports', 'Reports', 'chart-bar'),
                            ('task_list', 'Task List', 'tasks'),
                            ('user_management', 'User Management', 'users-cog'),
                            ('system_settings', 'System Settings', 'cog')
                            ] %}
                            {% for menu_id, menu_name, menu_icon in available_menus %}
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sidebar_menus[]"
                                        value="{{ menu_id }}" id="menu_{{ menu_id }}" {% if menu_id in
                                        role_perms.permissions.get('sidebar_menus', []) %}checked{% endif %}>
                                    <label class="form-check-label" for="menu_{{ menu_id }}">
                                        <i class="fas fa-{{ menu_icon }} me-1"></i>{{ menu_name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Bookings Permissions -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Bookings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% set bookings_perms = role_perms.permissions.get('bookings', {}) %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bookings_view_all"
                                        value="true" id="bookings_view_all" {% if bookings_perms.get('view_all')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="bookings_view_all">View All</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bookings_view_own"
                                        value="true" id="bookings_view_own" {% if bookings_perms.get('view_own')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="bookings_view_own">View Own</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bookings_create" value="true"
                                        id="bookings_create" {% if bookings_perms.get('create') %}checked{% endif %}>
                                    <label class="form-check-label" for="bookings_create">Create</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bookings_edit_all"
                                        value="true" id="bookings_edit_all" {% if bookings_perms.get('edit_all')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="bookings_edit_all">Edit All</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bookings_edit_own"
                                        value="true" id="bookings_edit_own" {% if bookings_perms.get('edit_own')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="bookings_edit_own">Edit Own</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="bookings_delete" value="true"
                                        id="bookings_delete" {% if bookings_perms.get('delete') %}checked{% endif %}>
                                    <label class="form-check-label" for="bookings_delete">Delete</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customers Permissions -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Customers</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% set customers_perms = role_perms.permissions.get('customers', {}) %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="customers_view_all"
                                        value="true" id="customers_view_all" {% if customers_perms.get('view_all')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="customers_view_all">View All</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="customers_view_own"
                                        value="true" id="customers_view_own" {% if customers_perms.get('view_own')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="customers_view_own">View Own</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="customers_create" value="true"
                                        id="customers_create" {% if customers_perms.get('create') %}checked{% endif %}>
                                    <label class="form-check-label" for="customers_create">Create</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="customers_edit_all"
                                        value="true" id="customers_edit_all" {% if customers_perms.get('edit_all')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="customers_edit_all">Edit All</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="customers_edit_own"
                                        value="true" id="customers_edit_own" {% if customers_perms.get('edit_own')
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="customers_edit_own">Edit Own</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="customers_delete" value="true"
                                        id="customers_delete" {% if customers_perms.get('delete') %}checked{% endif %}>
                                    <label class="form-check-label" for="customers_delete">Delete</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Module Permissions (Compact View) -->
                {% set modules = [
                ('quotes', 'Quotes', 'file-alt', 'warning'),
                ('vouchers', 'Vouchers', 'ticket-alt', 'success'),
                ('suppliers', 'Suppliers', 'truck-loading', 'secondary'),
                ('invoices', 'Invoices', 'file-invoice', 'primary'),
                ('reports', 'Reports', 'chart-bar', 'info')
                ] %}

                {% for module_id, module_name, module_icon, module_color in modules %}
                <div class="card shadow mb-4">
                    <div class="card-header bg-{{ module_color }} text-white">
                        <h5 class="mb-0"><i class="fas fa-{{ module_icon }} me-2"></i>{{ module_name }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% set module_perms = role_perms.permissions.get(module_id, {}) %}
                            {% if module_id in ['quotes', 'vouchers', 'suppliers', 'invoices'] %}
                            {% for action in ['view', 'create', 'edit', 'delete'] %}
                            <div class="col-md-3 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="{{ module_id }}_{{ action }}"
                                        value="true" id="{{ module_id }}_{{ action }}" {% if module_perms.get(action)
                                        %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ module_id }}_{{ action }}">{{
                                        action|capitalize }}</label>
                                </div>
                            </div>
                            {% endfor %}
                            {% elif module_id == 'reports' %}
                            <div class="col-md-3 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="reports_view" value="true"
                                        id="reports_view" {% if module_perms.get('view') %}checked{% endif %}>
                                    <label class="form-check-label" for="reports_view">View</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="reports_export" value="true"
                                        id="reports_export" {% if module_perms.get('export') %}checked{% endif %}>
                                    <label class="form-check-label" for="reports_export">Export</label>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- User Management & System -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>User Management & System</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-3">User Management</h6>
                        <div class="row mb-3">
                            {% set users_perms = role_perms.permissions.get('users', {}) %}
                            {% for action in ['view', 'create', 'edit', 'delete', 'manage_roles', 'manage_permissions']
                            %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="users_{{ action }}"
                                        value="true" id="users_{{ action }}" {% if users_perms.get(action) %}checked{%
                                        endif %}>
                                    <label class="form-check-label" for="users_{{ action }}">{{ action|replace('_', '
                                        ')|title }}</label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <h6 class="mb-3 mt-4">Financial</h6>
                        <div class="row mb-3">
                            {% set financial_perms = role_perms.permissions.get('financial', {}) %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="financial_view" value="true"
                                        id="financial_view" {% if financial_perms.get('view') %}checked{% endif %}>
                                    <label class="form-check-label" for="financial_view">View</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="financial_edit" value="true"
                                        id="financial_edit" {% if financial_perms.get('edit') %}checked{% endif %}>
                                    <label class="form-check-label" for="financial_edit">Edit</label>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4">Admin Notes</h6>
                        <div class="row mb-3">
                            {% set admin_notes_perms = role_perms.permissions.get('admin_notes', {}) %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="admin_notes_view" value="true"
                                        id="admin_notes_view" {% if admin_notes_perms.get('view') %}checked{% endif %}>
                                    <label class="form-check-label" for="admin_notes_view">View</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="admin_notes_edit" value="true"
                                        id="admin_notes_edit" {% if admin_notes_perms.get('edit') %}checked{% endif %}>
                                    <label class="form-check-label" for="admin_notes_edit">Edit</label>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4">System Configuration</h6>
                        <div class="row">
                            {% set system_perms = role_perms.permissions.get('system', {}) %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="system_configure" value="true"
                                        id="system_configure" {% if system_perms.get('configure') %}checked{% endif %}>
                                    <label class="form-check-label" for="system_configure">Configure</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>

        <div class="col-lg-4">
            <!-- Users with this role -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Users with this Role</h5>
                </div>
                <div class="card-body">
                    {% if users_with_role %}
                    <ul class="list-group list-group-flush">
                        {% for user in users_with_role %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ user.username }}</strong>
                                <br>
                                <small class="text-muted">{{ user.email }}</small>
                            </div>
                            {% if user.custom_permissions %}
                            <span class="badge bg-warning text-dark">Custom</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center">No users with this role</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('rolePermissionForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Role permissions updated successfully!');
                    window.location.href = '{{ url_for("permissions.index") }}';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    });
</script>

{% endblock %}