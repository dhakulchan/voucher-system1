{% extends "base.html" %}

{% block title %}Media Manager - Queue Display{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        margin: -20px -20px 30px -20px;
        border-radius: 8px;
    }

    .media-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }

    .media-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .media-preview {
        width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .media-type-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 25px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #764ba2;
        background: #f0f2ff;
    }

    .upload-area.drag-over {
        border-color: #764ba2;
        background: #e8ebff;
        transform: scale(1.02);
    }

    .nav-tabs .nav-link {
        color: #667eea;
        font-weight: 600;
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .youtube-preview {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .youtube-preview iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="mb-2"><i class="fas fa-photo-video"></i> จัดการสื่อสำหรับหน้า Queue Display</h1>
    <p class="mb-0">อัปโหลดและจัดการภาพ/วีดีโอที่แสดงในหน้าจอแสดงคิว</p>
</div>

<!-- Upload Section -->
<div class="media-card">
    <h3 class="mb-4"><i class="fas fa-cloud-upload-alt"></i> อัปโหลดสื่อใหม่</h3>

    <!-- Tabs for Upload Methods -->
    <ul class="nav nav-tabs mb-3" id="uploadTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-upload"
                type="button" role="tab">
                <i class="fas fa-file-upload"></i> อัปโหลดไฟล์
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="youtube-tab" data-bs-toggle="tab" data-bs-target="#youtube-upload"
                type="button" role="tab">
                <i class="fab fa-youtube"></i> YouTube URL
            </button>
        </li>
    </ul>

    <div class="tab-content" id="uploadTabContent">
        <!-- File Upload Tab -->
        <div class="tab-pane fade show active" id="file-upload" role="tabpanel">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: #667eea;"></i>
                    <h4>คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวาง</h4>
                    <p class="text-muted">รองรับ: JPG, PNG, GIF, MP4, WebM (ขนาดไม่เกิน 50MB)</p>
                    <input type="file" id="mediaFile" name="file" accept="image/*,video/*" style="display: none;">
                    <button type="button" class="btn btn-primary-custom mt-3"
                        onclick="document.getElementById('mediaFile').click()">
                        <i class="fas fa-folder-open"></i> เลือกไฟล์
                    </button>
                </div>

                <div id="filePreview" style="display: none; margin-top: 20px;">
                    <h5>ตัวอย่าง:</h5>
                    <div id="previewContainer"></div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <label class="form-label">ชื่อเรื่อง *</label>
                        <input type="text" class="form-control" id="mediaTitle" required>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">คำอธิบาย</label>
                        <input type="text" class="form-control" id="mediaDescription">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <label class="form-label">ระยะเวลาแสดง (วินาที)</label>
                        <input type="number" class="form-control" id="mediaDuration" value="10" min="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ลำดับการแสดง</label>
                        <input type="number" class="form-control" id="displayOrder" value="0" min="0">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary-custom mt-4">
                    <i class="fas fa-upload"></i> อัปโหลด
                </button>
            </form>
        </div>

        <!-- YouTube URL Tab -->
        <div class="tab-pane fade" id="youtube-upload" role="tabpanel">
            <form id="youtubeForm">
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label">YouTube URL *</label>
                        <input type="url" class="form-control" id="youtubeUrl"
                            placeholder="https://www.youtube.com/watch?v=..." required>
                        <small class="text-muted">วาง URL ของวีดีโอ YouTube ที่ต้องการแสดง</small>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <label class="form-label">ชื่อเรื่อง *</label>
                        <input type="text" class="form-control" id="youtubeTitle" required>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">คำอธิบาย</label>
                        <input type="text" class="form-control" id="youtubeDescription">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <label class="form-label">ระยะเวลาแสดง (วินาที)</label>
                        <input type="number" class="form-control" id="youtubeDuration" value="15" min="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ลำดับการแสดง</label>
                        <input type="number" class="form-control" id="youtubeDisplayOrder" value="0" min="0">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary-custom mt-4">
                    <i class="fab fa-youtube"></i> เพิ่ม YouTube Video
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Media List -->
<div class="media-card">
    <h3 class="mb-4"><i class="fas fa-list"></i> สื่อทั้งหมด</h3>
    <div id="mediaList" class="media-grid">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">แก้ไขสื่อ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editMediaId">
                    <div class="mb-3">
                        <label class="form-label">ชื่อเรื่อง</label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">คำอธิบาย</label>
                        <input type="text" class="form-control" id="editDescription">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ระยะเวลาแสดง (วินาที)</label>
                        <input type="number" class="form-control" id="editDuration" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ลำดับการแสดง</label>
                        <input type="number" class="form-control" id="editOrder" min="0">
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editActive">
                            <label class="form-check-label" for="editActive">เปิดใช้งาน</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveEdit()">บันทึก</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let editModal;

    document.addEventListener('DOMContentLoaded', function () {
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
        loadMedia();
        setupUploadHandlers();
    });

    function setupUploadHandlers() {
        // File upload
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('mediaFile');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            fileInput.files = e.dataTransfer.files;
            previewFile();
        });

        fileInput.addEventListener('change', previewFile);

        // Form submissions
        document.getElementById('uploadForm').addEventListener('submit', uploadFile);
        document.getElementById('youtubeForm').addEventListener('submit', uploadYoutube);
    }

    function previewFile() {
        const file = document.getElementById('mediaFile').files[0];
        if (!file) return;

        const preview = document.getElementById('filePreview');
        const container = document.getElementById('previewContainer');
        preview.style.display = 'block';

        if (file.type.startsWith('image/')) {
            container.innerHTML = `<img src="${URL.createObjectURL(file)}" class="media-preview">`;
        } else if (file.type.startsWith('video/')) {
            container.innerHTML = `<video src="${URL.createObjectURL(file)}" class="media-preview" controls></video>`;
        }
    }

    async function uploadFile(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('file', document.getElementById('mediaFile').files[0]);
        formData.append('title', document.getElementById('mediaTitle').value);
        formData.append('description', document.getElementById('mediaDescription').value);
        formData.append('duration', document.getElementById('mediaDuration').value);
        formData.append('display_order', document.getElementById('displayOrder').value);

        try {
            const response = await fetch('/queue/api/media', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                alert('อัปโหลดสำเร็จ!');
                document.getElementById('uploadForm').reset();
                document.getElementById('filePreview').style.display = 'none';
                loadMedia();
            } else {
                alert('เกิดข้อผิดพลาด: ' + result.error);
            }
        } catch (error) {
            alert('เกิดข้อผิดพลาด: ' + error.message);
        }
    }

    async function uploadYoutube(e) {
        e.preventDefault();

        const data = {
            media_type: 'youtube',
            youtube_url: document.getElementById('youtubeUrl').value,
            title: document.getElementById('youtubeTitle').value,
            description: document.getElementById('youtubeDescription').value,
            duration: document.getElementById('youtubeDuration').value,
            display_order: document.getElementById('youtubeDisplayOrder').value
        };

        try {
            const response = await fetch('/queue/api/media', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('เพิ่ม YouTube Video สำเร็จ!');
                document.getElementById('youtubeForm').reset();
                loadMedia();
            } else {
                alert('เกิดข้อผิดพลาด: ' + result.error);
            }
        } catch (error) {
            alert('เกิดข้อผิดพลาด: ' + error.message);
        }
    }

    async function loadMedia() {
        try {
            const response = await fetch('/queue/api/media/all');
            const data = await response.json();

            if (data.success) {
                renderMedia(data.media);
            }
        } catch (error) {
            console.error('Error loading media:', error);
        }
    }

    function renderMedia(mediaList) {
        const container = document.getElementById('mediaList');

        if (mediaList.length === 0) {
            container.innerHTML = '<div class="text-center py-5"><p class="text-muted">ยังไม่มีสื่อ</p></div>';
            return;
        }

        container.innerHTML = mediaList.map(media => {
            let preview = '';
            if (media.media_type === 'image') {
                preview = `<img src="${media.file_path}" class="media-preview" alt="${media.title}">`;
            } else if (media.media_type === 'video') {
                preview = `<video src="${media.file_path}" class="media-preview" controls></video>`;
            } else if (media.media_type === 'youtube') {
                const videoId = media.youtube_url.match(/[?&]v=([^&]+)/)?.[1];
                preview = `
                    <div class="youtube-preview">
                        <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                    </div>`;
            }

            return `
                <div class="media-card">
                    <div class="position-relative">
                        ${preview}
                        <span class="media-type-badge badge bg-${media.is_active ? 'success' : 'secondary'}">
                            ${media.is_active ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}
                        </span>
                    </div>
                    <h5>${media.title}</h5>
                    ${media.description ? `<p class="text-muted small">${media.description}</p>` : ''}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> ${media.duration}s | 
                            <i class="fas fa-sort-numeric-down"></i> ${media.display_order}
                        </small>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="editMedia(${media.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMedia(${media.id}, '${media.title}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function editMedia(id) {
        try {
            const response = await fetch('/queue/api/media/all');
            const data = await response.json();
            const media = data.media.find(m => m.id === id);

            if (media) {
                document.getElementById('editMediaId').value = media.id;
                document.getElementById('editTitle').value = media.title;
                document.getElementById('editDescription').value = media.description || '';
                document.getElementById('editDuration').value = media.duration;
                document.getElementById('editOrder').value = media.display_order;
                document.getElementById('editActive').checked = media.is_active;
                editModal.show();
            }
        } catch (error) {
            alert('เกิดข้อผิดพลาด: ' + error.message);
        }
    }

    async function saveEdit() {
        const id = document.getElementById('editMediaId').value;
        const data = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            duration: document.getElementById('editDuration').value,
            display_order: document.getElementById('editOrder').value,
            is_active: document.getElementById('editActive').checked
        };

        try {
            const response = await fetch(`/queue/api/media/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('บันทึกสำเร็จ!');
                editModal.hide();
                loadMedia();
            } else {
                alert('เกิดข้อผิดพลาด: ' + result.error);
            }
        } catch (error) {
            alert('เกิดข้อผิดพลาด: ' + error.message);
        }
    }

    async function deleteMedia(id, title) {
        if (!confirm(`ยืนยันการลบ "${title}"?`)) return;

        try {
            const response = await fetch(`/queue/api/media/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (result.success) {
                alert('ลบสำเร็จ!');
                loadMedia();
            } else {
                alert('เกิดข้อผิดพลาด: ' + result.error);
            }
        } catch (error) {
            alert('เกิดข้อผิดพลาด: ' + error.message);
        }
    }
</script>
{% endblock %}