{% extends "base.html" %}

{% block title %}Queue History{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-history me-2"></i>Queue History</h2>
            <p class="text-muted">ประวัติการใช้งานคิวย้อนหลัง</p>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter By Date</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" value="">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" value="">
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="waiting">Waiting</option>
                                <option value="serving">Serving</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label d-block">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadHistory()">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDateRange('today')">
                                วันนี้
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDateRange('yesterday')">
                                เมื่อวาน
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDateRange('week')">
                                สัปดาห์นี้
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDateRange('lastWeek')">
                                สัปดาห์ที่แล้ว
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDateRange('month')">
                                เดือนนี้
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="setDateRange('lastMonth')">
                                เดือนที่แล้ว
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4" id="statsSection" style="display: none;">
        <div class="col-md-3">
            <div class="card bg-info text-white shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-list me-2"></i>Total Queues</h5>
                    <h2 class="mb-0" id="totalQueues">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-check-circle me-2"></i>Completed</h5>
                    <h2 class="mb-0" id="completedQueues">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-times-circle me-2"></i>Cancelled</h5>
                    <h2 class="mb-0" id="cancelledQueues">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-clock me-2"></i>Avg Wait Time</h5>
                    <h2 class="mb-0" id="avgWaitTime">0 min</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Queue History Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Queue Records</h5>
                    <button class="btn btn-sm btn-light" onclick="exportToCSV()">
                        <i class="fas fa-download me-2"></i>Export CSV
                    </button>
                </div>
                <div class="card-body">
                    <div id="loadingMessage" class="text-center p-5">
                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                        <p class="text-muted">กรุณาเลือกช่วงเวลาเพื่อดูประวัติ</p>
                    </div>
                    <div id="tableContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="historyTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Queue #</th>
                                        <th>Customer</th>
                                        <th>Phone</th>
                                        <th>Service</th>
                                        <th>Status</th>
                                        <th>Counter</th>
                                        <th>Created</th>
                                        <th>Wait Time</th>
                                        <th>Service Time</th>
                                        <th>Total Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-md-12">
            <a href="{{ url_for('queue.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>กลับไปหน้า Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    // Set default dates
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    });

    function setDateRange(range) {
        const today = new Date();
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');

        endDate.value = today.toISOString().split('T')[0];

        let start = new Date();

        switch (range) {
            case 'today':
                start = today;
                break;
            case 'yesterday':
                start.setDate(today.getDate() - 1);
                endDate.value = start.toISOString().split('T')[0];
                break;
            case 'week':
                start.setDate(today.getDate() - today.getDay());
                break;
            case 'lastWeek':
                const lastWeekEnd = new Date();
                lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                start.setDate(lastWeekEnd.getDate() - 6);
                endDate.value = lastWeekEnd.toISOString().split('T')[0];
                break;
            case 'month':
                start = new Date(today.getFullYear(), today.getMonth(), 1);
                break;
            case 'lastMonth':
                start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                endDate.value = lastMonthEnd.toISOString().split('T')[0];
                break;
        }

        startDate.value = start.toISOString().split('T')[0];
        loadHistory();
    }

    async function loadHistory() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = document.getElementById('statusFilter').value;

        if (!startDate || !endDate) {
            alert('กรุณาเลือกช่วงวันที่');
            return;
        }

        document.getElementById('loadingMessage').innerHTML = '<i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i><p>กำลังโหลดข้อมูล...</p>';
        document.getElementById('tableContainer').style.display = 'none';

        try {
            const response = await fetch(`/queue/api/queues?start_date=${startDate}&end_date=${endDate}`);
            const data = await response.json();

            if (data.success) {
                let queues = data.queues;

                // Filter by status if selected
                if (status) {
                    queues = queues.filter(q => q.status === status);
                }

                displayHistory(queues);
                updateStats(queues);
            } else {
                alert('Error loading history: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error loading history');
        }
    }

    function displayHistory(queues) {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';

        if (queues.length === 0) {
            document.getElementById('loadingMessage').innerHTML = '<i class="fas fa-inbox fa-3x text-muted mb-3"></i><p class="text-muted">ไม่พบข้อมูลในช่วงเวลาที่เลือก</p>';
            document.getElementById('tableContainer').style.display = 'none';
            return;
        }

        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';

        queues.forEach(queue => {
            const row = document.createElement('tr');

            const statusBadge = getStatusBadge(queue.status);
            const date = new Date(queue.created_at);

            row.innerHTML = `
                <td>${date.toLocaleDateString('th-TH')}</td>
                <td><strong>${queue.queue_number}</strong></td>
                <td>${queue.customer_name}</td>
                <td>${queue.customer_phone}</td>
                <td><span class="badge bg-secondary">${queue.service_type}</span></td>
                <td>${statusBadge}</td>
                <td>${queue.counter || '-'}</td>
                <td>${date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}</td>
                <td>${queue.waiting_time_minutes || '-'} ${queue.waiting_time_minutes ? 'min' : ''}</td>
                <td>${queue.service_time_minutes || '-'} ${queue.service_time_minutes ? 'min' : ''}</td>
                <td>${queue.total_time_minutes || '-'} ${queue.total_time_minutes ? 'min' : ''}</td>
                <td>
                    <a href="/queue/track/${queue.queue_number}" class="btn btn-sm btn-info" target="_blank">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    function getStatusBadge(status) {
        const badges = {
            'waiting': '<span class="badge bg-warning text-dark">Waiting</span>',
            'serving': '<span class="badge bg-success">Serving</span>',
            'completed': '<span class="badge bg-primary">Completed</span>',
            'cancelled': '<span class="badge bg-danger">Cancelled</span>'
        };
        return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function updateStats(queues) {
        document.getElementById('statsSection').style.display = 'flex';

        const completed = queues.filter(q => q.status === 'completed');
        const cancelled = queues.filter(q => q.status === 'cancelled');

        document.getElementById('totalQueues').textContent = queues.length;
        document.getElementById('completedQueues').textContent = completed.length;
        document.getElementById('cancelledQueues').textContent = cancelled.length;

        // Calculate average wait time
        const waitTimes = queues
            .filter(q => q.waiting_time_minutes)
            .map(q => q.waiting_time_minutes);

        const avgWait = waitTimes.length > 0
            ? Math.round(waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length)
            : 0;

        document.getElementById('avgWaitTime').textContent = avgWait + ' min';
    }

    function exportToCSV() {
        const table = document.getElementById('historyTable');
        let csv = [];

        // Get headers
        const headers = [];
        table.querySelectorAll('thead th').forEach(th => {
            headers.push(th.textContent);
        });
        csv.push(headers.join(','));

        // Get rows
        table.querySelectorAll('tbody tr').forEach(tr => {
            const row = [];
            tr.querySelectorAll('td').forEach((td, index) => {
                // Skip action column
                if (index < headers.length - 1) {
                    row.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
                }
            });
            csv.push(row.join(','));
        });

        // Download
        const csvContent = csv.join('\n');
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        link.setAttribute('href', url);
        link.setAttribute('download', `queue_history_${startDate}_to_${endDate}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

<style>
    .card {
        border-radius: 10px;
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }

    .btn {
        border-radius: 5px;
    }

    .table {
        font-size: 14px;
    }

    .badge {
        font-size: 12px;
        padding: 5px 10px;
    }

    #loadingMessage {
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
</style>
{% endblock %}