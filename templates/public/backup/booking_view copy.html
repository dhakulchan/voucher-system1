<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Booking {{ booking.booking_reference }} - Service Proposal</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --card-hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .booking-header {
            background: var(--primary-gradient);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .booking-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><linearGradient id="a" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="%23ffffff" stop-opacity="0.1"/><stop offset="1" stop-color="%23ffffff" stop-opacity="0"/></linearGradient></defs><polygon fill="url(%23a)" points="0,20 100,0 100,20"/></svg>');
            opacity: 0.3;
        }

        .booking-header .container {
            position: relative;
            z-index: 1;
        }

        .booking-card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            background: white;
            overflow: hidden;
        }

        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .card-header {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 1.5rem;
            font-weight: 600;
        }

        .download-btn {
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .download-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s;
        }

        .download-btn:hover:before {
            left: 100%;
        }

        .btn-download-png {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-download-pdf {
            background: linear-gradient(135deg, #4834d4, #686de0);
            color: white;
        }

        .security-notice {
            background: linear-gradient(135deg, #dff9fb, #c7ecee);
            border-left: 4px solid #00b894;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .info-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #007bff;
        }

        .badge-status {
            font-size: 0.9em;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .guest-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .share-btn {
            background: var(--success-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }

        @media (max-width: 768px) {
            .booking-header {
                padding: 2rem 0;
            }

            .booking-card {
                margin-bottom: 1rem;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="booking-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-ticket-alt me-3"></i>
                        {% if booking.status == 'quoted' %}QUOTE{% else %}Service Proposal{% endif %}
                    </h1>
                    <div class="d-flex align-items-center gap-3">
                        <h2 class="h3 mb-0">üìã {{ booking.booking_reference }}</h2>
                        {% if booking.status == 'quoted' and booking.quotes %}
                        {% for quote in booking.quotes %}
                        {% if loop.first %}
                        <h2 class="h3 mb-0 text-warning">üìÑ {{ quote.quote_number }}</h2>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% if booking.party_name or booking.party_code %}
                    <p class="mt-2 mb-0 opacity-75">
                        <i class="fas fa-users me-2"></i>
                        Party Name/Code: {{ booking.party_name or 'N/A' }}{% if booking.party_code %} ({{
                        booking.party_code }}){% endif %}
                    </p>
                    {% endif %}
                    {% if booking.booking_date %}
                    <p class="mt-2 mb-0 opacity-75">
                        <i class="fas fa-calendar me-2"></i>
                        {{ booking.booking_date.strftime('%d/%m/%Y') }}
                    </p>
                    {% endif %}
                </div>
                <div class="col-md-4 text-md-end">
                    <!-- Logo positioned above status badge -->
                    <div class="mb-2">
                        <img src="{{ url_for('static', filename='dcts-logo-vou.png') }}" alt="DCTS Logo"
                            class="img-fluid" style="max-height: 60px; width: auto;">
                    </div>
                    <span class="badge badge-status bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i>
                        {{ booking.status.title() }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container pb-5">
        <div class="row">
            <!-- Left Column: Booking Information -->
            <div class="col-lg-8">
                <!-- Customer Information -->
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-user me-2"></i>
                            Customer Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i class="fas fa-user me-2 text-primary"></i>Name:</strong><br>
                                    {{ booking.customer.name if booking.customer else 'N/A' }}
                                </div>
                                <div class="info-item">
                                    <strong><i class="fas fa-envelope me-2 text-primary"></i>Email:</strong><br>
                                    {{ booking.customer.email if booking.customer else 'N/A' }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i class="fas fa-phone me-2 text-primary"></i>Phone:</strong><br>
                                    {{ booking.customer.phone if booking.customer else 'N/A' }}
                                </div>
                                <div class="info-item">
                                    <strong><i class="fas fa-dollar-sign me-2 text-primary"></i>Total
                                        Amount:</strong><br>
                                    <span class="fw-bold text-success fs-5">
                                        {% if booking.total_amount %}
                                        ‡∏ø{{ "{:,.2f}".format(booking.total_amount) }}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Travel Information -->
                {% if booking.arrival_date or booking.departure_date %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-plane me-2"></i>
                            Travel Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i class="fas fa-plane-arrival me-2 text-success"></i>Arrival:</strong><br>
                                    {% if booking.arrival_date %}
                                    {{ booking.arrival_date.strftime('%d/%m/%Y') }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i
                                            class="fas fa-plane-departure me-2 text-danger"></i>Departure:</strong><br>
                                    {% if booking.departure_date %}
                                    {{ booking.departure_date.strftime('%d/%m/%Y') }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if booking.total_pax %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="info-item">
                                    <strong><i class="fas fa-users me-2 text-primary"></i>Passengers:</strong><br>
                                    <span class="fs-5">
                                        {% if booking.adults %}<i class="fas fa-user me-1"></i>{{ booking.adults }}
                                        Adults{% endif %}
                                        {% if booking.children %}<i class="fas fa-child ms-3 me-1"></i>{{
                                        booking.children }} Children{% endif %}
                                        {% if booking.infants %}<i class="fas fa-baby ms-3 me-1"></i>{{ booking.infants
                                        }} Infants{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Products & Calculation -->
                {% set products = booking.get_products() %}
                {% if products and products|length > 0 %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            Products & Calculation
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 8%;">No.</th>
                                        <th style="width: 40%;">Products</th>
                                        <th style="width: 15%;">Quantity</th>
                                        <th style="width: 18%;">Price</th>
                                        <th style="width: 19%;">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                    <tr>
                                        <td class="text-center">{{ loop.index }}</td>
                                        <td>{{ product.name or '' }}</td>
                                        <td class="text-center">{{ product.quantity or 1 }}</td>
                                        <td class="text-end">{{ "‡∏ø{:,.2f}".format(product.price|float) if product.price
                                            else '‡∏ø0.00' }}</td>
                                        <td class="text-end fw-bold">{{ "‡∏ø{:,.2f}".format(product.amount|float) if
                                            product.amount else '‡∏ø0.00' }}</td>
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-info">
                                        <td colspan="4" class="text-end fw-bold">Total:</td>
                                        <td class="text-end fw-bold fs-5">
                                            {% if booking.total_amount %}
                                            ‡∏ø{{ "{:,.2f}".format(booking.total_amount) }}
                                            {% else %}
                                            ‡∏ø0.00
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Description -->
                {% if booking.description %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Description
                        </h3>
                    </div>
                    <div class="card-body">
                        <div style="white-space: pre-line; line-height: 1.6;">
                            {{ booking.description | html_to_linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Guest List -->
                {% if booking.guest_list %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Guest List
                        </h3>
                    </div>
                    <div class="card-body">
                        <div style="white-space: pre-line; line-height: 1.6;">
                            {% set guest_data = booking.get_guest_list() %}
                            {% if guest_data %}
                            {% if guest_data is iterable and guest_data is not string %}
                            {% for guest in guest_data %}
                            {% if guest is mapping %}
                            {{ (guest.name or guest.get('name', 'N/A')) | replace('<br>', '\n') |
                            replace('<br />', '\n') | replace('<br />', '\n') | replace('</p>', '\n') | replace('<p>',
                                '') | safe }}{% if guest.age or
                                guest.get('age') %} (Age: {{ guest.age or guest.get('age') }}){% endif %}{% if
                                guest.nationality or guest.get('nationality') %} - {{ guest.nationality or
                                guest.get('nationality') }}{% endif %}
                                {% else %}
                                {{ guest | replace('<br>', '\n') | replace('<br />', '\n') |
                                replace('<br />', '\n') | replace('</p>', '\n') | replace('<p>', '') | safe }}
                                {% endif %}
                                {% if not loop.last %}<br>{% endif %}
                                {% endfor %}
                                {% else %}
                                {{ guest_data | html_to_linebreaks }}
                                {% endif %}
                                {% elif booking.guest_list %}
                                {{ booking.guest_list | html_to_linebreaks }}
                                {% else %}
                                No guest information available
                                {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column: Actions -->
            <div class="col-lg-4">
                <!-- Download Options -->
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-download me-2"></i>
                            Download Options
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-3">
                            {% if booking.status == 'quoted' and booking.quotes %}
                            <a href="{{ url_for('public.download_quote_png', token=token) }}"
                                class="download-btn btn-download-png" target="_blank">
                                <i class="fas fa-image me-2"></i>
                                Download Quote PNG
                            </a>
                            <a href="{{ url_for('public.download_quote_pdf', token=token) }}"
                                class="download-btn btn-download-pdf" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>
                                Download Quote PDF
                            </a>
                            {% else %}
                            <a href="{{ url_for('public.download_booking_png', token=token) }}"
                                class="download-btn btn-download-png" target="_blank">
                                <i class="fas fa-image me-2"></i>
                                Download PNG Image
                            </a>
                            <a href="{{ url_for('public.download_booking_pdf', token=token) }}"
                                class="download-btn btn-download-pdf" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>
                                Download PDF Document
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Security Notice -->
                <div class="security-notice">
                    <h5 class="text-success">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security Notice
                    </h5>
                    <p class="mb-2 small">
                        <i class="fas fa-clock me-2"></i>
                        This secure link expires after <strong>30 days</strong>
                    </p>
                    <p class="mb-0 small">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Please do not share this link with unauthorized persons
                    </p>
                </div>

                <!-- Share Options -->
                <div class="booking-card">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-share-alt me-2"></i>
                            Share Options
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button onclick="shareBooking()" class="btn share-btn">
                                <i class="fas fa-share me-2"></i>
                                Share Booking
                            </button>
                            <button onclick="copyBookingLink()" class="btn btn-outline-primary">
                                <i class="fas fa-copy me-2"></i>
                                Copy Link
                            </button>
                            <button onclick="shareToLine()" class="btn btn-outline-success">
                                <i class="fab fa-line me-2"></i>
                                Share to Line
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Why Choose Us Section -->
                <div class="booking-card mb-4">
                    <div class="card-header" style="padding: 1rem;">
                        <h4 class="mb-0" style="font-size: 1.1rem;">
                            <i class="fas fa-star me-2" style="font-size: 1rem;"></i>
                            ‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø
                        </h4>
                    </div>
                    <div class="card-body" style="padding: 1rem;">
                        <div class="why-choose-us">
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                1</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span style="font-size: 0.9rem; font-weight: 600;">‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
                                                License 11/03589</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                2</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span
                                                style="font-size: 0.9rem; font-weight: 600;">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤
                                                35 ‡∏õ‡∏µ</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                3</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span
                                                style="font-size: 0.9rem; font-weight: 600;">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                4</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span
                                                style="font-size: 0.9rem; font-weight: 600;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Ø</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                5</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span
                                                style="font-size: 0.9rem; font-weight: 600;">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                6</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span style="font-size: 0.9rem; font-weight: 600;">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
                                                ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡πÉ‡∏à</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start mb-2">
                                        <div class="flex-shrink-0 me-3" style="margin-top: 2px;">
                                            <div class="badge bg-primary rounded-pill"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                7</div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <span
                                                style="font-size: 0.85rem; font-weight: 600; line-height: 1.3;">‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
                                                'Self Service' ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                                                ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏≥‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
                                                ‡πÅ‡∏•‡∏∞‡∏°‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="col-md-4">
                <div class="booking-card sticky-top" style="top: 2rem;">
                    <div class="card-header text-center">
                        <h3 class="mb-0">
                            <i class="fas fa-phone me-2"></i>
                            Contact Us
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        <!-- Contact details will be here -->
                        <div class="contact-info">
                            <div class="mb-3">
                                <i class="fas fa-phone me-2 text-primary"></i>
                                <strong>Tel:</strong> +662 2744216
                            </div>
                            <div class="mb-3">
                                <i class="fas fa-envelope me-2 text-primary"></i>
                                <strong>Email:</strong> booking@dhakulchan.com
                            </div>
                            <div class="mb-3">
                                <i class="fab fa-line me-2 text-success"></i>
                                <strong>Line OA:</strong> @dhakulchan
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Enhanced sharing functions with loading states and better UX

        async function shareBooking() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<span class="loading-spinner me-2"></span>Sharing...';
                button.disabled = true;

                const shareData = {
                    title: 'üìã Booking {{ booking.booking_reference }}',
                    text: `üìã Service Proposal: {{ booking.booking_reference }}\nüîó View: ${window.location.href}\nüñºÔ∏è PNG: ${window.location.href}/png\nüìÑ PDF: ${window.location.href}/pdf\n\nüìû Tel: +662 2744216\nüìß Email: booking@dhakulchan.com\nüì± Line: @dhakulchan`,
                    url: window.location.href
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                    showToast('‚úÖ Shared successfully!', 'success');
                } else {
                    await copyBookingLink();
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share error:', err);
                    showToast('‚ùå Share failed', 'error');
                }
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function copyBookingLink() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<span class="loading-spinner me-2"></span>Copying...';
                button.disabled = true;

                const text = `üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: ${window.location.href}
üñºÔ∏è Download PNG: ${window.location.href}/png
üìÑ Download PDF: ${window.location.href}/pdf

üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan

üîí Secure link (expires in 30 days)`;

                await navigator.clipboard.writeText(text);
                showToast('üìã Link copied to clipboard!', 'success');

            } catch (err) {
                console.error('Copy error:', err);
                showToast('‚ùå Could not copy to clipboard', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function shareToLine() {
            const text = `üìã Service Proposal: {{ booking.booking_reference }}

üîó ${window.location.href}

üìû Tel: +662 2744216
üì± Line OA: @dhakulchan`;

            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');
            showToast('üì± Opening Line...', 'info');
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = getOrCreateToastContainer();

            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' :
                type === 'error' ? 'bg-danger' :
                    type === 'warning' ? 'bg-warning' : 'bg-info';

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: type === 'error' ? 5000 : 3000
            });

            bsToast.show();

            // Remove from DOM after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function getOrCreateToastContainer() {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                container.style.zIndex = '1055';
                document.body.appendChild(container);
            }
            return container;
        }

        // Auto-refresh if token expires (optional)
        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                // Could implement token refresh logic here
            }
        }, 30 * 24 * 60 * 60 * 1000); // 30 days
    </script>
</body>

</html>