<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Booking {{ booking.booking_reference }} - Service Proposal</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --card-hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .booking-header {
            background: var(--primary-gradient);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .booking-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><linearGradient id="a" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="%23ffffff" stop-opacity="0.1"/><stop offset="1" stop-color="%23ffffff" stop-opacity="0"/></linearGradient></defs><polygon fill="url(%23a)" points="0,20 100,0 100,20"/></svg>');
            opacity: 0.3;
        }

        .booking-header .container {
            position: relative;
            z-index: 1;
        }

        .booking-card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            background: white;
            overflow: hidden;
        }

        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .card-header {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 1.5rem;
            font-weight: 600;
        }

        .download-btn {
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .download-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s;
        }

        .download-btn:hover:before {
            left: 100%;
        }

        .btn-download-png {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-download-pdf {
            background: linear-gradient(135deg, #4834d4, #686de0);
            color: white;
        }

        .security-notice {
            background: linear-gradient(135deg, #dff9fb, #c7ecee);
            border-left: 4px solid #00b894;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .info-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #007bff;
        }

        .badge-status {
            font-size: 0.9em;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .guest-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .share-btn {
            background: var(--success-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }

        @media (max-width: 768px) {
            .booking-header {
                padding: 2rem 0;
            }

            .booking-card {
                margin-bottom: 1rem;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="booking-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-ticket-alt me-3"></i>
                        Service Proposal
                    </h1>
                    <h2 class="h3 mb-0">üìã {{ booking.booking_reference }}</h2>
                    <p class="mt-2 mb-0 opacity-75">
                        <i class="fas fa-calendar me-2"></i>
                        {% if booking.booking_date %}
                        {{ booking.booking_date.strftime('%d/%m/%Y') }}
                        {% else %}
                        N/A
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="badge badge-status bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i>
                        {{ booking.status.title() }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container pb-5">
        <div class="row">
            <!-- Left Column: Booking Information -->
            <div class="col-lg-8">
                <!-- Customer Information -->
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-user me-2"></i>
                            Customer Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i class="fas fa-user me-2 text-primary"></i>Name:</strong><br>
                                    {{ booking.customer_name or 'N/A' }}
                                </div>
                                <div class="info-item">
                                    <strong><i class="fas fa-envelope me-2 text-primary"></i>Email:</strong><br>
                                    {{ booking.customer_email or 'N/A' }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i class="fas fa-phone me-2 text-primary"></i>Phone:</strong><br>
                                    {{ booking.customer_phone or 'N/A' }}
                                </div>
                                <div class="info-item">
                                    <strong><i class="fas fa-dollar-sign me-2 text-primary"></i>Total
                                        Amount:</strong><br>
                                    <span class="fw-bold text-success fs-5">
                                        {% if booking.total_amount %}
                                        ‡∏ø{{ "{:,.2f}".format(booking.total_amount) }}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Travel Information -->
                {% if booking.arrival_date or booking.departure_date %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-plane me-2"></i>
                            Travel Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i class="fas fa-plane-arrival me-2 text-success"></i>Arrival:</strong><br>
                                    {% if booking.arrival_date %}
                                    {{ booking.arrival_date.strftime('%d/%m/%Y') }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong><i
                                            class="fas fa-plane-departure me-2 text-danger"></i>Departure:</strong><br>
                                    {% if booking.departure_date %}
                                    {{ booking.departure_date.strftime('%d/%m/%Y') }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if booking.total_pax %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="info-item">
                                    <strong><i class="fas fa-users me-2 text-primary"></i>Passengers:</strong><br>
                                    <span class="fs-5">
                                        {% if booking.adults %}<i class="fas fa-user me-1"></i>{{ booking.adults }}
                                        Adults{% endif %}
                                        {% if booking.children %}<i class="fas fa-child ms-3 me-1"></i>{{
                                        booking.children }} Children{% endif %}
                                        {% if booking.infants %}<i class="fas fa-baby ms-3 me-1"></i>{{ booking.infants
                                        }} Infants{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Guest List -->
                {% if booking.guest_list %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Guest List
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="guest-list">
                            {{ booking.guest_list | safe }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Additional Information -->
                {% if booking.description %}
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Description
                        </h3>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">{{ booking.description }}</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column: Actions -->
            <div class="col-lg-4">
                <!-- Download Options -->
                <div class="booking-card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-download me-2"></i>
                            Download Options
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-3">
                            <a href="{{ url_for('public.download_booking_png', token=token) }}"
                                class="download-btn btn-download-png" target="_blank">
                                <i class="fas fa-image me-2"></i>
                                Download PNG Image
                            </a>
                            <a href="{{ url_for('public.download_booking_pdf', token=token) }}"
                                class="download-btn btn-download-pdf" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>
                                Download PDF Document
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Security Notice -->
                <div class="security-notice">
                    <h5 class="text-success">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security Notice
                    </h5>
                    <p class="mb-2 small">
                        <i class="fas fa-clock me-2"></i>
                        This secure link expires after <strong>30 days</strong>
                    </p>
                    <p class="mb-0 small">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Please do not share this link with unauthorized persons
                    </p>
                </div>

                <!-- Share Options -->
                <div class="booking-card">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-share-alt me-2"></i>
                            Share Options
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button onclick="shareBooking()" class="btn share-btn">
                                <i class="fas fa-share me-2"></i>
                                Share Booking
                            </button>
                            <button onclick="copyBookingLink()" class="btn btn-outline-primary">
                                <i class="fas fa-copy me-2"></i>
                                Copy Link
                            </button>
                            <button onclick="shareToLine()" class="btn btn-outline-success">
                                <i class="fab fa-line me-2"></i>
                                Share to Line
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="booking-card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-phone me-2"></i>
                            Contact Us
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="info-item mb-2">
                            <i class="fas fa-phone me-2 text-primary"></i>
                            <strong>Tel:</strong> +662 2744216
                        </div>
                        <div class="info-item mb-2">
                            <i class="fas fa-envelope me-2 text-primary"></i>
                            <strong>Email:</strong> support@dhakulchan.com
                        </div>
                        <div class="info-item">
                            <i class="fab fa-line me-2 text-success"></i>
                            <strong>Line OA:</strong> @dhakulchan
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Enhanced sharing functions with loading states and better UX

        async function shareBooking() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<span class="loading-spinner me-2"></span>Sharing...';
                button.disabled = true;

                const shareData = {
                    title: 'üìã Booking {{ booking.booking_reference }}',
                    text: `üìã Service Proposal: {{ booking.booking_reference }}\nüîó View: ${window.location.href}\nüñºÔ∏è PNG: ${window.location.href}/png\nüìÑ PDF: ${window.location.href}/pdf\n\nüìû Tel: +662 2744216\nüìß Email: support@dhakulchan.com\nüì± Line: @dhakulchan`,
                    url: window.location.href
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                    showToast('‚úÖ Shared successfully!', 'success');
                } else {
                    await copyBookingLink();
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share error:', err);
                    showToast('‚ùå Share failed', 'error');
                }
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function copyBookingLink() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<span class="loading-spinner me-2"></span>Copying...';
                button.disabled = true;

                const text = `üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: ${window.location.href}
üñºÔ∏è Download PNG: ${window.location.href}/png
üìÑ Download PDF: ${window.location.href}/pdf

üìû Tel: +662 2744216
üìß Email: support@dhakulchan.com
üì± Line OA: @dhakulchan

üîí Secure link (expires in 30 days)`;

                await navigator.clipboard.writeText(text);
                showToast('üìã Link copied to clipboard!', 'success');

            } catch (err) {
                console.error('Copy error:', err);
                showToast('‚ùå Could not copy to clipboard', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function shareToLine() {
            const text = `üìã Service Proposal: {{ booking.booking_reference }}

üîó ${window.location.href}

üìû Tel: +662 2744216
üì± Line OA: @dhakulchan`;

            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');
            showToast('üì± Opening Line...', 'info');
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = getOrCreateToastContainer();

            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' :
                type === 'error' ? 'bg-danger' :
                    type === 'warning' ? 'bg-warning' : 'bg-info';

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: type === 'error' ? 5000 : 3000
            });

            bsToast.show();

            // Remove from DOM after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function getOrCreateToastContainer() {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                container.style.zIndex = '1055';
                document.body.appendChild(container);
            }
            return container;
        }

        // Auto-refresh if token expires (optional)
        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                // Could implement token refresh logic here
            }
        }, 30 * 24 * 60 * 60 * 1000); // 30 days
    </script>
</body>

</html>