{% extends 'base.html' %}
{% block title %}Tour Voucher / Service - {{ booking.booking_reference }}{% endblock %}
{% block content %}
<!-- Force cache refresh - v3 -->
<script>
    const CURRENT_VERSION = '2025-11-29-v3-fix';
    console.log('üîç Current page version:', CURRENT_VERSION);

    // Check if this is a cached version
    if (!window.VOUCHER_JS_VERSION || window.VOUCHER_JS_VERSION !== CURRENT_VERSION) {
        console.warn('üîÑ Detected old version:', window.VOUCHER_JS_VERSION, '‚Üí New:', CURRENT_VERSION);
        window.VOUCHER_JS_VERSION = CURRENT_VERSION;
        // Force reload once
        const storageKey = 'voucher_cache_' + CURRENT_VERSION;
        if (!sessionStorage.getItem(storageKey)) {
            console.warn('‚ö†Ô∏è FORCING RELOAD...');
            sessionStorage.setItem(storageKey, 'true');
            location.reload(true);
        }
    } else {
        console.log('‚úÖ Page version is current:', CURRENT_VERSION);
    }
</script>
<div class="voucher-wrapper py-3">
    <!-- Updated Header -->
    <div class="voucher-header mb-3">
        <div class="row g-2 align-items-start">
            <div class="col-md-6">
                <h1 class="voucher-title mb-1">TOUR VOUCHER / SERVICE ORDER > EDIT/UPDATE</h1>
                <div class="contact-line small fw-semibold">Tel: +852 23921155, +852 23921177 | +662 266525, +662
                    2744216</div>
                <div class="ref-line text-muted small mt-1">Reference: {{ booking.booking_reference }}</div>
                <div class="arno-qtno-line text-primary small fw-semibold mt-1">
                    {% set quote_num = booking.quote_number or (booking.quotes and booking.quotes|length > 0 and
                    booking.quotes[0].quote_number) or (booking.quote_id if booking.quote_id else None) %}
                    <span class="me-3">Quote Number: {{ quote_num or 'N/A' }}</span>
                    {% if booking.party_name %}
                    <span class="text-success">Party Name: {{ booking.party_name }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="company-eng fw-bold small lh-sm">DHAKUL CHAN NICE HOLIDAYS DISCOVERY GROUP COMPANY LIMITED
                </div>
                <div class="company-cn fw-bold small lh-sm">Èô≥Ê∞èÊóÖÈÅãÈõÜÂúòÊúâÈôêÂÖ¨Âè∏</div>
                <div class="addr-line small text-muted lh-sm mt-1">HKG: C13, 21/F, Mai Wah Industrial Bldg., No.1‚Äì7
                    Wah Shing Street, Kwai Chung, NT.</div>
                <div class="addr-line small text-muted lh-sm">BKK: 710, 716 Prachautid Road, Samsennok, Huai Kwang,
                    Bangkok 10320 Thailand.
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="info-box p-3 h-100">
                <div class="label">Create Date</div>
                <div>{{ booking.created_at.strftime('%d %b %Y') if booking.created_at else '-' }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box p-3 h-100">
                <div class="label">Traveling Period</div>
                <div>
                    {% if booking.traveling_period_start %}
                    {{ booking.traveling_period_start.strftime('%d.%b.%Y') }} - {{
                    booking.traveling_period_end.strftime('%d.%b.%Y') if booking.traveling_period_end else '' }}
                    {% elif booking.arrival_date %}
                    {{ booking.arrival_date.strftime('%d.%b.%Y') }}{% if booking.departure_date and
                    booking.departure_date != booking.arrival_date %} - {{ booking.departure_date.strftime('%d.%b.%Y')
                    }}{% endif %}
                    {% else %}-{% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box p-3 h-100">
                <div class="label">Customer</div>
                <div class="thai-text">{{ booking.customer.full_name or booking.customer.name }}</div>
                <div class="small text-muted">{{ booking.customer.phone }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box p-3 h-100">
                <div class="label">PAX</div>
                <div>{{ booking.total_pax }} pax</div>
                <div class="small text-muted">Adult {{ booking.adults or 0 }}{% if booking.children %} / Child {{
                    booking.children }}{% endif %}{% if booking.infants %} / Infant {{ booking.infants }}{% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Guest Names (editable) -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light fw-semibold">
            <span><i class="fas fa-users me-1"></i> Guest Names / Rooming List</span>
        </div>
        <div class="card-body small" id="guest-list-editor">
            <textarea class="form-control tinymce-editor" id="guest-list-textarea" name="guest_list" rows="6"
                placeholder="Enter guest information, table, or notes...">{{ booking.get_guest_list_for_edit()|replace('\n', '<br>')|safe }}</textarea>
            <div class="form-text mt-2">
                Enter each guest name on a separate line
            </div>
        </div>
    </div>

    <!-- Editable Voucher Rows -->
    <div class="card mb-4 shadow-sm" id="voucher-rows-card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-table me-1"></i> Hotel / Accommodation | Transfer | Others | Flight Detail</span>
            <button class="btn btn-sm btn-light" type="button" onclick="addRow()"><i class="fas fa-plus me-1"></i>Add
                Row</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle mb-0" id="voucher-table">
                <thead class="table-dark">
                    <tr class="text-center">
                        <th style="width:40px">No.</th>
                        <th style="width:110px">ARRIVAL</th>
                        <th style="width:110px">DEPARTURE</th>
                        <th style="width:38%">SERVICE BY / SUPPLIER</th>
                        <th style="width:27%">TYPE/CLASS/PAXS/PIECES</th>
                        <th style="width:40px"><i class="fas fa-arrows-alt" title="Drag to reorder"></i></th>
                    </tr>
                </thead>
                <tbody id="voucher-body" class="sortable-tbody">
                    {% set rows = booking.get_voucher_rows() %}
                    {% if rows %}
                    {% for r in rows %}
                    <tr class="sortable-row" draggable="true">
                        <td class="text-center index-col"><i class="fas fa-grip-vertical text-muted me-1"
                                style="cursor:move"></i><span class="row-number"></span></td>
                        <td><input type="text" name="arrival" value="{{ r.arrival or r['arrival'] }}"
                                placeholder="DD/MM/YYYY" class="form-control form-control-sm date-input" /></td>
                        <td><input type="text" name="departure" value="{{ r.departure or r['departure'] }}"
                                placeholder="DD/MM/YYYY" class="form-control form-control-sm date-input" /></td>
                        {% set current_service = r.service_by or r['service_by'] %}
                        <td class="supplier-cell">
                            <select name="service_by_supplier" class="form-select form-select-sm mb-1"
                                data-current="{{ current_service }}" onchange="handleSupplierChange(this)"></select>
                            <div class="supplier-display" style="display:none;">
                                <div class="supplier-name" style="font-weight: 700;"></div>
                                <div class="supplier-details" style="font-weight: normal; white-space: pre-wrap;"></div>
                            </div>
                            <textarea name="service_by" rows="2"
                                class="form-control form-control-sm supplier-custom thai-text"
                                placeholder="Custom supplier name" style="display:none"
                                oninput="formatSupplierText(this)">{{ current_service }}</textarea>
                        </td>
                        <td><textarea name="type" rows="3"
                                class="form-control form-control-sm thai-text">{{ r.type or r['type'] }}</textarea></td>
                        <td class="text-center">
                            <button class="btn btn-link text-danger p-0" onclick="removeRow(this)" title="Delete">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2 flex-wrap">
            <button class="btn btn-success btn-sm" onclick="saveRows()"><i class="fas fa-save me-1"></i>Save Rows &
                Details</button>
        </div>
    </div>

    <!-- Voucher Image Upload (Multi) -->
    <div class="row g-3 mb-4">
        <div class="col-md-12">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                    <span>Voucher Images (Multi-upload)</span>
                    <button type="button" class="btn btn-sm btn-primary" onclick="uploadVoucherImages()">
                        <i class="fas fa-upload me-1"></i>Upload Images
                    </button>
                </div>
                <div class="card-body small">
                    <input type="file" name="voucher_images" id="voucherImagesInput" accept="image/*" multiple
                        class="form-control form-control-sm mb-2">
                    <div class="form-text mb-2">Allowed: jpg, jpeg, png, gif, webp (‚â§1MB each)</div>

                    <!-- Current Images Container -->
                    <div id="voucherImagesContainer" class="d-flex flex-wrap gap-3 mb-3">
                        {% if voucher_images %}
                        {% for img in voucher_images %}
                        <div class="voucher-image-item position-relative border rounded p-2"
                            data-image-id="{{ img.id or 'img_' + loop.index0|string }}" draggable="true"
                            style="width: 200px;">
                            <!-- Order Badge -->
                            <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                                <span class="badge bg-primary image-order-badge">{{ loop.index }}</span>
                            </div>

                            <!-- Title Input -->
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm image-title-input"
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)" value="{{ img.title or '' }}"
                                    onchange="updateImageTitle(this, '{{ img.id or 'img_' + loop.index0|string }}')">
                            </div>

                            <!-- Image Display -->
                            <div class="position-relative">
                                <img src="{{ img.url }}"
                                    style="width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fafafa;cursor:zoom-in;" />
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0"
                                    style="transform:translate(40%, -40%);"
                                    onclick="deleteVoucherImage(this, '{{ img.id or 'img_' + loop.index0|string }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="text-center small mt-1">
                                <span class="badge bg-secondary">{{ loop.index }}</span>
                                <div class="text-muted" style="font-size: 0.7rem;">
                                    <i class="fas fa-arrows-alt"></i> ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% elif booking.voucher_image_path %}
                        <div class="voucher-image-item position-relative border rounded p-2" data-image-id="main"
                            draggable="true" style="width: 200px;">
                            <!-- Order Badge -->
                            <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                                <span class="badge bg-primary image-order-badge">1</span>
                            </div>

                            <!-- Title Input for legacy image -->
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm image-title-input"
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)" value=""
                                    onchange="updateImageTitle(this, 'main')">
                            </div>

                            <!-- Image Display -->
                            <div class="position-relative">
                                <img src="{{ url_for('static', filename=booking.voucher_image_path.split('?')[0]) }}"
                                    style="width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fafafa;cursor:zoom-in;" />
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0"
                                    style="transform:translate(40%, -40%);" onclick="deleteVoucherImage(this, 'main')">
                                    <i class="fas fa-times"></i>
                                    <div class="text-center small mt-1">
                                        <span class="badge bg-secondary">1</span>
                                        <div class="text-muted" style="font-size: 0.7rem;">
                                            <i class="fas fa-arrows-alt"></i> ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                                        </div>
                                    </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Image Preview for new uploads -->
                </div>

                <!-- Image Preview for new uploads -->
                <div id="voucherImagePreview" class="d-flex flex-wrap gap-2"></div>

                <!-- Removed "Generated Voucher Image" section as requested -->
            </div>
        </div>
    </div>

    <!-- Voucher Library Albums Selection -->
    <div class="col-md-12">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-images me-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Voucher (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà)</span>
                <a href="{{ url_for('voucher_library.list_albums') }}" target="_blank"
                    class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ
                </a>
            </div>
            <div class="card-body small">
                <label for="voucherAlbumsSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á Voucher ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô
                    PDF/PNG:</label>
                <select id="voucherAlbumsSelect" name="voucher_album_ids" class="form-select form-select-sm" multiple
                    size="8">
                    <!-- Options will be loaded dynamically -->
                </select>
                <div class="form-text mt-2">
                    <i class="fas fa-info-circle"></i> ‡∏Å‡∏î Ctrl (Cmd ‡∏ö‡∏ô Mac) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ - ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô
                    voucher PDF/PNG
                </div>

                <!-- Preview of selected albums -->
                <div id="selectedAlbumsPreview" class="d-flex flex-wrap gap-3 mt-3">
                    <!-- Selected album thumbnails will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Supplier Selection (re-added) -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span>Supplier</span>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="showInlineSupplierForm()"><i
                            class="fas fa-plus me-1"></i>Add New</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshSuppliers()"><i
                            class="fas fa-sync"></i></button>
                </div>
            </div>
            <div class="card-body small">
                <select id="supplierSelect" name="supplier_id" class="form-select form-select-sm mb-2"
                    data-current="{{ booking.supplier_id or booking.vendor_id }}"></select>
                <div class="small text-muted" id="supplierStatus" style="display:none"></div>
            </div>
        </div>
    </div>
</div>

<!-- Flight Info / Itinerary: Flight Info first -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-light fw-semibold">Flight Info</div>
            <div class="card-body small p-0">
                <textarea id="flightInfoText" class="form-control border-0 rounded-0 thai-text" rows="4"
                    style="resize:vertical; font-size:.8rem; white-space: pre-wrap;">{{ (booking.flight_info or '') | flight_info_to_text }}</textarea>
            </div>
        </div>
    </div>
</div>
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-light fw-semibold">Service Detail / Itinerary</div>
            <div class="card-body small p-0">
                <textarea id="itineraryText" class="form-control border-0 rounded-0 thai-text" readonly
                    style="min-height:200px; resize:vertical; font-size:.8rem; white-space: pre-wrap; line-height: 1.8; background-color: #f9f9f9;">{{ (booking.description or booking.internal_note or '') | service_detail_to_text }}</textarea>

                <!-- Toggle button -->
                <div class="p-2 bg-light border-top">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleItineraryEdit()">
                        <i class="fas fa-edit me-1"></i>Edit Itinerary
                    </button>
                    <button type="button" class="btn btn-sm btn-success ms-2" onclick="saveItinerary()"
                        id="save-itinerary-btn" style="display: none;">
                        <i class="fas fa-save me-1"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sharing Files Section -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-share-alt me-1"></i>Sharing Files</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleFileSharing()"
                        id="toggle-file-btn">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- File Upload Area (hidden by default) -->
                <div id="file-upload-area" style="display: none;">
                    <div class="upload-zone border-2 border-dashed border-primary rounded p-4 text-center mb-3"
                        ondrop="dropHandler(event)" ondragover="dragOverHandler(event)"
                        ondragenter="dragEnterHandler(event)" ondragleave="dragLeaveHandler(event)">
                        <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                        <p class="mb-2">Drag & Drop files here or <strong>click to browse</strong></p>
                        <input type="file" id="file-input" multiple class="d-none" onchange="handleFileSelect(event)">
                        <button type="button" class="btn btn-primary btn-sm"
                            onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-plus me-1"></i>Select Files
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title (Optional)</label>
                        <input type="text" id="file-title" class="form-control" placeholder="Enter title for files">
                    </div>

                    <div id="upload-progress" style="display: none;">
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Uploading files...</small>
                    </div>
                </div>

                <!-- Files List -->
                <div id="files-list">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <p>No files shared yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- External Links Section -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-external-link-alt me-1"></i>External Links</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleLinkSharing()"
                        id="toggle-link-btn">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Add Link Form (hidden by default) -->
                <div id="link-add-area" style="display: none;">
                    <form id="add-link-form" onsubmit="addExternalLink(event)">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">URL</label>
                                <input type="url" id="link-url" class="form-control" placeholder="https://example.com"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Title</label>
                                <input type="text" id="link-title" class="form-control" placeholder="Link title"
                                    required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>Add Link
                        </button>
                    </form>
                </div>

                <!-- Links List -->
                <div id="links-list">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-link fa-2x mb-2"></i>
                        <p>No external links added yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Signatures -->
<div class="card mb-5 shadow-sm">
    <div class="card-body">
        <div class="row text-center small">
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="fw-semibold">Confirmed By (DCTS):</div>
                <div class="signature-line"></div>
                <div class="mt-2">Date: <span class="sig-date" data-role="confirmed"></span></div>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="fw-semibold">Accepted By:</div>
                <div class="signature-line"></div>
                <div class="mt-2">Date: <span class="sig-date" data-role="accepted"></span></div>
            </div>
            <div class="col-md-4">
                <div class="fw-semibold">Sales By (DCTS):</div>
                <div class="signature-line"></div>
                <div class="mt-2">Date: <span class="sig-date" data-role="sales"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // COPY THAI MESSAGE FUNCTION - Define first to ensure it's always available
    window.copyThaiMessage = function () {
        console.log('üéØ copyThaiMessage() called!');

        // Show loading indicator
        const button = document.getElementById('copyMessage');
        if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            button.disabled = true;

            // Generate share token for 120 days (172800 minutes)
            fetch(`{{ url_for('voucher.generate_share_token', id=booking.id) }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ minutes: 172800 }) // 120 days = 120 * 24 * 60 = 172800 minutes
            })
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.success && data.token) {
                        // Create the exact Thai message format with share links
                        const baseUrl = window.location.origin;
                        const shareUrl = `${baseUrl}/public/booking/${data.token}`;

                        const thaiMessage = `‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: ${shareUrl}

üñºÔ∏è Download PNG: ${shareUrl}/png

üìÑ Download PDF: ${shareUrl}/pdf

‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á
‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø 
üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan
üîí Secure link (expires in 120 days)`;

                        // Copy to clipboard
                        return navigator.clipboard.writeText(thaiMessage).then(() => {
                            button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.disabled = false;
                            }, 2000);

                            // Show success toast
                            const toast = document.createElement('div');
                            toast.className = 'alert alert-success position-fixed';
                            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0.9; max-width: 400px;';
                            toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏ä‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 3000);
                        });
                    } else {
                        throw new Error('Failed to generate share token');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Share token generation failed:', error);

                    // Fallback: use basic Thai message without share links
                    const fallbackMessage = `‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: {{ url_for('voucher.view', id=booking.id, _external=True) }}

‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á
‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø 
üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan`;

                    navigator.clipboard.writeText(fallbackMessage).then(() => {
                        button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }, 2000);

                        // Show fallback success toast
                        const toast = document.createElement('div');
                        toast.className = 'alert alert-warning position-fixed';
                        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0.9; max-width: 400px;';
                        toast.innerHTML = '<i class="fas fa-info-circle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }).catch(() => {
                        // Final fallback: show in alert
                        button.innerHTML = originalText;
                        button.disabled = false;
                        alert('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:\n\n' + fallbackMessage);
                    });
                });
        } else {
            // If no button found, just copy basic message
            const basicMessage = `‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: {{ url_for('voucher.view', id=booking.id, _external=True) }}

‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á
‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø 
üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan`;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(basicMessage).then(() => {
                    console.log('‚úÖ Thai message copied!');
                    alert('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!');
                }).catch(err => {
                    console.error('‚ùå Clipboard failed:', err);
                    alert('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:\n\n' + basicMessage);
                });
            } else {
                alert('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:\n\n' + basicMessage);
            }
        }
    };

    // Define Enhanced Booking View function
    window.openEnhancedBookingView = function () {
        console.log('üîó Enhanced Booking View clicked!');

        const shareTokenUrl = '{{ url_for("voucher.generate_share_token", id=booking.id) }}';
        fetch(shareTokenUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ minutes: 43200 }) // 30 days
        })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.token) {
                    const baseUrl = window.location.origin;
                    const shareUrl = `${baseUrl}/public/booking/${data.token}`;
                    console.log('‚úÖ Opening enhanced booking view:', shareUrl);
                    window.open(shareUrl, '_blank');
                } else {
                    console.error('‚ùå Token generation failed:', data.message);
                    alert('Error: ' + (data.message || 'Could not generate share link'));
                }
            })
            .catch(err => {
                console.error('‚ùå Network error:', err);
                alert('Network error: ' + err.message);
            });
    };

    // PNG Multi-page function - define before DOMContentLoaded
    window.openPngMultiPage = function () {
        console.log('üñºÔ∏è PNG Multi-page clicked!');
        console.log('üîç Function called, preparing URL...');

        // Direct URL to voucher PNG combined route
        const pngUrl = `{{ url_for('voucher.voucher_png_combined', id=booking.id) }}`;
        console.log('‚úÖ Opening PNG Combined URL:', pngUrl);

        try {
            window.open(pngUrl, '_blank');
            console.log('‚úÖ Window.open executed successfully');
        } catch (error) {
            console.error('‚ùå Error opening window:', error);
        }
    };

    // Attach event listener when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        // Add a small delay to ensure everything is loaded
        setTimeout(function () {
            console.log('‚úÖ Voucher view initialized');
        }, 100); // Wait 100ms

        const btn = document.getElementById('pngMultiPageBtn');
        if (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('üî• PNG Multi-page button clicked!', e);
                window.openPngMultiPage();
            });
            console.log('‚úÖ PNG Multi-page button event attached');
        } else {
            console.error('‚ùå PNG Multi-page button not found');
        }
    });

    console.log('‚úÖ PNG Multi-page function defined');

    // Toggle function for itinerary edit mode
    window.toggleItineraryEdit = function () {
        const editTextarea = document.getElementById('itineraryText');
        const toggleBtn = event.target;
        const saveBtn = document.getElementById('save-itinerary-btn');

        if (editTextarea.hasAttribute('readonly')) {
            // Switch to edit mode
            editTextarea.removeAttribute('readonly');
            editTextarea.style.backgroundColor = '#fff';
            saveBtn.style.display = 'inline-block';
            toggleBtn.innerHTML = '<i class="fas fa-eye me-1"></i>View Mode';
            editTextarea.focus();
        } else {
            // Switch to view mode
            editTextarea.setAttribute('readonly', 'readonly');
            editTextarea.style.backgroundColor = '#f9f9f9';
            saveBtn.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Edit Itinerary';
        }
    };

    // Save itinerary function
    window.saveItinerary = function () {
        const editTextarea = document.getElementById('itineraryText');
        const content = editTextarea.value.trim();

        console.log('Saving itinerary content:', content);

        // Save directly to server
        fetch(`{{ url_for('voucher.save_rows_api', id=booking.id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                description: content,
                rows: [],  // Empty rows array since we're only updating description
                flight_info: document.getElementById('flightInfoText')?.value || '',
                guest_list: [],
                supplier_id: document.getElementById('supplierSelect')?.value || '',
                voucher_images: []
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Itinerary saved successfully');

                    // Switch back to view mode
                    const saveBtn = document.getElementById('save-itinerary-btn');
                    const toggleBtn = document.querySelector('button[onclick="toggleItineraryEdit()"]');

                    editTextarea.setAttribute('readonly', 'readonly');
                    editTextarea.style.backgroundColor = '#f9f9f9';
                    saveBtn.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Edit Itinerary';

                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                    <i class="fas fa-check me-1"></i>Service Detail saved successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                    document.querySelector('.voucher-wrapper').insertBefore(alertDiv, document.querySelector('.voucher-wrapper').firstChild);

                    // Auto dismiss after 3 seconds
                    setTimeout(() => {
                        alertDiv?.remove();
                    }, 3000);
                } else {
                    console.error('‚ùå Failed to save itinerary:', data.error);
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('‚ùå Error saving itinerary:', error);
                alert('Error saving itinerary: ' + error.message);
            });
    };
</script>

<div class="d-print-none mb-4 d-flex flex-wrap gap-2">
    <!-- PNG Multi-page Button (standalone) -->
    <button class="btn btn-primary" type="button" id="pngMultiPageBtn">
        <i class="fas fa-images me-1"></i>PNG Multi-page
    </button>

    <!-- Share Options Dropdown -->
    <div class="btn-group">
        <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-share-alt me-1"></i>Share Options
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="sendToLineOA"><i class="fab fa-line me-2"></i>Send to Line OA</a>
            </li>
            <li><a class="dropdown-item" href="#" id="copyLineMessage"><i class="fas fa-copy me-2"></i>Copy Line
                    Message</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li>
                <h6 class="dropdown-header">Social Media</h6>
            </li>
            <li><a class="dropdown-item" href="#" id="shareWhatsApp"><i class="fab fa-whatsapp me-2"></i>WhatsApp</a>
            </li>
            <li><a class="dropdown-item" href="#" id="shareLine"><i class="fab fa-line me-2"></i>Line</a></li>
            <li><a class="dropdown-item" href="#" id="shareFacebook"><i class="fab fa-facebook me-2"></i>Facebook</a>
            </li>
            <li><a class="dropdown-item" href="#" id="shareEmail"><i class="fas fa-envelope me-2"></i>Email</a></li>
            <li><a class="dropdown-item" href="#" id="shareTelegram"><i class="fab fa-telegram me-2"></i>Telegram</a>
            </li>
            <li><a class="dropdown-item" href="#" id="shareTwitter"><i class="fab fa-twitter me-2"></i>Twitter</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#" id="copyMessage" onclick="copyThaiMessage(); return false;"><i
                        class="fas fa-clipboard me-2"></i>Copy Message</a>
            </li>
            <li><a class="dropdown-item" href="#" id="openSharePage"
                    onclick="window.openEnhancedBookingView(); return false;">
                    <i class="fas fa-external-link-alt me-2"></i>Open Share Page</a></li>
        </ul>
    </div>

    <a class="btn btn-success" href="{{ url_for('voucher.generate_pdf', id=booking.id) }}"><i
            class="fas fa-file-pdf me-1"></i>PDF Download</a>
    <a class="btn btn-outline-secondary" onclick="window.print()"><i class="fas fa-print me-1"></i>Print</a>
    <a class="btn btn-outline-warning" href="{{ url_for('booking.edit', id=booking.id) }}"><i
            class="fas fa-edit me-1"></i>Edit Booking</a>
    <a class="btn btn-outline-dark" href="{{ url_for('booking.view', id=booking.id) }}"><i
            class="fas fa-arrow-left me-1"></i>Back</a>
</div>
</div>

<!-- Image Zoom Modal -->
<div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="imageZoomModalLabel">Voucher Image</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-2">
                <div class="position-relative d-inline-block">
                    <img id="zoomedImage" src="" alt="Voucher Image" class="img-fluid"
                        style="max-height: 70vh; cursor: zoom-in;">
                    <div class="position-absolute top-0 end-0 m-2">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-light" id="zoomOut" title="Zoom Out">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" id="zoomReset"
                                title="Reset Zoom">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" id="zoomIn" title="Zoom In">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <span class="text-white small me-auto">Click and drag to pan ‚Ä¢ Scroll to zoom</span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
    // DEBUG: Test if script is loaded
    console.log('üîß Voucher page JavaScript loaded!');

    // Test if Copy Message button exists
    document.addEventListener('DOMContentLoaded', function () {
        const copyBtn = document.getElementById('copyMessage');
        console.log('üéØ Copy Message button:', copyBtn);
        if (copyBtn) {
            console.log('‚úÖ Copy Message button found!');
        } else {
            console.error('‚ùå Copy Message button NOT found!');
        }
    });

    // Global variables for share functionality
    let currentShareToken = null;
    let currentShareUrl = null;

    // Generate share token and URL
    function generateShareToken() {
        console.log('üîó Generating share token...');
        return fetch(`{{ url_for('voucher.generate_share_token', id=booking.id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'include', // Include cookies for authentication
            body: JSON.stringify({ minutes: 60 })
        })
            .then(r => {
                console.log('üì° Response status:', r.status);

                // Handle authentication errors
                if (r.status === 401 || r.status === 403) {
                    throw new Error('AUTHENTICATION_REQUIRED');
                }

                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                }
                return r.json();
            })
            .then(data => {
                console.log('üìã Token response:', data);
                if (data.success && data.url) {
                    currentShareToken = data.token;
                    currentShareUrl = data.url;
                    return data;
                } else {
                    throw new Error(data.message || 'Could not generate share link');
                }
            })
            .catch(error => {
                console.error('‚ùå Share token generation failed:', error);

                // Special handling for authentication errors
                if (error.message === 'AUTHENTICATION_REQUIRED') {
                    if (confirm('üîê Login required to generate share link. Redirect to login page?')) {
                        window.location.href = '{{ url_for("auth.login") }}';
                    }
                }

                throw error;
            });
    }

    // Single PNG share
    document.getElementById('shareImageSingle')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                window.open(data.url, '_blank');
            })
            .catch(err => alert('Error generating share link: ' + err.message));
    });

    // Multi-page PNG share
    document.getElementById('shareImageMulti')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const multiPageUrl = data.url + '&all=1';
                window.open(multiPageUrl, '_blank');
            })
            .catch(err => alert('Error generating share link: ' + err.message));
    });

    // Send to Line OA
    document.getElementById('sendToLineOA')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const lineMessage = `Tour Voucher - {{ booking.booking_reference }}\n${data.url}`;
                // You can customize this URL based on your Line OA setup
                alert('Line OA integration needed. Message ready:\n' + lineMessage);
            })
            .catch(err => alert('Error: ' + err.message));
    });

    // Copy Line Message
    document.getElementById('copyLineMessage')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const lineMessage = `üé´ Tour Voucher\nüìã Reference: {{ booking.booking_reference }}\nüë• Customer: {{ booking.customer_name or booking.party_name }}\nüîó View: ${data.url}\n‚è∞ Link expires in 30 days`;
                navigator.clipboard.writeText(lineMessage).then(() => {
                    alert('Line message copied to clipboard!');
                }).catch(() => {
                    alert('Message: ' + lineMessage);
                });
            })
            .catch(err => alert('Error: ' + err.message));
    });

    // Social Media Shares
    document.getElementById('shareWhatsApp')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const message = `Tour Voucher - {{ booking.booking_reference }}\n${data.url}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            })
            .catch(err => alert('Error: ' + err.message));
    });

    document.getElementById('shareLine')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const message = `Tour Voucher - {{ booking.booking_reference }}\n${data.url}`;
                const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(data.url)}&text=${encodeURIComponent(message)}`;
                window.open(lineUrl, '_blank');
            })
            .catch(err => alert('Error: ' + err.message));
    });

    document.getElementById('shareFacebook')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(data.url)}`;
                window.open(facebookUrl, '_blank');
            })
            .catch(err => alert('Error: ' + err.message));
    });

    document.getElementById('shareEmail')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const subject = `Tour Voucher - {{ booking.booking_reference }}`;
                const body = `Please find your tour voucher at the following link:\n\n${data.url}\n\nThis link will expire in 30 days.`;
                const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = emailUrl;
            })
            .catch(err => alert('Error: ' + err.message));
    });

    document.getElementById('shareTelegram')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const message = `Tour Voucher - {{ booking.booking_reference }}\n${data.url}`;
                const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(data.url)}&text=${encodeURIComponent(message)}`;
                window.open(telegramUrl, '_blank');
            })
            .catch(err => alert('Error: ' + err.message));
    });

    document.getElementById('shareTwitter')?.addEventListener('click', function (e) {
        e.preventDefault();
        generateShareToken()
            .then(data => {
                const message = `Tour Voucher - {{ booking.booking_reference }}`;
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(data.url)}`;
                window.open(twitterUrl, '_blank');
            })
            .catch(err => alert('Error: ' + err.message));
    });

    // Copy Message - SIMPLIFIED AND ROBUST VERSION
    console.log('üîß Copy Message script is running...');
    console.log('üéØ Document ready state:', document.readyState);

    // IMMEDIATE TEST - This should always work
    alert('üîß Copy Message script loaded successfully!');

    // Function to setup copy message
    function setupCopyMessage() {
        console.log('üîß Setting up Copy Message...');

        // Find all elements with copyMessage ID
        const copyBtn = document.getElementById('copyMessage');
        const allCopyButtons = document.querySelectorAll('#copyMessage, [id="copyMessage"]');

        console.log('üéØ Copy button by ID:', copyBtn);
        console.log('üéØ All copy buttons found:', allCopyButtons.length);

        allCopyButtons.forEach((btn, index) => {
            console.log(`üéØ Button ${index}:`, btn);
        });

        if (copyBtn) {
            console.log('‚úÖ Setting up copy message handler');

            // Remove any existing handlers
            copyBtn.onclick = null;
            copyBtn.removeAttribute('onclick');

            // Add new handler
            copyBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('üéØ COPY MESSAGE CLICKED!');

                // Simple Thai message for now
                const message = `‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: {{ url_for('voucher.view', id=booking.id, _external=True) }}

üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan`;

                // Copy to clipboard
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(message).then(() => {
                        console.log('‚úÖ Message copied successfully!');
                        alert('‚úÖ Thai message copied to clipboard!');
                    }).catch(err => {
                        console.error('‚ùå Clipboard failed:', err);
                        alert('Message:\n\n' + message);
                    });
                } else {
                    alert('Message:\n\n' + message);
                }
            });

            console.log('‚úÖ Copy message handler attached successfully');
            return true;
        } else {
            console.error('‚ùå Copy Message button not found!');
            return false;
        }
    }

    // Try setup immediately
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setupCopyMessage();
    } else {
        document.addEventListener('DOMContentLoaded', setupCopyMessage);
    }

    // Also try with a timeout as backup
    setTimeout(setupCopyMessage, 500);
    setTimeout(setupCopyMessage, 1000);

    copyBtn.onclick = function (e) {
        e.preventDefault();
        console.log('üéØ Copy Message button clicked via onclick!');

        // Show loading indicator
        const button = document.getElementById('copyMessage');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        button.disabled = true;

        // Generate share token first
        fetch(`{{ url_for('voucher.generate_share_token', id=booking.id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ minutes: 172800 }) // 120 days = 120 * 24 * 60 = 172800 minutes
        })
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                }
                return r.json();
            })
            .then(data => {
                if (data.success && data.token) {
                    // Create the Thai message with actual share links
                    const baseUrl = window.location.origin;
                    const shareUrl = `${baseUrl}/public/booking/${data.token}`;

                    const thaiMessage = `‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
ÔøΩ Service Proposal: {{ booking.booking_reference }}

üîó View Booking: ${shareUrl}

üñºÔ∏è Download PNG: ${shareUrl}/png

üìÑ Download PDF: ${shareUrl}/pdf

üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan
ÔøΩ Secure link (expires in 120 days)`;

                    return navigator.clipboard.writeText(thaiMessage).then(() => {
                        button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }, 2000);

                        // Show success toast
                        const toast = document.createElement('div');
                        toast.className = 'alert alert-success position-fixed';
                        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0.9; max-width: 400px;';
                        toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>Thai message with share links copied!';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    });
                } else {
                    throw new Error('Failed to generate share token');
                }
            })
            .catch((error) => {
                console.error('‚ùå Share token generation failed:', error);

                // Fallback: use basic Thai message without share links
                const fallbackMessage = `‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏â‡∏¥‡∏ô‡∏Ø ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
üìã Service Proposal: {{ booking.booking_reference }}

üîó View Booking: {{ url_for('voucher.view', id=booking.id, _external=True) }}

üìû Tel: +662 2744216
üìß Email: booking@dhakulchan.com
üì± Line OA: @dhakulchan`;

                navigator.clipboard.writeText(fallbackMessage).then(() => {
                    button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);

                    // Show fallback success toast
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-warning position-fixed';
                    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0.9; max-width: 400px;';
                    toast.innerHTML = '<i class="fas fa-info-circle me-2"></i>Thai message copied (basic version)!';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }).catch(() => {
                    // Final fallback: show in alert
                    button.innerHTML = originalText;
                    button.disabled = false;
                    alert('Message:\n\n' + fallbackMessage);
                });
            });

</script>
{% endblock %}
{% block extra_css %}
<style>
    .voucher-wrapper {
        max-width: 1140px;
        margin: 0 auto;
    }

    .info-box {
        background: #fff;
        border: 1px solid #e5e8ec;
        border-radius: 8px;
    }

    .info-box .label {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .5px;
        color: #6c757d;
        font-weight: 600;
        margin-bottom: 2px;
    }

    #voucher-table textarea,
    #voucher-table input {
        background: #fff;
        border: 1px solid #d9dee3;
        border-radius: 4px;
        font-size: .75rem;
    }

    /* SERVICE BY / SUPPLIER - Line Break Support */
    #voucher-table textarea[name="service_by"],
    #voucher-table .supplier-custom {
        font-weight: normal;
        white-space: pre-wrap;
        line-height: 1.5;
        font-family: inherit;
    }

    /* Supplier Display Formatting */
    .supplier-display {
        padding: 6px 12px;
        background: #fff;
        border: 1px solid #d9dee3;
        border-radius: 4px;
        font-size: .75rem;
        min-height: 42px;
    }

    .supplier-display .supplier-name {
        font-weight: 700;
        margin-bottom: 2px;
    }

    .supplier-display .supplier-details {
        font-weight: normal;
        white-space: pre-wrap;
        line-height: 1.4;
    }

    #voucher-table thead th {
        font-size: .65rem;
        letter-spacing: .5px;
    }

    /* Sharing Features Styles */
    .upload-zone {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-zone:hover {
        background-color: #f8f9fa;
    }

    .upload-zone.border-success {
        border-color: #198754 !important;
        background-color: #d1eddd;
    }

    .file-item,
    .link-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #fff;
    }

    .file-item:hover,
    .link-item:hover {
        background-color: #f8f9fa;
        border-color: #adb5bd;
    }

    .progress {
        height: 0.5rem;
    }

    .share-token-display {
        background: #e7f3ff;
        border: 1px solid #b8daff;
        padding: 0.75rem;
        border-radius: 0.375rem;
    }

    .alert {
        border-radius: 0.375rem;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        opacity: 0.5;
    }

    .btn-close:hover {
        opacity: 1;
    }

    .signature-line {
        border-bottom: 1px solid #000;
        height: 48px;
        margin: 10px 20px;
    }

    .card {
        border-radius: 10px;
    }

    .card-header {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    .voucher-title {
        font-size: 1.05rem;
        font-weight: 700;
        color: #1d5fe9;
        letter-spacing: .5px;
    }

    .voucher-header .company-eng,
    .voucher-header .company-cn {
        font-size: .78rem;
        /* increased ~15% from .68rem */
        font-weight: 700;
        /* ensure bold */
    }

    .voucher-header .addr-line {
        max-width: 100%;
    }

    .voucher-header {
        border-bottom: 1px solid #e3e6ea;
        padding-bottom: .75rem;
    }

    /* Sortable table rows styling */
    .sortable-row {
        transition: background-color 0.2s;
    }

    .sortable-row:hover {
        background-color: #f8f9fa;
    }

    .sortable-row.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .voucher-image-item {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: move;
    }

    .voucher-image-item:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .voucher-image-item.dragging {
        opacity: 0.5;
        transform: scale(0.95) rotate(3deg);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        border: 2px dashed #007bff !important;
    }

    .voucher-image-item.drag-over {
        border: 2px solid #28a745 !important;
        background-color: #f0f8ff;
    }

    /* Image order badge */
    .image-order-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Library image styling */
    .voucher-library-item {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: move !important;
        user-select: none;
        -webkit-user-drag: element;
    }

    .voucher-library-item * {
        pointer-events: none;
        /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    }

    .voucher-library-item:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        cursor: grab !important;
    }

    .voucher-library-item:active {
        cursor: grabbing !important;
    }

    .voucher-library-item.dragging {
        opacity: 0.5 !important;
        transform: scale(0.95) rotate(3deg) !important;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
        border: 2px dashed #28a745 !important;
        background-color: #fff3cd !important;
    }

    .voucher-library-item.drag-over {
        border: 3px solid #28a745 !important;
        background-color: #d4edda !important;
    }

    .library-order-badge {
        font-size: 1rem !important;
        padding: 0.5rem 0.7rem !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
        font-weight: bold !important;
        z-index: 100 !important;
        position: relative !important;
    }

    /* Toast animation */
    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    /* Drag handle styling */
    .fas.fa-grip-vertical {
        cursor: move;
    }

    .fas.fa-grip-vertical:hover {
        color: #007bff !important;
    }

    /* Image Zoom Modal Styling */
    #imageZoomModal .modal-body {
        overflow: auto;
        max-height: 80vh;
    }

    #zoomedImage {
        transition: transform 0.2s ease;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .voucher-image-item img:hover {
        opacity: 0.9;
        transform: scale(1.02);
        transition: all 0.2s ease;
    }

    /* Zoom controls styling */
    .btn-group .btn-outline-light {
        background-color: rgba(0, 0, 0, 0.5);
        border-color: rgba(255, 255, 255, 0.3);
    }

    .btn-group .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
    }

    @media print {
        .voucher-wrapper {
            max-width: none;
        }
    }
</style>
{% endblock %}
{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
<!-- TinyMCE is already loaded in base.html -->
<script>
        // TinyMCE disabled for itineraryText - using plain textarea with line breaks
        // Init TinyMCE for guest list only
        tinymce.init({
            selector: '#guest-list-textarea',
            menubar: false,
            statusbar: false,
            height: 150,
            plugins: 'lists link table',
            toolbar: 'bold italic underline | bullist numlist | link | table | removeformat',
            content_style: 'body { font-size:12px; }',
            placeholder: 'Enter each guest name on a separate line',
            readonly: false
        });
        // Guest list functions
        function addGuest() {
            // Since we're using TinyMCE textarea, we can focus on the textarea
            const textarea = document.getElementById('guest-list-textarea');
            if (textarea) {
                textarea.focus();
            }
        }
        function removeGuest(btn) {
            // Not applicable for textarea approach
        }
        function collectGuests() {
            // Get text from TinyMCE editor or fallback to textarea
            let guest_text = '';
            if (tinymce.get('guest-list-textarea')) {
                guest_text = tinymce.get('guest-list-textarea').getContent({ format: 'text' });
            } else {
                const textarea = document.getElementById('guest-list-textarea');
                guest_text = textarea ? textarea.value : '';
            }
            return guest_text.split('\n').map(line => line.trim()).filter(line => line);
        }
        // Override saveRows to include guest list & TinyMCE content
        const origSaveRows = window.saveRows;
        function saveRows() {
            const rows = collectRows();
            // itineraryText is now plain textarea (no TinyMCE)
            const description = document.getElementById('itineraryText').value.trim();
            const flight_info = document.getElementById('flightInfoText').value.trim();

            // Get guest list from TinyMCE or fallback to textarea
            let guest_list_text = '';
            if (tinymce.get('guest-list-textarea')) {
                guest_list_text = tinymce.get('guest-list-textarea').getContent({ format: 'text' });
            } else {
                const guest_list_textarea = document.getElementById('guest-list-textarea');
                guest_list_text = guest_list_textarea ? guest_list_textarea.value.trim() : '';
            }
            const guest_list = guest_list_text ? guest_list_text.split('\n').map(line => line.trim()).filter(line => line) : [];

            // Collect voucher images data
            const voucher_images = collectVoucherImages();
            console.log('saveRows: about to send voucher_images:', voucher_images);

            // Collect selected voucher album IDs from library
            const voucher_album_ids = collectVoucherAlbumIds();
            console.log('saveRows: about to send voucher_album_ids:', voucher_album_ids);

            const supplier_id = document.getElementById('supplierSelect')?.value || '';

            const payload = {
                rows,
                description,
                flight_info,
                guest_list,
                supplier_id,
                voucher_images,
                voucher_album_ids
            };
            console.log('saveRows: full payload:', payload);

            fetch(`{{ url_for('voucher.save_rows_api', id=booking.id) }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        location.reload();
                    } else {
                        alert(d.message || 'Save failed');
                    }
                })
                .catch(() => alert('Error'));
        }
        window.saveRows = saveRows;

        // Collect voucher images data for saving
        function collectVoucherImages() {
            const container = document.getElementById('voucherImagesContainer');
            if (!container) {
                console.log('collectVoucherImages: container not found');
                return [];
            }

            const imageItems = container.querySelectorAll('.voucher-image-item');
            const images = [];

            imageItems.forEach((item, index) => {
                const img = item.querySelector('img');
                const imageId = item.getAttribute('data-image-id');
                const titleInput = item.querySelector('.image-title-input');

                if (img && img.src) {
                    images.push({
                        id: imageId || `img_${Date.now()}_${index}`,
                        url: img.src,
                        title: titleInput ? titleInput.value.trim() : '',
                        order: index
                    });
                }
            });

            console.log('collectVoucherImages: collected', images.length, 'images:', images);
            return images;
        }

        // Collect selected voucher album IDs from library
        function collectVoucherAlbumIds() {
            const select = document.getElementById('voucherAlbumsSelect');
            if (!select) {
                console.log('collectVoucherAlbumIds: select not found');
                return [];
            }

            const selectedOptions = Array.from(select.selectedOptions);
            const albumIds = selectedOptions.map(option => parseInt(option.value)).filter(id => !isNaN(id));

            console.log('collectVoucherAlbumIds: collected', albumIds.length, 'album IDs:', albumIds);
            return albumIds;
        }

        // Update image title function with immediate save
        function updateImageTitle(input, imageId) {
            const title = input.value.trim();
            console.log('üìù Image title updated for', imageId, ':', title);

            // Show feedback
            const originalBorder = input.style.border;
            input.style.border = '2px solid #28a745';
            setTimeout(() => {
                input.style.border = originalBorder;
            }, 500);
        }

        // Declare SUPPLIERS variable globally
        let SUPPLIERS = [];

        function loadSuppliers(cb) {
            fetch("{{ url_for('supplier.api_list') }}")
                .then(r => r.json())
                .then(j => { SUPPLIERS = j.suppliers || []; buildMainSupplierSelect(); updateRowSupplierSelects(); cb && cb(); })
                .catch(() => { document.getElementById('supplierStatus').textContent = 'Load suppliers failed'; document.getElementById('supplierStatus').style.display = 'block'; });
        }
        function buildMainSupplierSelect() {
            const sel = document.getElementById('supplierSelect'); if (!sel) return;
            const current = sel.dataset.current || '';
            sel.innerHTML = '<option value="">-- Select Supplier --</option>' + SUPPLIERS.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            if (current) sel.value = current;
        }
        function supplierOptionsHTML() {
            return '<option value="">-- Select Supplier --</option>' + SUPPLIERS.map(s => `<option value="${s.id}" data-sname="${s.name}">${s.name}</option>`).join('') + '<option value="__custom__">Other / Custom</option>' + '<option value="__add_new__">+ Add New Supplier</option>';
        }
        function updateRowSupplierSelects() {
            document.querySelectorAll('select[name="service_by_supplier"]').forEach(sel => {
                const currentText = sel.getAttribute('data-current');
                const prevVal = sel.value; // Store current selected value
                sel.innerHTML = supplierOptionsHTML();

                // Get associated textarea
                const ta = sel.parentElement.querySelector('textarea[name="service_by"]');

                // Try to restore the selection
                if (currentText && currentText.trim()) {
                    // First check if current text matches any supplier name exactly
                    const supplierOpt = Array.from(sel.options).find(o => o.dataset.sname && o.dataset.sname.trim() === currentText.trim());
                    if (supplierOpt) {
                        // Found matching supplier - select it and hide textarea
                        supplierOpt.selected = true;
                        if (ta) {
                            ta.style.display = 'none';
                            ta.value = currentText; // Keep the text in textarea too
                        }
                    } else {
                        // No supplier match - check if text contains supplier name (multi-line case)
                        let foundSupplier = null;
                        for (const option of sel.options) {
                            if (option.dataset.sname && currentText.includes(option.dataset.sname)) {
                                foundSupplier = option;
                                break;
                            }
                        }

                        if (foundSupplier) {
                            // Found supplier name in text - select supplier and show full text
                            foundSupplier.selected = true;
                            if (ta) {
                                ta.style.display = 'block';
                                ta.value = currentText;
                            }
                        } else {
                            // No supplier found - use custom field
                            sel.value = '__custom__';
                            if (ta) {
                                ta.style.display = 'block';
                                ta.value = currentText;
                            }
                        }
                    }
                } else if (prevVal) {
                    sel.value = prevVal;
                }
            });
        }
        // Inline quick add supplier (no popup)
        function showInlineSupplierForm() {
            if (document.getElementById('inlineSupplierForm')) return;
            const cardBody = document.querySelector('#supplierSelect').closest('.card-body');
            const div = document.createElement('div');
            div.id = 'inlineSupplierForm';
            div.className = 'border p-2 rounded bg-light mb-2';
            div.innerHTML = `
            <div class="row g-2 align-items-end mb-2">
                <div class="col-4"><label class="form-label small mb-1">Name *</label><input type="text" id="newSupplierName" class="form-control form-control-sm" placeholder="Supplier name" /></div>
                <div class="col-2"><label class="form-label small mb-1">Phone</label><input type="text" id="newSupplierPhone" class="form-control form-control-sm" /></div>
                <div class="col-3"><label class="form-label small mb-1">Email</label><input type="text" id="newSupplierEmail" class="form-control form-control-sm" /></div>
                <div class="col-3"><label class="form-label small mb-1">Group Email</label><input type="text" id="newSupplierGroupEmail" class="form-control form-control-sm" placeholder="Group" /></div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-success" onclick="createSupplierInline()"><i class="fas fa-save me-1"></i>Save</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelInlineSupplier()">Cancel</button>
            </div>`;
            cardBody.insertBefore(div, cardBody.firstChild);
            document.getElementById('newSupplierName').focus();
        }
        function cancelInlineSupplier() { const f = document.getElementById('inlineSupplierForm'); if (f) f.remove(); }
        function createSupplierInline() {
            const name = document.getElementById('newSupplierName').value.trim();
            const phone = document.getElementById('newSupplierPhone').value.trim();
            const email = document.getElementById('newSupplierEmail').value.trim();
            const real_group_email = document.getElementById('newSupplierGroupEmail')?.value.trim();
            if (!name) { alert('Name required'); return; }
            fetch("{{ url_for('supplier.api_create') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, phone, email, real_group_email }) })
                .then(r => r.json()).then(j => { if (j.success) { cancelInlineSupplier(); refreshSuppliers(); setTimeout(() => { const sel = document.getElementById('supplierSelect'); sel.value = j.supplier.id; updateRowSupplierSelects(); }, 200); } else { alert(j.message || 'Error'); } })
                .catch(() => alert('Error'));
        }
        function updateDataCurrentAttributes() {
            document.querySelectorAll('select[name="service_by_supplier"]').forEach(sel => {
                const currentValue = sel.value;
                const ta = sel.parentElement.querySelector('textarea[name="service_by"]');

                if (currentValue === '__custom__') {
                    // For custom entries, use textarea value
                    if (ta) {
                        sel.setAttribute('data-current', ta.value.trim());
                    }
                } else if (currentValue) {
                    // For supplier selection, decide what to store in data-current
                    const supplier = SUPPLIERS.find(s => s.id == currentValue);
                    if (supplier) {
                        // If supplier has additional info, store full textarea content
                        if (supplier.address || supplier.phone || supplier.notes) {
                            sel.setAttribute('data-current', ta.value.trim());
                        } else {
                            // For simple suppliers, store just the name
                            sel.setAttribute('data-current', supplier.name);
                        }
                    } else {
                        // Fallback to supplier name from option
                        const selectedOption = sel.options[sel.selectedIndex];
                        if (selectedOption && selectedOption.dataset.sname) {
                            sel.setAttribute('data-current', selectedOption.dataset.sname);
                        }
                    }
                }
            });
        }

        function refreshSuppliers() { loadSuppliers(() => { /* refreshed */ }); }

        // Format supplier text to show first line bold, rest normal
        function formatSupplierText(textarea) {
            const cell = textarea.closest('.supplier-cell');
            if (!cell) return;

            const display = cell.querySelector('.supplier-display');
            const nameDiv = cell.querySelector('.supplier-name');
            const detailsDiv = cell.querySelector('.supplier-details');

            if (!display || !nameDiv || !detailsDiv) return;

            const text = textarea.value;
            const lines = text.split('\n');

            if (lines.length > 0) {
                nameDiv.textContent = lines[0]; // First line bold
                detailsDiv.textContent = lines.slice(1).join('\n'); // Rest normal
            }
        }

        function handleSupplierChange(sel) {
            const cell = sel.closest('.supplier-cell');
            const ta = cell.querySelector('textarea[name="service_by"]');
            const display = cell.querySelector('.supplier-display');
            const nameDiv = cell.querySelector('.supplier-name');
            const detailsDiv = cell.querySelector('.supplier-details');

            if (sel.value === '__custom__') {
                ta.style.display = 'block';
                if (display) display.style.display = 'none';
                ta.focus();
            }
            else if (sel.value === '__add_new__') {
                sel.value = '';
                showInlineSupplierForm();
            }
            else if (sel.value) {
                // Find supplier data and populate fields with line breaks
                const supplier = SUPPLIERS.find(s => s.id == sel.value);
                if (supplier) {
                    let supplierText = supplier.name || '';
                    const details = [];

                    if (supplier.address) {
                        details.push(supplier.address);
                    }
                    if (supplier.phone) {
                        details.push(supplier.phone);
                    }
                    if (supplier.notes) {
                        details.push(supplier.notes);
                    }
                    if (supplier.remarks) {
                        details.push(supplier.remarks);
                    }

                    // Set textarea value (for form submission)
                    if (details.length > 0) {
                        supplierText += '\n' + details.join('\n');
                    }
                    ta.value = supplierText;

                    // Show formatted display
                    if (nameDiv && detailsDiv && display) {
                        nameDiv.textContent = supplier.name || '';
                        detailsDiv.textContent = details.join('\n');
                        display.style.display = 'block';
                        ta.style.display = 'none';
                    } else {
                        // Fallback to textarea
                        ta.style.display = details.length > 0 ? 'block' : 'none';
                    }
                } else {
                    // Simple supplier name only
                    ta.value = sel.options[sel.selectedIndex]?.dataset.sname || '';
                    if (display) display.style.display = 'none';
                    ta.style.display = 'none';
                }
            }
            else {
                ta.style.display = 'none';
                if (display) display.style.display = 'none';
                ta.value = '';
            }

            // Update data-current attribute
            updateDataCurrentAttributes();
        }
        function renumber() {
            document.querySelectorAll('#voucher-body tr').forEach((tr, i) => {
                const numberSpan = tr.querySelector('.row-number');
                if (numberSpan) {
                    numberSpan.textContent = i + 1;
                } else {
                    tr.querySelector('.index-col').textContent = i + 1;
                }
            });
        }
        function addRow(autoFromMain) {
            const tbody = document.getElementById('voucher-body');
            const tr = document.createElement('tr');
            tr.className = 'sortable-row';
            tr.draggable = true;
            tr.innerHTML = `<td class="text-center index-col"><i class="fas fa-grip-vertical text-muted me-1" style="cursor:move"></i><span class="row-number"></span></td>
<td><input type="text" name="arrival" class="form-control form-control-sm date-input" placeholder="DD/MM/YYYY"/></td>
<td><input type="text" name="departure" class="form-control form-control-sm date-input" placeholder="DD/MM/YYYY"/></td>
<td class="supplier-cell">
    <select name="service_by_supplier" class="form-select form-select-sm mb-1" onchange="handleSupplierChange(this)"></select>
    <div class="supplier-display" style="display:none;">
        <div class="supplier-name" style="font-weight: 700;"></div>
        <div class="supplier-details" style="font-weight: normal; white-space: pre-wrap;"></div>
    </div>
    <textarea name="service_by" rows="2" class="form-control form-control-sm supplier-custom thai-text" style="display:none" placeholder="Custom supplier name" oninput="formatSupplierText(this)"></textarea>
</td>
<td><textarea name="type" rows="3" class="form-control form-control-sm thai-text"></textarea></td>
<td class="text-center"><button class="btn btn-link text-danger p-0" onclick="removeRow(this)"><i class='fas fa-times'></i></button></td>`;
            tbody.appendChild(tr); renumber(); initDatePickers(tr.querySelectorAll('.date-input'));
            // populate supplier options
            const sel = tr.querySelector('select[name="service_by_supplier"]'); sel.innerHTML = supplierOptionsHTML();
            if (autoFromMain) {
                const mainSel = document.getElementById('supplierSelect');
                if (mainSel && mainSel.value) sel.value = mainSel.value;
            }
            // Re-initialize sortable after adding new row
            initSortable();
        }
        // toggleCustomSupplier logic replaced by handleSupplierChange
        function removeRow(btn) { btn.closest('tr').remove(); renumber(); }
        function collectRows() { return Array.from(document.querySelectorAll('#voucher-body tr')).map(tr => { const sel = tr.querySelector('select[name="service_by_supplier"]'); const ta = tr.querySelector('textarea[name="service_by"]'); let serviceBy = ''; if (sel) { if (sel.value === '__custom__') serviceBy = ta.value.trim(); else if (sel.value) serviceBy = sel.options[sel.selectedIndex].dataset.sname || ''; else serviceBy = ta.value.trim(); } else { serviceBy = ta.value.trim(); } return { arrival: tr.querySelector('input[name="arrival"]').value.trim(), departure: tr.querySelector('input[name="departure"]').value.trim(), service_by: serviceBy, type: tr.querySelector('textarea[name="type"]').value.trim() }; }); }
        function initDatePickers(scopeEls) {
            const opts = { dateFormat: 'd/m/Y', allowInput: true, locale: flatpickr.l10ns.th };
            if (scopeEls) {
                scopeEls.forEach(el => { if (!el._flatpickr) { flatpickr(el, opts); } });
            } else {
                document.querySelectorAll('.date-input').forEach(el => { if (!el._flatpickr) { flatpickr(el, opts); } });
            }
        }
        window.addEventListener('DOMContentLoaded', () => {
            loadSuppliers();
            updateRowSupplierSelects();
            renumber();
            initSortable();
            initImageSortable();

            // Add event listeners for custom supplier textarea changes
            document.addEventListener('input', function (e) {
                if (e.target.matches('textarea[name="service_by"]')) {
                    // Update data-current attribute when custom supplier text changes
                    const select = e.target.parentElement.querySelector('select[name="service_by_supplier"]');
                    if (select && select.value === '__custom__') {
                        select.setAttribute('data-current', e.target.value.trim());
                    }
                }
            });

            // Auto fill signature dates with today (DD/MM/YY)
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yy = String(today.getFullYear()).slice(-2);
            document.querySelectorAll('.sig-date').forEach(span => span.textContent = `${dd}/${mm}/${yy}`);
            // Convert any existing ISO (YYYY-MM-DD) values into DD/MM/YYYY
            document.querySelectorAll('.date-input').forEach(inp => {
                const v = inp.value.trim();
                if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                    const [y, m, d] = v.split('-');
                    inp.value = `${d}/${m}/${y}`;
                }
            });
            // Basic input mask / validation on blur
            document.querySelectorAll('.date-input').forEach(inp => {
                inp.addEventListener('blur', () => {
                    let v = inp.value.trim();
                    if (!v) return;
                    const m = v.match(/^(\d{1,2})[\/](\d{1,2})[\/](\d{4})$/);
                    if (!m) { inp.classList.add('is-invalid'); return; } else { inp.classList.remove('is-invalid'); }
                    let d = m[1].padStart(2, '0'); let mo = m[2].padStart(2, '0'); let y = m[3];
                    if (+d < 1 || +d > 31 || +mo < 1 || +mo > 12) { inp.classList.add('is-invalid'); return; }
                    inp.value = `${d}/${mo}/${y}`;
                });
            });
            initDatePickers();
        });

        // Initialize sortable functionality for table rows
        function initSortable() {
            const tbody = document.getElementById('voucher-body');
            if (!tbody) return;

            // Simple drag and drop without external library
            let draggedElement = null;

            tbody.addEventListener('dragstart', function (e) {
                if (e.target.closest('.sortable-row')) {
                    draggedElement = e.target.closest('.sortable-row');
                    e.dataTransfer.effectAllowed = 'move';
                    draggedElement.style.opacity = '0.5';
                }
            });

            tbody.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            tbody.addEventListener('dragenter', function (e) {
                e.preventDefault();
            });

            tbody.addEventListener('drop', function (e) {
                e.preventDefault();
                const targetRow = e.target.closest('.sortable-row');
                if (targetRow && draggedElement && targetRow !== draggedElement) {
                    const rect = targetRow.getBoundingClientRect();
                    const nextSibling = (e.clientY - rect.top) > (rect.height / 2) ? targetRow.nextSibling : targetRow;
                    tbody.insertBefore(draggedElement, nextSibling);
                    renumber();
                }
            });

            tbody.addEventListener('dragend', function (e) {
                if (draggedElement) {
                    draggedElement.style.opacity = '';
                    draggedElement = null;
                }
            });
        }
        // collectRows simplified after supplier select removal (date values kept as entered DD/MM/YYYY)
        function collectRows() {
            return Array.from(document.querySelectorAll('#voucher-body tr')).map(tr => ({
                arrival: tr.querySelector('input[name="arrival"]').value.trim(),
                departure: tr.querySelector('input[name="departure"]').value.trim(),
                service_by: tr.querySelector('textarea[name="service_by"]').value.trim(),
                type: tr.querySelector('textarea[name="type"]').value.trim()
            }));
        }
</script>

<script>
        // Voucher Images Upload & Delete Logic (Multi-upload with sorting)
        function uploadVoucherImages() {
            const fileInput = document.getElementById('voucherImagesInput');
            if (!fileInput.files.length) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const files = Array.from(fileInput.files);
            const max = 1048576; // 1MB limit

            // Check file sizes
            for (const file of files) {
                if (file.size > max) {
                    alert(`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${file.name} ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏ô ${Math.round(max / 1024)} KB`);
                    return;
                }
            }

            const formData = new FormData();
            files.forEach(file => {
                formData.append('voucher_images', file);
            });

            fetch(window.location.pathname + '/upload-images', {
                method: 'POST',
                body: formData
            }).then(r => r.json())
                .then(data => {
                    if (data.success && data.images) {
                        const container = document.getElementById('voucherImagesContainer');
                        data.images.forEach((imageData, index) => {
                            const imageItem = createImageItem(imageData.url, imageData.id || `img_${Date.now()}_${index}`);
                            container.appendChild(imageItem);
                        });

                        // Clear input and preview
                        fileInput.value = '';
                        document.getElementById('voucherImagePreview').innerHTML = '';

                        // Re-initialize sortable
                        initImageSortable();

                        // Re-initialize image click events for new images
                        if (window.addImageClickEvents) {
                            window.addImageClickEvents();
                        }
                    } else {
                        alert(data.error || 'Upload failed');
                    }
                }).catch(e => {
                    console.error(e);
                    alert('Upload error');
                });
        }

        function createImageItem(imageSrc, imageId, title = '') {
            const div = document.createElement('div');
            div.className = 'voucher-image-item position-relative border rounded p-2';
            div.setAttribute('data-image-id', imageId);
            div.draggable = true;
            div.style.width = '200px';

            // Get current count for order badge
            const container = document.getElementById('voucherImagesContainer');
            const currentCount = container ? container.querySelectorAll('.voucher-image-item').length + 1 : 1;

            div.innerHTML = `
            <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                <span class="badge bg-primary image-order-badge">${currentCount}</span>
            </div>
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm image-title-input" 
                       placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)"
                       value="${title}"
                       onchange="updateImageTitle(this, '${imageId}')">
            </div>
            <div class="position-relative">
                <img src="${imageSrc}" style="width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fafafa;cursor:zoom-in;" />
                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0"
                    style="transform:translate(40%, -40%);" onclick="deleteVoucherImage(this, '${imageId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-center small mt-1">
                <i class="fas fa-grip-vertical text-muted"></i>
                <div class="text-muted" style="font-size: 0.7rem;">
                    <i class="fas fa-arrows-alt"></i> ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                </div>
            </div>
        `;

            return div;
        }

        function deleteVoucherImage(btn, imageId) {
            if (!confirm('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Voucher ‡∏ô‡∏µ‡πâ?')) return;

            fetch(window.location.pathname + '/delete-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_id: imageId })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    const imageItem = btn.closest('.voucher-image-item');
                    if (imageItem) imageItem.remove();
                } else {
                    alert(data.error || 'Delete failed');
                }
            }).catch(e => {
                console.error(e);
                alert('Delete error');
            });
        }

        // Initialize sortable for images with improved visual feedback
        function initImageSortable() {
            const container = document.getElementById('voucherImagesContainer');
            if (!container) return;

            let draggedElement = null;

            container.addEventListener('dragstart', function (e) {
                const item = e.target.closest('.voucher-image-item');
                if (item) {
                    draggedElement = item;
                    e.dataTransfer.effectAllowed = 'move';
                    item.classList.add('dragging');

                    // Show visual feedback
                    setTimeout(() => {
                        item.style.opacity = '0.5';
                    }, 0);
                }
            });

            container.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                const afterElement = getDragAfterElement(container, e.clientX);
                const targetItem = e.target.closest('.voucher-image-item');

                // Remove previous drag-over highlights
                container.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });

                // Highlight the target
                if (targetItem && targetItem !== draggedElement) {
                    targetItem.classList.add('drag-over');
                }
            });

            container.addEventListener('dragenter', function (e) {
                e.preventDefault();
            });

            container.addEventListener('dragleave', function (e) {
                const item = e.target.closest('.voucher-image-item');
                if (item) {
                    item.classList.remove('drag-over');
                }
            });

            container.addEventListener('drop', function (e) {
                e.preventDefault();

                // Remove all drag-over highlights
                container.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });

                const targetItem = e.target.closest('.voucher-image-item');
                if (targetItem && draggedElement && targetItem !== draggedElement) {
                    const rect = targetItem.getBoundingClientRect();
                    const nextSibling = (e.clientX - rect.left) > (rect.width / 2) ? targetItem.nextSibling : targetItem;
                    container.insertBefore(draggedElement, nextSibling);

                    // Save new order immediately
                    saveImageOrder();

                    // Show success feedback
                    showToast('Image order updated!', 'success');
                }
            });

            container.addEventListener('dragend', function (e) {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement.style.opacity = '';
                    draggedElement = null;
                }

                // Clean up any remaining highlights
                container.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            });
        }

        // Helper function to determine the element after which to insert
        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.voucher-image-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Toast notification helper
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px; animation: slideInRight 0.3s ease;';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function saveImageOrder() {
            const container = document.getElementById('voucherImagesContainer');
            const imageIds = Array.from(container.querySelectorAll('.voucher-image-item')).map(item =>
                item.getAttribute('data-image-id')
            );

            // Update order badges
            updateOrderBadges();

            console.log('üíæ Saving image order:', imageIds);

            fetch(window.location.pathname + '/reorder-images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_order: imageIds })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    console.log('‚úÖ Image order saved successfully');
                } else {
                    console.warn('‚ö†Ô∏è Failed to save image order:', data.error);
                    showToast('Failed to save image order', 'error');
                }
            }).catch(e => {
                console.error('‚ùå Error saving image order:', e);
                showToast('Error saving image order', 'error');
            });
        }

        // Update order badges after reordering
        function updateOrderBadges() {
            const container = document.getElementById('voucherImagesContainer');
            const items = container.querySelectorAll('.voucher-image-item');
            items.forEach((item, index) => {
                const badge = item.querySelector('.image-order-badge');
                if (badge) {
                    badge.textContent = index + 1;
                }
            });
        }

        document.getElementById('voucherImagesInput')?.addEventListener('change', function () {
            const preview = document.getElementById('voucherImagePreview');
            preview.innerHTML = '';

            Array.from(this.files).forEach(file => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement('div');
                        div.className = 'position-relative d-inline-block me-2 mb-2';
                        div.innerHTML = `
                        <img src="${e.target.result}" style="width:150px;height:auto;border:1px solid #ddd;padding:4px;background:#fafafa;" />
                        <div class="small text-center mt-1">${file.name}</div>
                    `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // Initialize image sortable on page load
        document.addEventListener('DOMContentLoaded', function () {
            initImageSortable();
            initImageZoom();
            initSupplierDisplays();
        });

        // Initialize supplier displays for existing rows
        function initSupplierDisplays() {
            document.querySelectorAll('#voucher-body tr').forEach(tr => {
                const select = tr.querySelector('select[name="service_by_supplier"]');
                if (select && select.value) {
                    // Trigger handleSupplierChange to format display
                    handleSupplierChange(select);
                }
            });
        }

        // Image Zoom Modal Functions
        function initImageZoom() {
            let currentZoom = 1;
            let isDragging = false;
            let startX, startY, scrollLeft, scrollTop;

            const modal = document.getElementById('imageZoomModal');
            const zoomedImage = document.getElementById('zoomedImage');
            const modalBody = modal.querySelector('.modal-body');

            // Add click event to all voucher images
            function addImageClickEvents() {
                document.querySelectorAll('.voucher-image-item img').forEach(img => {
                    img.style.cursor = 'zoom-in';
                    img.addEventListener('click', function (e) {
                        e.stopPropagation();
                        openImageModal(this.src);
                    });
                });
            }

            function openImageModal(imageSrc) {
                zoomedImage.src = imageSrc;
                currentZoom = 1;
                zoomedImage.style.transform = 'scale(1)';
                modalBody.scrollTop = 0;
                modalBody.scrollLeft = 0;

                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }

            // Zoom controls
            document.getElementById('zoomIn').addEventListener('click', () => {
                currentZoom = Math.min(currentZoom * 1.2, 5);
                zoomedImage.style.transform = `scale(${currentZoom})`;
                zoomedImage.style.cursor = currentZoom > 1 ? 'grab' : 'zoom-in';
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                currentZoom = Math.max(currentZoom / 1.2, 0.5);
                zoomedImage.style.transform = `scale(${currentZoom})`;
                zoomedImage.style.cursor = currentZoom > 1 ? 'grab' : 'zoom-in';
            });

            document.getElementById('zoomReset').addEventListener('click', () => {
                currentZoom = 1;
                zoomedImage.style.transform = 'scale(1)';
                zoomedImage.style.cursor = 'zoom-in';
                modalBody.scrollTop = 0;
                modalBody.scrollLeft = 0;
            });

            // Mouse wheel zoom
            modalBody.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                currentZoom = Math.max(0.5, Math.min(5, currentZoom * delta));
                zoomedImage.style.transform = `scale(${currentZoom})`;
                zoomedImage.style.cursor = currentZoom > 1 ? 'grab' : 'zoom-in';
            });

            // Pan functionality
            zoomedImage.addEventListener('mousedown', (e) => {
                if (currentZoom > 1) {
                    isDragging = true;
                    zoomedImage.style.cursor = 'grabbing';
                    startX = e.pageX - modalBody.offsetLeft;
                    startY = e.pageY - modalBody.offsetTop;
                    scrollLeft = modalBody.scrollLeft;
                    scrollTop = modalBody.scrollTop;
                }
            });

            modalBody.addEventListener('mouseleave', () => {
                isDragging = false;
                if (currentZoom > 1) {
                    zoomedImage.style.cursor = 'grab';
                }
            });

            modalBody.addEventListener('mouseup', () => {
                isDragging = false;
                if (currentZoom > 1) {
                    zoomedImage.style.cursor = 'grab';
                }
            });

            modalBody.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - modalBody.offsetLeft;
                const y = e.pageY - modalBody.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                modalBody.scrollLeft = scrollLeft - walkX;
                modalBody.scrollTop = scrollTop - walkY;
            });

            // Initialize click events for existing images
            addImageClickEvents();

            // Re-initialize when new images are added
            window.addImageClickEvents = addImageClickEvents;
        }

        // File Sharing Functions
        function toggleFileSharing() {
            const uploadArea = document.getElementById('file-upload-area');
            const toggleBtn = document.getElementById('toggle-file-btn');

            if (uploadArea.style.display === 'none') {
                uploadArea.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye me-1"></i>View';
                loadFiles();
            } else {
                uploadArea.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Edit';
            }
        }

        function toggleLinkSharing() {
            const linkArea = document.getElementById('link-add-area');
            const toggleBtn = document.getElementById('toggle-link-btn');

            if (linkArea.style.display === 'none') {
                linkArea.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye me-1"></i>View';
                loadLinks();
            } else {
                linkArea.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Edit';
            }
        }

        // Drag and Drop handlers
        function dragOverHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('border-success');
        }

        function dragEnterHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('border-success');
        }

        function dragLeaveHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('border-success');
        }

        function dropHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('border-success');

            const files = ev.dataTransfer.files;
            uploadFiles(files);
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            uploadFiles(files);
        }

        function uploadFiles(files) {
            if (files.length === 0) return;

            const formData = new FormData();
            const title = document.getElementById('file-title').value;

            for (let file of files) {
                formData.append('files', file);
            }
            if (title) {
                formData.append('title', title);
            }

            const progressDiv = document.getElementById('upload-progress');
            const progressBar = progressDiv.querySelector('.progress-bar');

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';

            fetch(`/voucher/api/{{ booking.id }}/files`, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    progressBar.style.width = '100%';
                    return response.json();
                })
                .then(data => {
                    progressDiv.style.display = 'none';
                    document.getElementById('file-title').value = '';
                    document.getElementById('file-input').value = '';

                    if (data.success) {
                        showMessage('Files uploaded successfully!', 'success');
                        loadFiles();
                    } else {
                        showMessage('Error uploading files: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    progressDiv.style.display = 'none';
                    console.error('Error:', error);
                    showMessage('Error uploading files', 'error');
                });
        }

        function loadFiles() {
            // First, generate booking share token
            fetch(`{{ url_for('voucher.generate_share_token', id=booking.id) }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ minutes: 172800 }) // 120 days
            })
                .then(r => r.json())
                .then(tokenData => {
                    if (!tokenData.success || !tokenData.token) {
                        throw new Error('Failed to generate share token');
                    }
                    const bookingToken = tokenData.token;

                    // Now load files with the token
                    return fetch(`/voucher/api/{{ booking.id }}/files`)
                        .then(response => response.json())
                        .then(data => {
                            const filesList = document.getElementById('files-list');

                            if (data.files && data.files.length > 0) {
                                console.log('üìÅ Loading files with booking token:', bookingToken);
                                let html = '<div class="row g-2">';
                                data.files.forEach(file => {
                                    // Use booking token for file download URL
                                    const shareUrl = `${window.location.origin}/public/voucher/file/${file.id}/${bookingToken}`;
                                    console.log('üîó Generated share URL for file', file.id, ':', shareUrl);
                                    html += `
                        <div class="col-12">
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h6 class="card-title mb-1">
                                                <i class="fas fa-file text-primary me-2"></i>
                                                ${file.title || file.original_filename}
                                            </h6>
                                            <small class="text-muted">${file.original_filename}</small>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-end align-items-center gap-2">
                                                <div class="input-group" style="max-width: 300px;">
                                                    <input type="text" class="form-control form-control-sm" 
                                                           value="${shareUrl}" readonly id="file-url-${file.id}">
                                                    <button class="btn btn-sm btn-outline-secondary" 
                                                            onclick="copyFileUrl(${file.id})" title="Copy Share URL">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <button onclick="editFileTitle(${file.id}, '${(file.title || file.original_filename).replace(/'/g, "\\'")}')" 
                                                        class="btn btn-sm btn-outline-info" title="Edit Title">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <a href="${shareUrl}" target="_blank"
                                                   class="btn btn-sm btn-outline-primary" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button onclick="deleteFile(${file.id})" 
                                                        class="btn btn-sm btn-outline-danger" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                                });
                                html += '</div>';
                                filesList.innerHTML = html;
                            } else {
                                filesList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <p>No files shared yet</p>
                    </div>
                `;
                            }
                        });
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    showMessage('Error loading files', 'error');
                });
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/voucher/api/{{ booking.id }}/files/${fileId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('File deleted successfully!', 'success');
                            loadFiles();
                        } else {
                            showMessage('Error deleting file', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Error deleting file', 'error');
                    });
            }
        }

        function addExternalLink(event) {
            event.preventDefault();

            const url = document.getElementById('link-url').value;
            const title = document.getElementById('link-title').value;

            fetch(`/voucher/api/{{ booking.id }}/links`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url, title })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Link added successfully!', 'success');
                        document.getElementById('add-link-form').reset();
                        loadLinks();
                    } else {
                        showMessage('Error adding link: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error adding link', 'error');
                });
        }

        function loadLinks() {
            fetch(`/voucher/api/{{ booking.id }}/links`)
                .then(response => response.json())
                .then(data => {
                    const linksList = document.getElementById('links-list');

                    if (data.links && data.links.length > 0) {
                        let html = '<div class="row g-2">';
                        data.links.forEach(link => {
                            const shareUrl = `${window.location.origin}/voucher/public/${link.public_token}/links`;
                            html += `
                        <div class="col-12">
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h6 class="card-title mb-1">
                                                <i class="fas fa-external-link-alt text-primary me-2"></i>
                                                ${link.title}
                                            </h6>
                                            <a href="${link.url}" target="_blank" class="text-decoration-none small text-muted">
                                                ${link.url}
                                            </a>
                                            ${link.description ? `<p class="mb-0 mt-1 small text-muted">${link.description.replace(/\n/g, '<br>')}</p>` : ''}
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-end align-items-center gap-2">
                                                <div class="input-group" style="max-width: 300px;">
                                                    <input type="text" class="form-control form-control-sm" 
                                                           value="${shareUrl}" readonly id="link-url-${link.id}">
                                                    <button class="btn btn-sm btn-outline-secondary" 
                                                            onclick="copyLinkUrl(${link.id})" title="Copy Share URL">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <button onclick="editLinkTitle(${link.id}, '${link.title.replace(/'/g, "\\'")}', '${(link.description || '').replace(/'/g, "\\'")}')" 
                                                        class="btn btn-sm btn-outline-info" title="Edit Title">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <a href="${link.url}" target="_blank" 
                                                   class="btn btn-sm btn-outline-primary" title="Visit Link">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                <button onclick="deleteLink(${link.id})" 
                                                        class="btn btn-sm btn-outline-danger" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                        });
                        html += '</div>';
                        linksList.innerHTML = html;
                    } else {
                        linksList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-link fa-2x mb-2"></i>
                        <p>No external links added yet</p>
                    </div>
                `;
                    }
                })
                .catch(error => {
                    console.error('Error loading links:', error);
                });
        }

        function deleteLink(linkId) {
            if (confirm('Are you sure you want to delete this link?')) {
                fetch(`/voucher/api/{{ booking.id }}/links/${linkId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('Link deleted successfully!', 'success');
                            loadLinks();
                        } else {
                            showMessage('Error deleting link', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Error deleting link', 'error');
                    });
            }
        }

        function copyFileUrl(fileId) {
            const input = document.getElementById(`file-url-${fileId}`);
            input.select();
            document.execCommand('copy');
            showMessage('File share URL copied to clipboard!', 'success');
        }

        function copyLinkUrl(linkId) {
            const input = document.getElementById(`link-url-${linkId}`);
            input.select();
            document.execCommand('copy');
            showMessage('Link share URL copied to clipboard!', 'success');
        }

        function showMessage(message, type) {
            // Create toast message
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
        `;
            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        // Edit file title function
        function editFileTitle(fileId, currentTitle) {
            const newTitle = prompt('Edit file title:', currentTitle);
            if (newTitle !== null && newTitle.trim() !== currentTitle) {
                fetch(`/voucher/api/{{ booking.id }}/files/${fileId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: newTitle.trim() })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('File title updated successfully!', 'success');
                            loadFiles(); // Reload files list
                        } else {
                            showMessage('Error updating file title: ' + data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating file title:', error);
                        showMessage('Error updating file title', 'error');
                    });
            }
        }

        // Edit link title and description function
        function editLinkTitle(linkId, currentTitle, currentDescription) {
            // Create a more sophisticated modal for editing
            const modalHtml = `
            <div class="modal fade" id="editLinkModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Link</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editLinkTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="editLinkTitle" value="${currentTitle}">
                            </div>
                            <div class="mb-3">
                                <label for="editLinkDescription" class="form-label">Description (Optional)</label>
                                <textarea class="form-control" id="editLinkDescription" rows="3">${currentDescription}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateLink(${linkId})">Update</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove any existing modal
            const existingModal = document.getElementById('editLinkModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editLinkModal'));
            modal.show();
        }

        // Update link function
        function updateLink(linkId) {
            const title = document.getElementById('editLinkTitle').value.trim();
            const description = document.getElementById('editLinkDescription').value.trim();

            if (!title) {
                alert('Title is required');
                return;
            }

            fetch(`/voucher/api/{{ booking.id }}/links/${linkId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    description: description
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Link updated successfully!', 'success');
                        loadLinks(); // Reload links list

                        // Hide modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editLinkModal'));
                        modal.hide();
                    } else {
                        showMessage('Error updating link: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error updating link:', error);
                    showMessage('Error updating link', 'error');
                });
        }

        // Initialize sharing features on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Voucher page loaded - Version: 2025-11-29-v2');
            console.log('üìã Loading files and links...');
            loadFiles();
            loadLinks();
            loadVoucherAlbums(); // Load voucher library albums
        });

        // Load voucher albums from library
        function loadVoucherAlbums() {
            console.log('üîÑ Loading voucher albums...');
            fetch('/voucher-library/api/list')
                .then(response => response.json())
                .then(data => {
                    console.log('üì¶ Voucher albums data received:', data);
                    const select = document.getElementById('voucherAlbumsSelect');
                    if (!select) {
                        console.warn('‚ö†Ô∏è voucherAlbumsSelect not found');
                        return;
                    }

                    select.innerHTML = ''; // Clear existing options

                    if (data.success && data.albums && data.albums.length > 0) {
                        console.log('‚úÖ Found', data.albums.length, 'albums');
                        data.albums.forEach(album => {
                            const option = document.createElement('option');
                            option.value = album.id;
                            option.textContent = `${album.title} (${album.file_size_mb} MB)`;
                            option.dataset.imagePath = album.image_path;
                            select.appendChild(option);
                        });

                        // Pre-select albums if booking has selected albums
                        const selectedIds = {{ booking.get_voucher_album_ids() | tojson if booking else '[]' }};
            console.log('üîç Selected album IDs from booking:', selectedIds);

            if (selectedIds && selectedIds.length > 0) {
                Array.from(select.options).forEach(option => {
                    if (selectedIds.includes(parseInt(option.value))) {
                        option.selected = true;
                    }
                });
                console.log('üìå Pre-selecting albums:', selectedIds);
                updateAlbumPreview();
            }
        } else {
            console.log('‚ÑπÔ∏è No albums available');
            const option = document.createElement('option');
            option.textContent = 'No albums available - Upload in Voucher Library';
            option.disabled = true;
            select.appendChild(option);
        }
    })
                .catch (error => {
        console.error('Error loading voucher albums:', error);
    });
        }

    // Update preview when selection changes
    document.addEventListener('DOMContentLoaded', function () {
        const select = document.getElementById('voucherAlbumsSelect');
        if (select) {
            console.log('‚úÖ Adding change listener to voucher albums select');
            select.addEventListener('change', function () {
                console.log('üîÑ Selection changed!');
                updateAlbumPreview();
            });
        } else {
            console.warn('‚ö†Ô∏è voucherAlbumsSelect not found');
        }
    });

    function updateAlbumPreview() {
        const select = document.getElementById('voucherAlbumsSelect');
        const preview = document.getElementById('selectedAlbumsPreview');

        console.log('üé® updateAlbumPreview called');

        if (!select || !preview) {
            console.warn('‚ö†Ô∏è Select or preview not found', { select, preview });
            return;
        }

        const selectedOptions = Array.from(select.selectedOptions);
        console.log('üìã Selected options:', selectedOptions.length, selectedOptions);

        if (selectedOptions.length > 0) {
            preview.style.display = 'flex';
            preview.innerHTML = '';
            console.log('üßπ Cleared preview, creating items...');

            selectedOptions.forEach((option, index) => {
                const imagePath = option.dataset.imagePath;
                const albumId = option.value;
                console.log(`üñºÔ∏è Creating preview ${index + 1}:`, option.textContent, 'albumId:', albumId, 'imagePath:', imagePath);

                if (imagePath) {
                    const div = document.createElement('div');
                    div.className = 'voucher-library-item position-relative border rounded p-2';
                    div.setAttribute('data-album-id', albumId);
                    div.draggable = true;
                    div.style.width = '180px';

                    const badgeHtml = `<div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                            <span class="badge bg-success library-order-badge">${index + 1}</span>
                        </div>`;

                    const imageHtml = `<img src="/static/${imagePath.replace('static/', '')}" 
                             style="width:100%;height:120px;object-fit:cover;border-radius:4px;" 
                             alt="${option.textContent}">`;

                    const textHtml = `<div class="text-center small text-truncate mt-2" style="font-size:0.75rem;">
                            ${option.textContent}
                        </div>
                        <div class="text-center text-muted" style="font-size: 0.65rem;">
                            <i class="fas fa-arrows-alt"></i> ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                        </div>`;

                    div.innerHTML = badgeHtml + imageHtml + textHtml;
                    preview.appendChild(div);
                    console.log(`‚úÖ Added item ${index + 1} to preview`);
                } else {
                    console.warn(`‚ö†Ô∏è No imagePath for option ${index + 1}`);
                }
            });

            console.log(`‚úÖ Preview created with ${preview.children.length} items, initializing sortable...`);
            // Initialize drag and drop for library items
            initLibraryImageSortable();
        } else {
            preview.style.display = 'none';
            preview.innerHTML = '';
            console.log('‚ÑπÔ∏è No options selected, hiding preview');
        }
    }

    // Initialize sortable for library images
    function initLibraryImageSortable() {
        const container = document.getElementById('selectedAlbumsPreview');
        if (!container) {
            console.warn('‚ö†Ô∏è Library preview container not found');
            return;
        }

        console.log('üîß Initializing library image sortable...');
        console.log('üì¶ Container has', container.children.length, 'items');

        // Check if already initialized
        if (container.dataset.sortableInit === 'true') {
            console.log('‚ÑπÔ∏è Sortable already initialized, skipping');
            return;
        }
        container.dataset.sortableInit = 'true';

        let draggedElement = null;

        container.addEventListener('dragstart', function (e) {
            const item = e.target.closest('.voucher-library-item');
            if (item) {
                console.log('üéØ Drag started for library image');
                draggedElement = item;
                e.dataTransfer.effectAllowed = 'move';
                item.classList.add('dragging');
                setTimeout(() => {
                    item.style.opacity = '0.5';
                }, 0);
            }
        });

        container.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const targetItem = e.target.closest('.voucher-library-item');

            container.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            if (targetItem && targetItem !== draggedElement) {
                targetItem.classList.add('drag-over');
            }
        });

        container.addEventListener('dragenter', function (e) {
            e.preventDefault();
        });

        container.addEventListener('dragleave', function (e) {
            const item = e.target.closest('.voucher-library-item');
            if (item) {
                item.classList.remove('drag-over');
            }
        });

        container.addEventListener('drop', function (e) {
            e.preventDefault();

            console.log('üì¶ Drop event on library image');

            container.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            const targetItem = e.target.closest('.voucher-library-item');
            if (targetItem && draggedElement && targetItem !== draggedElement) {
                const rect = targetItem.getBoundingClientRect();
                const nextSibling = (e.clientX - rect.left) > (rect.width / 2) ? targetItem.nextSibling : targetItem;
                container.insertBefore(draggedElement, nextSibling);

                // Update order badges and select element
                updateLibraryOrderBadgesAndSelect();

                if (typeof showToast === 'function') {
                    showToast('‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
                console.log('‚úÖ Library image order updated');
            }
        });

        container.addEventListener('dragend', function (e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement.style.opacity = '';
                draggedElement = null;
            }

            container.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        });

        console.log('‚úÖ Library sortable initialized with', container.children.length, 'draggable items');
    }    // Update order badges and reorder select element
    function updateLibraryOrderBadgesAndSelect() {
        const container = document.getElementById('selectedAlbumsPreview');
        const select = document.getElementById('voucherAlbumsSelect');
        if (!container || !select) return;

        const items = container.querySelectorAll('.voucher-library-item');
        const newOrder = [];

        items.forEach((item, index) => {
            const badge = item.querySelector('.library-order-badge');
            if (badge) {
                badge.textContent = index + 1;
            }

            const albumId = item.getAttribute('data-album-id');
            if (albumId) {
                newOrder.push(albumId);
            }
        });

        // Reorder select element options to match visual order
        Array.from(select.options).forEach(option => {
            option.selected = false;
        });

        newOrder.forEach(albumId => {
            const option = select.querySelector(`option[value="${albumId}"]`);
            if (option) {
                option.selected = true;
            }
        });
    }

</script>
{% endblock %}