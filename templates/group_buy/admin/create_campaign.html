{% extends "base.html" %}

{% block title %}สร้างแคมเปญ Group Buy{% endblock %}

{% block content %}
<div class="container-fluid" style="font-size: 90%;">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-plus-circle"></i> สร้างแคมเปญ Group Buy ใหม่</h1>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">ข้อมูลพื้นฐาน</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ชื่อแคมเปญ <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Flights & Hotels (เที่ยวบิน / โรงแรม):</label>
                            <textarea name="product_details" class="form-control" rows="3"
                                placeholder="รายละเอียดสินค้า เช่น รหัสทัวร์, ชื่อโรงแรม, เที่ยวบิน ฯลฯ"></textarea>
                            <small class="text-muted">ระบุรายละเอียดสินค้าเพิ่มเติม</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description - รายละเอียด:</label>
                            <textarea name="description" class="form-control" rows="4"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">ประเภทสินค้า <span class="text-danger">*</span></label>
                                <select name="product_type" class="form-select" required>
                                    <option value="Package">Package</option>
                                    <option value="Tour">Tour</option>
                                    <option value="Collective Groups">Collective Groups</option>
                                    <option value="Air Ticket">Air Ticket</option>
                                    <option value="Hotel">Hotel</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Park Ticket">Park Ticket</option>
                                    <option value="F.I.T.">F.I.T.</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">วันที่เดินทางไป</label>
                                <input type="text" name="travel_date_from" class="form-control datepicker"
                                    placeholder="DD/MM/YYYY">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">วันที่เดินทางกลับ</label>
                                <input type="text" name="travel_date_to" class="form-control datepicker"
                                    placeholder="DD/MM/YYYY">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">รูปภาพสินค้า (อัตราส่วน 1:1)</label>
                            <input type="file" name="product_image" class="form-control" accept="image/*">
                            <small class="text-muted">แนะนำขนาด 800x800 px หรือ 1:1 ratio</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Title ภาพ</label>
                            <input type="text" name="image_title" class="form-control"
                                placeholder="ข้อความที่จะแสดงด้านบนภาพ">
                            <small class="text-muted">ข้อความนี้จะแสดงบนรูปภาพสินค้า (ถ้ามี)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ตำแหน่ง Title ภาพ</label>
                            <select name="image_title_position" class="form-control">
                                <option value="left">ด้านซ้าย</option>
                                <option value="center">ตรงกลาง</option>
                                <option value="right">ด้านขวา</option>
                            </select>
                            <small class="text-muted">เลือกตำแหน่งที่ต้องการแสดง Title ภาพ</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Album ภาพเพิ่มเติม</label>
                            <input type="file" name="album_images" id="albumImages" class="form-control"
                                accept="image/*" multiple>
                            <small class="text-muted">เลือกได้หลายไฟล์พร้อมกัน</small>
                            <div id="albumTitlesContainer" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">ราคาและส่วนลด</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ราคาปกติ (บาท) <span class="text-danger">*</span></label>
                                <input type="number" name="regular_price" class="form-control" step="0.01" min="0.01"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ราคากลุ่ม (บาท) <span class="text-danger">*</span></label>
                                <input type="number" name="group_price" class="form-control" step="0.01" min="0.01"
                                    required>
                                <small class="text-muted">ส่วนลดจะคำนวณอัตโนมัติ</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">กฎการจัดกลุ่ม</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">จำนวนกลุ่มขั้นต่ำ/ต่อคณะ <span
                                        class="text-danger">*</span></label>
                                <input type="number" name="min_participants" class="form-control" value="4" min="1"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">จำนวนคนสูงสุดต่อกลุ่ม</label>
                                <input type="number" name="max_participants" class="form-control" min="0"
                                    placeholder="ไม่จำกัด">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ระยะเวลาในการรวมกลุ่ม (ชั่วโมง) <span
                                    class="text-danger">*</span></label>
                            <input type="number" name="duration_hours" class="form-control" value="48" min="1" required>
                            <small class="text-muted">กลุ่มจะหมดเวลาหากไม่ครบคนภายในเวลาที่กำหนด</small>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">วันที่และ Inventory</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">วันเริ่มแคมเปญ <span class="text-danger">*</span></label>
                                <input type="text" name="campaign_start_date" class="form-control datepicker"
                                    placeholder="DD/MM/YYYY" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">วันสิ้นสุดแคมเปญ <span class="text-danger">*</span></label>
                                <input type="text" name="campaign_end_date" class="form-control datepicker"
                                    placeholder="DD/MM/YYYY" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Inventory ทั้งหมด</label>
                                <input type="number" name="total_slots" class="form-control" min="0"
                                    placeholder="ไม่จำกัด">
                                <small class="text-muted"><strong>จำนวนกลุ่มที่รับได้สูงสุด</strong><br>
                                    ตัวอย่าง: ใส่ 7 = รับได้ไม่เกิน 7 กลุ่ม (เว้นว่างหากไม่จำกัด)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Pax (จำนวนผู้เดินทางสูงสุด)</label>
                                <input type="number" name="max_pax" class="form-control" min="0" placeholder="ไม่จำกัด">
                                <small class="text-muted"><strong>จำนวนคนทั้งหมดที่รับได้สูงสุด</strong><br>
                                    ตัวอย่าง: ใส่ 14 = รับได้ไม่เกิน 14 คน (เว้นว่างหากไม่จำกัด)</small>
                            </div>
                        </div>
                        <div class="alert alert-info" style="font-size: 0.9rem;">
                            <i class="fas fa-info-circle me-2"></i><strong>การจำกัด:</strong>
                            ระบบจะหยุดรับเมื่อถึงเงื่อนไขใดเงื่อนไขหนึ่ง<br>
                            • เมื่อมีกลุ่มสำเร็จครบตาม <strong>Inventory</strong> หรือ<br>
                            • เมื่อมีคนจองสำเร็จครบตาม <strong>Pax</strong>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">เงื่อนไขและหมายเหตุ</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">เงื่อนไขและข้อตกลง</label>
                            <textarea name="terms_and_conditions" class="form-control" rows="20">1. เงื่อนไขการเปิดดีล
การสั่งซื้อ/จองแบบ Group Buy จะสมบูรณ์เมื่อมีผู้เข้าร่วมครบตามจำนวนขั้นต่ำที่กำหนดภายในระยะเวลาที่ระบุไว้
หากไม่ครบจำนวนภายในเวลาที่กำหนด ดีลจะถือว่าไม่สำเร็จ

2. ราคาและสิทธิประโยชน์
ราคาพิเศษ Group Buy ใช้ได้เฉพาะกรณีดีลสำเร็จเท่านั้น
ไม่สามารถใช้ร่วมกับโปรโมชันหรือส่วนลดอื่นได้
สิทธิประโยชน์มีจำนวนจำกัด และให้สิทธิตามลำดับการชำระเงินก่อน

3. การชำระเงิน
ผู้เข้าร่วมต้องชำระเงินเต็มจำนวนหรือตามที่บริษัทฯกำหนดในขณะทำรายการ โดยไม่แจ้งให้ทราบล่วงหน้า
กรณีดีลไม่สำเร็จ บริษัทจะคืนเงินเต็มจำนวนโดยไม่มีค่าธรรมเนียม ภายในระยะเวลาที่กำหนด 
เมื่อดีลสำเร็จแล้ว การจองถือว่าสมบูรณ์

4. การยกเลิกและการคืนเงิน
เมื่อดีล Group Buy สำเร็จแล้ว ไม่สามารถยกเลิก แก้ไข หรือขอคืนเงินได้ทุกกรณี
หากผู้เข้าร่วมยกเลิกเองหลังดีลสำเร็จ จะถือว่าสละสิทธิ์โดยไม่คืนเงิน
การเปลี่ยนชื่อผู้ใช้บริการหรือผู้เดินทางเป็นไปตามเงื่อนไขของผู้ให้บริการหลัก

5. การเปลี่ยนแปลงบริการ
บริษัทขอสงวนสิทธิ์ในการเปลี่ยนแปลงรายละเอียดของสินค้า/บริการบางประการ
โดยจัดหาบริการที่มีมาตรฐานและคุณภาพเทียบเท่า
ในกรณีเกิดเหตุสุดวิสัย บริษัทขอสงวนสิทธิ์ในการเลื่อนหรือยกเลิกบริการตามความเหมาะสม

6. ระยะเวลาใช้งาน
สิทธิ์หรือ Voucher จาก Group Buy ต้องใช้งานภายในระยะเวลาที่กำหนด
หากไม่ใช้งานภายในเวลาที่กำหนด จะถือว่าสละสิทธิ์โดยไม่คืนเงิน

7. ข้อจำกัดและความรับผิดชอบ
ราคาพิเศษ Group Buy ไม่สามารถแยกใช้ โอนสิทธิ์ หรือเปลี่ยนเป็นเงินสดได้
บริษัทไม่รับผิดชอบค่าใช้จ่ายส่วนตัวหรือค่าใช้จ่ายที่อยู่นอกเหนือจากรายการที่ระบุไว้
ผู้เข้าร่วมมีหน้าที่ตรวจสอบรายละเอียดสินค้า/แพ็กเกจก่อนทำการชำระเงิน

8. การยอมรับเงื่อนไข
การเข้าร่วม Group Buy ถือว่าผู้ซื้อได้อ่าน เข้าใจ และยอมรับข้อกำหนดและเงื่อนไขทั้งหมดเรียบร้อยแล้ว

หมายเหตุ:
บริษัทขอสงวนสิทธิ์ในการเปลี่ยนแปลงข้อกำหนดและเงื่อนไขโดยไม่ต้องแจ้งให้ทราบล่วงหน้า</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุสำหรับ Admin</label>
                            <textarea name="admin_notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">การตั้งค่า</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input type="checkbox" name="is_active" class="form-check-input" id="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                เปิดใช้งาน
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" name="is_public" class="form-check-input" id="is_public" checked>
                            <label class="form-check-label" for="is_public">
                                แสดงต่อสาธารณะ
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" name="featured" class="form-check-input" id="featured">
                            <label class="form-check-label" for="featured">
                                <i class="fas fa-star text-warning"></i> Featured
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" name="allow_partial_payment" class="form-check-input"
                                id="allow_partial_payment">
                            <label class="form-check-label" for="allow_partial_payment">
                                อนุญาตให้จ่ายบางส่วน
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6>ตัวอย่าง:</h6>
                        <ul class="mb-0">
                            <li>ราคาปกติ 1,000 บาท</li>
                            <li>ราคากลุ่ม 750 บาท</li>
                            <li>ต้องมี 4 คน</li>
                            <li>ระยะเวลา 48 ชม.</li>
                            <li>➜ ส่วนลด 25%</li>
                        </ul>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-save"></i> สร้างแคมเปญ
                </button>
                <a href="{{ url_for('group_buy_admin.campaigns') }}" class="btn btn-secondary w-100 mt-2">
                    <i class="fas fa-times"></i> ยกเลิก
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap Datepicker -->
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
    $(document).ready(function () {
        // Initialize datepicker for all date inputs
        $('.datepicker').datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true,
            todayHighlight: true
        });

        // Handle album images file selection
        $('#albumImages').on('change', function (e) {
            const files = e.target.files;
            const container = $('#albumTitlesContainer');
            container.empty();

            if (files.length > 0) {
                container.append('<h6 class="mb-3">Title สำหรับแต่ละภาพ:</h6>');

                for (let i = 0; i < files.length; i++) {
                    const fileName = files[i].name;
                    container.append(`
                        <div class="mb-2">
                            <label class="form-label"><i class="fas fa-image"></i> ${fileName}</label>
                            <input type="text" name="album_titles" class="form-control" placeholder="Title สำหรับภาพนี้ (ถ้ามี)">
                        </div>
                    `);
                }
            }
        });
    });
</script>
{% endblock %}