#!/usr/bin/env python3
"""
Classic PDF Generator - เลียนแบบรูปแบบ PDF เดิม
ใช้ ReportLab ด้วย Thai font support เหมือนในไฟล์ตัวอย่าง
"""

import os
import logging
from datetime import datetime, timedelta
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4, letter
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch, mm
from reportlab.pdfgen import canvas
from reportlab.platypus.frames import Frame
from reportlab.platypus.doctemplate import PageTemplate, BaseDocTemplate
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.enums import TA_LEFT, TA_RIGHT, TA_CENTER, TA_JUSTIFY

logger = logging.getLogger(__name__)

class ClassicPDFGenerator:
    def __init__(self):
        """Initialize the Classic PDF Generator with Thai font support"""
        self.setup_thai_fonts()
        self.styles = self.create_styles()
        logger.info("Classic PDF Generator initialized with Thai fonts")

    def setup_thai_fonts(self):
        """Register Thai fonts with improved error handling"""
        try:
            from reportlab.pdfbase.ttfonts import TTFont
            from reportlab.pdfbase import pdfmetrics
            
            # Try different font paths
            font_paths = [
                'NotoSansThai-Regular.ttf',  # Current directory
                '../NotoSansThai-Regular.ttf',  # Parent directory
                os.path.join(os.path.dirname(__file__), '..', 'NotoSansThai-Regular.ttf')
            ]
            
            bold_font_paths = [
                'NotoSansThai-Bold.ttf',
                '../NotoSansThai-Bold.ttf', 
                os.path.join(os.path.dirname(__file__), '..', 'NotoSansThai-Bold.ttf')
            ]
            
            # Register regular font
            regular_registered = False
            for font_path in font_paths:
                if os.path.exists(font_path):
                    pdfmetrics.registerFont(TTFont('NotoSansThai-Regular', font_path))
                    logger.info(f"✅ Registered NotoSansThai-Regular from: {font_path}")
                    regular_registered = True
                    break
            
            # Register bold font
            bold_registered = False
            for font_path in bold_font_paths:
                if os.path.exists(font_path):
                    pdfmetrics.registerFont(TTFont('NotoSansThai-Bold', font_path))
                    logger.info(f"✅ Registered NotoSansThai-Bold from: {font_path}")
                    bold_registered = True
                    break
            
            if not regular_registered:
                logger.warning("⚠️ NotoSansThai-Regular.ttf not found - Thai text may not display correctly")
            if not bold_registered:
                logger.warning("⚠️ NotoSansThai-Bold.ttf not found - Bold Thai text may not display correctly")
                
            # Register font family for automatic bold handling
            if regular_registered and bold_registered:
                try:
                    pdfmetrics.registerFontFamily('NotoSansThai',
                        normal='NotoSansThai-Regular',
                        bold='NotoSansThai-Bold',
                        italic='NotoSansThai-Regular',
                        boldItalic='NotoSansThai-Bold')
                    logger.info("✅ Registered NotoSansThai font family")
                except Exception as e:
                    logger.warning(f"Font family registration failed: {e}")
                    
        except Exception as e:
            logger.error(f"❌ Error registering Thai fonts: {e}")
            logger.info("Will fall back to default fonts")

    def create_styles(self):
        """Create modern, beautiful paragraph styles with proper Thai font support"""
        styles = getSampleStyleSheet()
        
        # Modern color scheme
        primary_color = colors.HexColor('#2C3E50')    # Dark blue-grey
        accent_color = colors.HexColor('#3498DB')     # Blue
        success_color = colors.HexColor('#27AE60')    # Green
        text_color = colors.HexColor('#2C3E50')       # Dark grey
        
        # English styles with modern typography
        styles.add(ParagraphStyle(
            name='ModernEnglish',
            parent=styles['Normal'],
            fontName='Helvetica',
            fontSize=10,
            leading=14,
            textColor=text_color,
            spaceBefore=0,
            spaceAfter=4
        ))
        
        styles.add(ParagraphStyle(
            name='ModernEnglishBold',
            parent=styles['Normal'],
            fontName='Helvetica-Bold',
            fontSize=10,
            leading=14,
            textColor=primary_color,
            spaceBefore=0,
            spaceAfter=4
        ))
        
        styles.add(ParagraphStyle(
            name='ModernEnglishSmall',
            parent=styles['Normal'],
            fontName='Helvetica',
            fontSize=8,
            leading=11,
            textColor=text_color,
            spaceBefore=0,
            spaceAfter=2
        ))
        
        # Thai styles with proper font selection
        try:
            thai_font = 'NotoSansThai-Regular'
            thai_bold_font = 'NotoSansThai-Bold'
            
            styles.add(ParagraphStyle(
                name='ModernThai',
                parent=styles['Normal'],
                fontName=thai_font,
                fontSize=10,
                leading=12,  # Reduced leading for compact display
                textColor=text_color,
                spaceBefore=0,
                spaceAfter=2  # Reduced spacing
            ))
            
            styles.add(ParagraphStyle(
                name='ModernThaiBold',
                parent=styles['Normal'],
                fontName=thai_bold_font,
                fontSize=10,
                leading=12,  # Reduced leading for compact display
                textColor=primary_color,
                spaceBefore=0,
                spaceAfter=2  # Reduced spacing
            ))
            
            # Mixed content style - use English font for better number/English support
            styles.add(ParagraphStyle(
                name='ModernMixed',
                parent=styles['Normal'],
                fontName='Helvetica',  # Use Helvetica for numbers and English
                fontSize=10,
                leading=12,  # Compact leading
                textColor=text_color,
                spaceBefore=0,
                spaceAfter=2
            ))
            
        except Exception as e:
            logger.warning(f"Thai fonts not available, using fallback: {e}")
            # Fallback to default fonts
            styles.add(ParagraphStyle(
                name='ModernThai',
                parent=styles['Normal'],
                fontName='Helvetica',
                fontSize=10,
                leading=14,
                textColor=text_color,
                spaceBefore=0,
                spaceAfter=4
            ))
            
            styles.add(ParagraphStyle(
                name='ModernThaiBold',
                parent=styles['Normal'],
                fontName='Helvetica-Bold',
                fontSize=10,
                leading=14,
                textColor=primary_color,
                spaceBefore=0,
                spaceAfter=4
            ))
            
            # Terms & Conditions style with 15% smaller font size (10 -> 8.5)
            styles.add(ParagraphStyle(
                name='ModernThaiTerms',
                parent=styles['Normal'],
                fontName=thai_font,
                fontSize=8.5,  # Reduced by 15% from 10
                leading=10,   # Adjusted leading proportionally
                textColor=text_color,
                spaceBefore=0,
                spaceAfter=1  # Minimal spacing
            ))
        
        # Header styles with modern design
        styles.add(ParagraphStyle(
            name='ModernTitle',
            parent=styles['Normal'],
            fontName='Helvetica-Bold',
            fontSize=18,
            leading=22,
            alignment=TA_CENTER,
            textColor=primary_color,
            spaceBefore=10,
            spaceAfter=15
        ))
        
        styles.add(ParagraphStyle(
            name='ModernSubtitle',
            parent=styles['Normal'],
            fontName='Helvetica-Bold',
            fontSize=12,
            leading=16,
            textColor=accent_color,
            spaceBefore=8,
            spaceAfter=6
        ))
        
        styles.add(ParagraphStyle(
            name='CompanyHeader',
            parent=styles['Normal'],
            fontName='Helvetica-Bold',
            fontSize=12,
            leading=14,
            alignment=TA_LEFT,
            textColor=primary_color,
            spaceBefore=0,
            spaceAfter=5
        ))
        
        # Keep original styles for backward compatibility
        styles.add(ParagraphStyle(
            name='EnglishNormal',
            parent=styles['ModernEnglish']
        ))
        
        styles.add(ParagraphStyle(
            name='ThaiNormal',
            parent=styles['ModernThai']
        ))
        
        styles.add(ParagraphStyle(
            name='EnglishSmall',
            parent=styles['ModernEnglishSmall']
        ))
        
        styles.add(ParagraphStyle(
            name='ServiceProposalTitle',
            parent=styles['ModernTitle']
        ))
        
        styles.add(ParagraphStyle(
            name='SectionHeader',
            parent=styles['ModernSubtitle']
        ))
        
        return styles

    def has_thai_text(self, text):
        """Enhanced Thai text detection"""
        if not text:
            return False
        
        # Check for Thai Unicode range
        thai_chars = 0
        total_chars = 0
        
        for char in str(text):
            if char.isalpha():  # Only count alphabetic characters
                total_chars += 1
                if '\u0e00' <= char <= '\u0e7f':  # Thai Unicode range
                    thai_chars += 1
        
        # If more than 10% of alphabetic characters are Thai, consider it Thai text
        if total_chars > 0:
            thai_ratio = thai_chars / total_chars
            return thai_ratio > 0.1
        
        return False

    def get_appropriate_style(self, text, style_type='normal'):
        """Get appropriate style based on text content and type"""
        has_thai = self.has_thai_text(text)
        
        if style_type == 'bold':
            return 'ModernThaiBold' if has_thai else 'ModernEnglishBold'
        elif style_type == 'small':
            return 'ModernEnglishSmall'  # Use English small for mixed content
        else:
            # Use Thai font for Thai text, Mixed font for numbers/English heavy content
            if has_thai:
                return 'ModernThai'
            else:
                return 'ModernMixed'  # Better for numbers and English

    def format_mixed_text(self, text):
        """Format text with mixed Thai/English fonts inline (expects pre-cleaned text)"""
        if not text:
            return ""
        
        import re
        
        # Use text as-is (should already be cleaned by caller)
        clean_text = str(text)
        
        # If text has Thai characters, use font mixing
        if self.has_thai_text(clean_text):
            # Wrap English letters and numbers with Helvetica font
            # This regex finds sequences of English letters, numbers, spaces, and common punctuation
            pattern = r'([a-zA-Z0-9\s\.,\-\+\(\)\[\]\{\}\:\;\@\#\$\%\&\*\!\?\"\'\`\~\/\\]+)'
            
            def replace_english(match):
                english_text = match.group(1)
                # Only wrap if it contains actual letters or numbers
                if re.search(r'[a-zA-Z0-9]', english_text):
                    return f'<font name="Helvetica">{english_text}</font>'
                return english_text
            
            mixed_text = re.sub(pattern, replace_english, clean_text)
            return mixed_text
        else:
            # Pure English/numbers - use Helvetica
            return f'<font name="Helvetica">{clean_text}</font>'

    def create_mixed_paragraph(self, text, style_name='ModernThai'):
        """Create paragraph with mixed font support and proper line break handling"""
        if not text:
            return Paragraph("", self.styles['ModernThai'])
        
        # First clean HTML tags and convert to newlines
        cleaned_text = self.clean_html_tags(text)
        
        # Convert newlines back to <br/> for ReportLab Paragraph rendering
        # ReportLab Paragraph requires <br/> tags, not \n characters
        cleaned_text = cleaned_text.replace('\n', '<br/>')
        
        # Apply font mixing
        mixed_text = self.format_mixed_text(cleaned_text)
        return Paragraph(mixed_text, self.styles[style_name])
    
    def create_terms_paragraph(self, text):
        """Create paragraph for Terms & Conditions with smaller font"""
        if not text:
            return Paragraph("", self.styles['ModernThai'])
        
        # Add inline font size for smaller Terms text (15% smaller)
        mixed_text = self.format_mixed_text(text)
        # Wrap with smaller font size tag
        small_text = f'<font size="8.5">{mixed_text}</font>'
        return Paragraph(small_text, self.styles['ModernThai'])

    def format_text_with_font(self, text, style_type='normal'):
        """Format text with appropriate font and return Paragraph object"""
        if not text:
            return Paragraph("", self.styles['ModernThai'])  # Use Thai font as default
        
        style_name = self.get_appropriate_style(text, style_type)
        
        # Clean and format the text
        clean_text = self.clean_html_tags(str(text))
        
        try:
            return Paragraph(clean_text, self.styles[style_name])
        except Exception as e:
            logger.warning(f"Error creating paragraph with style {style_name}: {e}")
            # Fallback to Thai style for better mixed content support
            return Paragraph(clean_text, self.styles['ModernThai'])

    def clean_html_tags(self, text):
        """Clean HTML tags from text and handle line breaks properly"""
        if not text:
            return ""
        
        import re
        
        # Convert text to string
        text = str(text)
        
        # CRITICAL: Handle line breaks FIRST before any other processing
        # Convert Windows line endings (\r\n) to <br/> tags first
        text = text.replace('\r\n', '<br/>')
        text = text.replace('\r', '<br/>')  
        text = text.replace('\n', '<br/>')
        
        # Convert HTML line breaks and paragraph tags
        text = re.sub(r'<br\s*/?>', '<br/>', text, flags=re.IGNORECASE)
        text = re.sub(r'<p\s*>', '<br/>', text, flags=re.IGNORECASE)
        text = re.sub(r'</p\s*>', '<br/>', text, flags=re.IGNORECASE)
        
        # Convert pipes to line breaks (for flight info)
        text = text.replace('|', '<br/>')
        
        # Remove all other HTML tags
        clean = re.compile('<(?!br/)[^>]*>')
        text = re.sub(clean, '', text)
        
        # Convert <br/> tags to actual newlines
        text = text.replace('<br/>', '\n')
        
        # Clean up multiple consecutive newlines
        text = re.sub(r'\n{3,}', '\n\n', text)  # 3+ newlines → 2 newlines  
        text = re.sub(r'\n{2}', '\n', text)     # 2 newlines → 1 newline
        
        # Remove leading/trailing whitespace but preserve internal newlines
        lines = text.split('\n')
        clean_lines = [line.strip() for line in lines]
        
        # Remove empty lines at start and end only
        while clean_lines and not clean_lines[0]:
            clean_lines.pop(0)
        while clean_lines and not clean_lines[-1]:
            clean_lines.pop()
            
        return '\n'.join(clean_lines)
        # Process in correct order: specific patterns first, then general ones
        
        # URL encoded line breaks (before other processing)
        text = text.replace('%0D%0A', '<br/>')                        # URL encoded 

        text = text.replace('%0A', '<br/>')                           # URL encoded 

        text = text.replace('%0D', '<br/>')                           # URL encoded 
        
        # Unicode line break characters
        text = text.replace('\u2028', '<br/>')                        # Line Separator
        text = text.replace('\u2029', '<br/>')                        # Paragraph Separator
        text = text.replace('\u000A', '<br/>')                        # Line Feed
        text = text.replace('\u000D', '<br/>')                        # Carriage Return
        text = text.replace('\u000C', '<br/>')                        # Form Feed
        
        # HTML tags (process before actual line endings) - CRITICAL ORDER
        text = re.sub(r'<p\s*>', '<br/>', text, flags=re.IGNORECASE)     # Opening P tags (FIRST)
        text = re.sub(r'</p\s*>', '<br/>', text, flags=re.IGNORECASE)    # Closing P tags  
        text = re.sub(r'<br\s*/?>', '<br/>', text, flags=re.IGNORECASE)  # Normalize br tags
        text = re.sub(r'</br\s*>', '<br/>', text, flags=re.IGNORECASE)   # Handle closing br (including typo)
        text = re.sub(r'<div\s*/?>', '<br/>', text, flags=re.IGNORECASE) # Div tags
        text = re.sub(r'</div>', '<br/>', text, flags=re.IGNORECASE)     # Closing div tags
        text = re.sub(r'<li\s*/?>', '<br/>', text, flags=re.IGNORECASE)  # List items
        text = re.sub(r'</li>', '<br/>', text, flags=re.IGNORECASE)      # Closing li tags
        
        # Escaped characters (process first before actual line endings convert them)
        text = text.replace('
', '<br/>')                         # Escaped Windows line endings
        text = text.replace('

', '<br/>')                        # Escaped combinations
        text = text.replace('\/n', '<br/>')                          # Double escaped newline
        text = text.replace('\/r', '<br/>')                          # Double escaped carriage return
        text = text.replace('
', '<br/>')                            # Escaped newlines
        text = text.replace('
', '<br/>')                           # Escaped carriage return
        
        # DEBUG: Print before line ending conversion
        print(f"DEBUG clean_html_tags BEFORE line endings: {repr(text)}")
        
        # Actual line endings (after escaped ones) - CRITICAL CONVERSION
        text = text.replace('
', '<br/>')                          # Windows line endings
        text = text.replace('
', '<br/>')                            # Mac line endings
        text = text.replace('
', '<br/>')                            # Unix line endings
        
        # DEBUG: Print after line ending conversion
        print(f"DEBUG clean_html_tags AFTER line endings: {repr(text)}")
        
        # Common typos and variations
        text = text.replace('/r/n', '<br/>')                          # Typo combinations (before single chars)
        text = text.replace('/n', '<br/>')                             # Common typo for 

        text = text.replace('/r', '<br/>')                            # Typo for 
        
        # Enter key representations
        text = re.sub(r'\[enter\]', '<br/>', text, flags=re.IGNORECASE)
        text = re.sub(r'\<enter\>', '<br/>', text, flags=re.IGNORECASE)
        text = re.sub(r'&lt;enter&gt;', '<br/>', text, flags=re.IGNORECASE)
        text = re.sub(r'\{enter\}', '<br/>', text, flags=re.IGNORECASE)
        text = re.sub(r'\(enter\)', '<br/>', text, flags=re.IGNORECASE)
        
        # PIPE CHARACTER HANDLING - Convert pipes to line breaks (CRITICAL FOR FLIGHT INFO)
        # Handle multiple types of pipe separators
        text = text.replace('|', '<br/>')                             # Single pipe (PRIMARY FIX)
        text = text.replace('||', '<br/>')                            # Double pipe
        text = re.sub(r'\s*\|\s*', '<br/>', text)                     # Pipe with spaces
        
        # Special characters that might represent line breaks
        text = text.replace('|n|', '<br/>')                           # Pipe notation
        text = text.replace('###', '<br/>')                           # Hash notation
        text = text.replace('---', '<br/>')                           # Dash notation
        
        # Remove all other HTML tags except our normalized br tags
        clean = re.compile('<(?!br/)[^>]*>')
        text = re.sub(clean, '', text)
        
        # Convert br tags to actual line breaks for PDF rendering
        text = text.replace('<br/>', '
')
        
        # DEBUG: Print after br to newline conversion
        print(f"DEBUG clean_html_tags AFTER br to newline: {repr(text)}")
        
        # Clean up multiple consecutive line breaks but preserve intentional line breaks
        # Replace 3+ consecutive newlines with 2 (paragraph break)
        # Replace 2 consecutive newlines with 1 (single line break)
        import re
        text = re.sub(r'
{3,}', '

', text)  # 3+ newlines → 2 newlines (paragraph)
        text = re.sub(r'
{2}', '
', text)     # 2 newlines → 1 newline (single break)
        
        # Clean up extra whitespace but preserve ALL intentional line breaks
        lines = text.split('
')
        clean_lines = []
        for line in lines:
            stripped = line.strip()
            # Keep ALL lines including empty ones for proper line breaks
            clean_lines.append(stripped)
        
        # Remove only leading/trailing empty lines, preserve internal ones
        while clean_lines and not clean_lines[0]:
            clean_lines.pop(0)
        while clean_lines and not clean_lines[-1]:
            clean_lines.pop()
        
        result = '
'.join(clean_lines)
        
        # DEBUG: Print final result
        print(f"DEBUG clean_html_tags FINAL: {repr(result)}")
        
        return result

    def format_text_with_font(self, text, use_thai=None):
        """Format text with appropriate font based on content, supporting mixed languages"""
        if not text:
            return ""
        
        clean_text = self.clean_html_tags(text)
        
        # Auto-detect if we should use Thai font
        if use_thai is None:
            use_thai = self.has_thai_text(clean_text)
        
        # For mixed language support, use Thai font if any Thai characters present
        if use_thai:
            # Enhanced mixed language support - use font face for better rendering
            style_name = 'ModernThai'
            # Use font face attribute for better mixed language support
            formatted_text = f'<font name="NotoSansThai-Regular" face="NotoSansThai-Regular">{clean_text}</font>'
        else:
            # Pure English content
            style_name = 'ModernEnglish'
            formatted_text = f'<font name="Helvetica" face="Helvetica">{clean_text}</font>'
        
        return Paragraph(formatted_text, self.styles[style_name])

    def calculate_duration(self, start_date, end_date):
        """Calculate duration between two dates"""
        try:
            if isinstance(start_date, str):
                start_dt = datetime.strptime(start_date, '%Y-%m-%d')
            else:
                start_dt = start_date
                
            if isinstance(end_date, str):
                end_dt = datetime.strptime(end_date, '%Y-%m-%d')
            else:
                end_dt = end_date
                
            duration = (end_dt - start_dt).days + 1
            return duration
        except:
            return 1
    
    def get_validity_date(self):
        """Get validity date (7 days from now)"""
        validity_date = datetime.now() + timedelta(days=7)
        return validity_date.strftime('%d/%m/%Y')
    
    def clean_html_tags(self, text):
        """Clean HTML tags from text while preserving line breaks"""
        if not text:
            return ""
        
        # Convert common HTML entities
        import html
        text = html.unescape(text)
        
        # Replace HTML line breaks with actual line breaks
        text = text.replace('<br>', '\n').replace('<br/>', '\n').replace('<br />', '\n')
        text = text.replace('<p>', '\n').replace('</p>', '\n')
        
        # Remove remaining HTML tags
        import re
        clean = re.compile('<.*?>')
        text = re.sub(clean, '', text)
        
        # Clean up multiple newlines and spaces
        text = re.sub(r'\n\s*\n', '\n\n', text)
        text = re.sub(r' +', ' ', text)
        
        return text.strip()

    def format_text_with_font(self, text, style_type='normal'):
        """Format text with appropriate font and return Paragraph object"""
        if not text:
            return Paragraph("", self.styles['ModernThai'])
        
        style_name = self.get_appropriate_style(text, style_type)
        
        # Clean and format the text
        clean_text = self.clean_html_tags(str(text))
        
        try:
            return Paragraph(clean_text, self.styles[style_name])
        except Exception as e:
            logger.warning(f"Error creating paragraph with style {style_name}: {e}")
            # Fallback to Thai style for better mixed content support
            return Paragraph(clean_text, self.styles['ModernThai'])

    def has_thai_text(self, text):
        """Check if text contains Thai characters"""
        if not text:
            return False
        for char in text:
            if '\u0e00' <= char <= '\u0e7f':  # Thai Unicode range
                return True
        return False

    def generate_pdf(self, booking_data, products=None, output_path=None):
        """Generate classic style PDF matching the target sample format exactly"""
        
        # Use provided output path or generate a default one
        if not output_path or not os.path.dirname(output_path):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            booking_ref = booking_data.get('booking_id', 'UNK')
            output_path = f"static/generated/classic_service_proposal_{booking_ref}_{timestamp}.pdf"
            
        # Ensure output directory exists
        output_dir = os.path.dirname(output_path)
        if output_dir:  # Only create directory if there's a directory path
            os.makedirs(output_dir, exist_ok=True)
        
        logger.info(f"Generating classic service proposal for booking: {booking_data.get('guest_name', 'Unknown')}")
        
        # Create PDF document with optimized margins for single page layout
        doc = SimpleDocTemplate(
            output_path,
            pagesize=A4,
            topMargin=10*mm,     # Reduced from 15mm to 10mm (1.0cm)
            bottomMargin=10*mm,
            leftMargin=15*mm,
            rightMargin=15*mm
        )
        
        story = []
        
        # Header Section - Company Info and Logo (modern design)
        try:
            # Try to load logo
            logo_path = "dcts-logo-vou.png"
            if os.path.exists(logo_path):
                from reportlab.lib.utils import ImageReader
                logo_img = Image(logo_path, width=45*mm, height=22*mm)
                
                # Modern company header with better typography
                company_info = """
<para align=left><b><font color="#2C3E50" size=12>DHAKUL CHAN TRAVEL SERVICE (THAILAND) CO.,LTD.</font></b><br/>
<font color="#7F8C8D" size=9>710, 716, 704, 706 Prachauthit Road, Samseenook, Huai Kwang, Bangkok 10310</font><br/>
<font color="#7F8C8D" size=9>Tel: +662 2744218 | +662 0266525 Fax: +662 0266525 Press 5 | Line: @dhakulchan</font><br/>
<font color="#3498DB" size=9>Website: www.dhakulchan.net | T.A.T License 11/03659</font></para>
                """
                
                # Header table with modern spacing
                header_data = [
                    [logo_img, Paragraph(company_info.strip(), self.styles['ModernMixed'])]
                ]
                
                header_table = Table(header_data, colWidths=[55*mm, 120*mm])
                header_table.setStyle(TableStyle([
                    ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                    ('ALIGN', (0, 0), (0, 0), 'LEFT'),
                    ('ALIGN', (1, 0), (1, 0), 'LEFT'),
                    ('TOPPADDING', (0, 0), (-1, -1), 0),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 2),  # Reduced from 8 to 2
                    ('LEFTPADDING', (0, 0), (-1, -1), 0),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 0),
                ]))
                story.append(header_table)
            else:
                # Fallback header without logo (modern style)
                company_header = """
<para align=center><font color="#2C3E50" size=14><b>DHAKUL CHAN TRAVEL SERVICE (THAILAND) CO.,LTD.</b></font><br/>
<font color="#7F8C8D" size=10>710, 716, 704, 706 Prachauthit Road, Samseenook, Huai Kwang, Bangkok 10310</font></para>
                """
                story.append(Paragraph(company_header.strip(), self.styles['ModernMixed']))
                story.append(Spacer(1, 2))  # Reduced from 8 to 2
        except Exception as e:
            logger.warning(f"Could not load logo: {e}")
            # Fallback header
            story.append(Paragraph("DHAKUL CHAN TRAVEL SERVICE (THAILAND) CO.,LTD.", self.styles['CompanyHeader']))
            story.append(Spacer(1, 2))  # Reduced from 8 to 2
        
        # Main content layout - moved closer to header (0.5cm from header)
        story.append(Spacer(1, 5))  # Reduced from 10 to 5 (approximately 0.5cm)
        
        # Main content layout matching the sample exactly
        story.append(Spacer(1, 10))
        
        # Top row: Party Name + Service Proposal + Reference (modern styling)
        # Get actual party name from booking data (remove status)
        party_name = booking_data.get('guest_name', 'TRR251022')
        
        top_row_data = [
            [
                self.create_mixed_paragraph(f"<font color='#2C3E50'><b>Party Name:</b></font> {party_name}"),
                Paragraph("<font color='#3498DB' size=16><b>Service Proposal</b></font>", self.styles['ModernTitle']),
                self.create_mixed_paragraph(f"<font color='#2C3E50'><b>Reference:</b></font> {booking_data.get('booking_id', 'BK20250830LNN7')}<br/><font color='#8E44AD'><b>Booking Type:</b></font> park-ticket")
            ]
        ]
        
        top_table = Table(top_row_data, colWidths=[60*mm, 60*mm, 55*mm])
        top_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'TOP'),
            ('ALIGN', (0, 0), (0, 0), 'LEFT'),
            ('ALIGN', (1, 0), (1, 0), 'CENTER'),
            ('ALIGN', (2, 0), (2, 0), 'LEFT'),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
            # Remove all borders for Service Proposal section
            # No borders, no background
        ]))
        story.append(top_table)
        story.append(Spacer(1, 4))  # Reduced spacing
        
        # Bottom row with borders: Create Date | Traveling Period | Customer | PAX
        # Use customer_name from database instead of guest_name
        customer_name = booking_data.get('customer_name', booking_data.get('guest_name', 'วินไชย ใจดี'))
        customer_paragraph = self.format_text_with_font(customer_name, 'normal')
        
        bottom_row_data = [
            [
                Paragraph("<font color='#2C3E50'><b>Create Date</b></font>", self.styles['ModernEnglishBold']),
                Paragraph("<font color='#2C3E50'><b>Traveling Period</b></font>", self.styles['ModernEnglishBold']),
                Paragraph("<font color='#2C3E50'><b>Customer Name</b></font>", self.styles['ModernEnglishBold']),
                Paragraph("<font color='#2C3E50'><b>PAX</b></font>", self.styles['ModernEnglishBold'])
            ],
            [
                self.create_mixed_paragraph(f"{booking_data.get('booking_date', '30.AUG.2025')}<br/><font color='#7F8C8D'>By: admin</font>"),
                self.create_mixed_paragraph(f"{booking_data.get('start_date', '25 Nov 2025')} - {booking_data.get('end_date', '28 Nov 2025')}"),
                # Create a table cell with proper Thai font rendering
                Table([
                    [customer_paragraph],
                    [Paragraph(f"<font color='#7F8C8D'>Tel. {booking_data.get('guest_phone', '+66-83-456-7890')}</font>", self.styles['ModernEnglishSmall'])]
                ], colWidths=[40*mm]),
            [
                self.create_mixed_paragraph(f"<font color='#27AE60'><b>{booking_data.get('pax', 3)} pax</b></font><br/>Adult {booking_data.get('adults', 2)} / Child {booking_data.get('children', 1)}<br/>/ Infant {booking_data.get('infants', 1)}")
            ]
            ]
        ]
        
        bottom_table = Table(bottom_row_data, colWidths=[43.75*mm, 43.75*mm, 43.75*mm, 43.75*mm])
        bottom_table.setStyle(TableStyle([
            ('VALIGN', (0, 0), (-1, -1), 'TOP'),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('TOPPADDING', (0, 0), (-1, -1), 4),  # ลดจาก 6 เป็น 4
            ('BOTTOMPADDING', (0, 0), (-1, -1), 4),  # ลดจาก 10 เป็น 4
            ('LEFTPADDING', (0, 0), (-1, -1), 6),  # ลดจาก 8 เป็น 6
            ('RIGHTPADDING', (0, 0), (-1, -1), 8),
            # Modern grid styling
            ('GRID', (0, 0), (-1, -1), 1.5, colors.HexColor('#BDC3C7')),
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#ECF0F1')),  # Header row background
            ('LINEBELOW', (0, 0), (-1, 0), 2, colors.HexColor('#3498DB')),  # Header underline
        ]))
        story.append(bottom_table)
        story.append(Spacer(1, 18))
        
        # Service Detail / Itinerary Section
        story.append(Paragraph("<font color='#2C3E50' size=12><b>Service Detail / Itinerary:</b></font>", self.styles['ModernSubtitle']))
        service_detail = booking_data.get('description', 'No service details available')
        if service_detail:
            # Clean HTML tags and preserve line breaks
            cleaned_detail = self.clean_html_tags(service_detail)
            # Use mixed paragraph for better font handling
            service_paragraph = self.create_mixed_paragraph(cleaned_detail)
            story.append(service_paragraph)
        story.append(Spacer(1, 6))
        
        # Flight Information Section
        story.append(Paragraph("<font color='#2C3E50' size=12><b>Flight Information:</b></font>", self.styles['ModernSubtitle']))
        flight_info = booking_data.get('flight_info', '')
        if flight_info and flight_info.strip() and flight_info.strip() not in ['No flight information', 'No flight information available']:
            # Clean HTML tags and use mixed paragraph for better font handling
            cleaned_flight = self.clean_html_tags(flight_info)
            flight_paragraph = self.create_mixed_paragraph(cleaned_flight)
            story.append(flight_paragraph)
        else:
            # If no flight info, display a dash or minimal placeholder
            story.append(Paragraph("—", self.styles['ModernEnglish']))
        story.append(Spacer(1, 6))
        
        # Payment Information Section (modern design)
        story.append(Paragraph("<font color='#2C3E50' size=12><b>Payment Information:</b></font>", self.styles['ModernSubtitle']))
        story.append(Spacer(1, 4))
        
        # Modern payment table with better styling
        payment_headers = [
            Paragraph("<font color='#2C3E50'><b>No.</b></font>", self.styles['ModernEnglishSmall']),
            Paragraph("<font color='#2C3E50'><b>Products</b></font>", self.styles['ModernEnglishSmall']),
            Paragraph("<font color='#2C3E50'><b>Quantity</b></font>", self.styles['ModernEnglishSmall']),
            Paragraph("<font color='#2C3E50'><b>Price (THB)</b></font>", self.styles['ModernEnglishSmall']),
            Paragraph("<font color='#2C3E50'><b>Amount (THB)</b></font>", self.styles['ModernEnglishSmall'])
        ]
        payment_data = [payment_headers]
        
        # Add products or default items with better formatting
        if products and len(products) > 0:
            for i, product in enumerate(products, 1):
                qty = product.get('quantity', 1)
                price = product.get('price', 0)
                # Use amount from database if available, otherwise calculate
                amount = product.get('amount', qty * price)
                
                # Color coding for negative amounts (discounts)
                amount_color = '#E74C3C' if amount < 0 else '#27AE60'
                price_color = '#E74C3C' if price < 0 else '#2C3E50'
                
                # Create mixed paragraph for product name with smaller font
                product_name = product.get('name', 'N/A')
                mixed_product_text = self.format_mixed_text(product_name)
                small_product_text = f'<font size="10">{mixed_product_text}</font>'
                product_paragraph = Paragraph(small_product_text, self.styles['ModernThai'])
                
                payment_data.append([
                    Paragraph(f"<font color='#2C3E50' size='10'><b>{i}</b></font>", self.styles['ModernEnglishSmall']),
                    product_paragraph,
                    Paragraph(f"<font color='#2C3E50' size='10'><b>{qty}</b></font>", self.styles['ModernEnglishSmall']),
                    Paragraph(f"<font color='{price_color}' size='10'><b>{price:,.2f}</b></font>", self.styles['ModernEnglishSmall']),
                    Paragraph(f"<font color='{amount_color}' size='10'><b>{amount:,.2f}</b></font>", self.styles['ModernEnglishSmall'])
                ])
        else:
            # Default sample data with modern styling
            default_items = [
                ['1', 'ADT', '1', '5,000.00', '10,000.00'],
                ['2', 'CHD', '1', '2,500.00', '2,500.00'],
                ['3', 'INF', '1', '1,000.00', '1,000.00'],
                ['4', 'Discount', '1', '-200.00', '-200.00']
            ]
            
            for item in default_items:
                row_color = '#E74C3C' if item[4].startswith('-') else '#27AE60'
                payment_data.append([
                    Paragraph(f"<font color='#2C3E50'><b>{item[0]}</b></font>", self.styles['ModernEnglishSmall']),
                    Paragraph(f"<font color='#2C3E50'>{item[1]}</font>", self.styles['ModernEnglishSmall']),
                    Paragraph(f"<font color='#2C3E50'>{item[2]}</font>", self.styles['ModernEnglishSmall']),
                    Paragraph(f"<font color='{row_color}'>{item[3]}</font>", self.styles['ModernEnglishSmall']),
                    Paragraph(f"<font color='{row_color}'><b>{item[4]}</b></font>", self.styles['ModernEnglishSmall'])
                ])
        
        payment_table = Table(payment_data, colWidths=[15*mm, 80*mm, 25*mm, 30*mm, 30*mm])
        payment_table.setStyle(TableStyle([
            # Clean header styling without heavy background
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#F8F9FA')),  # Very light grey instead of blue
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.HexColor('#2C3E50')),   # Dark text instead of white
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 9),
            ('ALIGN', (0, 0), (0, -1), 'CENTER'),  # No. column
            ('ALIGN', (2, 0), (-1, -1), 'CENTER'),  # Quantity, Price, Amount columns
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),     # Products column
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 8),
            # Clean border styling
            ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#BDC3C7')),
            ('LINEBELOW', (0, 0), (-1, 0), 1, colors.HexColor('#BDC3C7')),  # Subtle header line
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('TOPPADDING', (0, 0), (-1, -1), 4),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 4),
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
            # Remove alternating backgrounds for cleaner look
        ]))
        story.append(payment_table)
        story.append(Spacer(1, 3))  # Minimal spacing
        
        # Grand Total with modern styling
        total_amount = booking_data.get('price', 13300.00)
        story.append(Paragraph(f"<font color='#27AE60' size=14><b>Grand Total: THB {total_amount:,.2f}</b></font>", self.styles['ModernEnglishBold']))
        story.append(Spacer(1, 6))  # Reduced spacing
        
        # Special Requests section
        story.append(Paragraph("<font color='#2C3E50' size=12><b>Special Requests:</b></font>", self.styles['ModernSubtitle']))
        special_request = booking_data.get('special_request', '')
        if special_request and special_request.strip() and special_request.strip() not in ['No special requests', 'No special request']:
            # Clean HTML tags and use mixed paragraph for better font handling
            cleaned_request = self.clean_html_tags(special_request)
            request_paragraph = self.create_mixed_paragraph(cleaned_request)
            story.append(request_paragraph)
        else:
            # If no special requests, display a dash or minimal placeholder
            story.append(Paragraph("—", self.styles['ModernEnglish']))
        story.append(Spacer(1, 6))  # Reduced spacing
        
        # Terms & Conditions with new content as per image
        terms_header = Table([
            [Paragraph('<font color="#2C3E50" size="12"><b>Terms & Conditions:</b></font>', 
                      self.styles['ModernSubtitle'])]
        ], colWidths=[175*mm])  # Use full width for terms header
        
        terms_header.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#F8F9FA')),  # Very light background
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('TOPPADDING', (0, 0), (-1, -1), 3),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 3),
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
        ]))
        
        story.append(terms_header)
        story.append(Spacer(1, 4))
        
        # New Terms & Conditions content - ลบข้อ 7-9 ตามที่ร้องขอ
        new_terms = [
            "เอกสารฉบับนี้เป็นใบเสนอราคาเพื่อใช้ในการดำเนินการจอง",
            "ราคาและรายละเอียดอาจมีการเปลี่ยนแปลงได้โปรดให้การอ่วงหน้า วันกว่าจะได้รับการยืนยัน",
            "กรุณายืนยันการจองโดยชำระเงินมัดจำ เพื่อให้ราคาคงเดิมและรักษาสิทธิ์ในการจอง",
            "ในเสนอราคานี้มีอายุ 4 ชั่วโมง นับจากวันและเวลาที่ออก เว้นแต่จะระบุเป็นอย่างอื่น",
            "การเปลี่ยนแปลงวันที่เดินทาง จำนวนผู้เดินทาง หรือรายละเอียดบริการใดฯ อาจมีผลต่อราคา",
            "หากมีการเปลี่ยนแปลง กรุณาแจ้งล่วงหน้าอย่างน้อย 72 ชั่วโมง หรือเร็วที่สุด"
        ]
        
        for i, term in enumerate(new_terms, 1):
            # Create numbered format with mixed font support using smaller Terms style
            numbered_term = f"{i}. {term}"
            # Use new terms paragraph creation for smaller font
            term_paragraph = self.create_terms_paragraph(numbered_term)
            story.append(term_paragraph)
            # No spacing between lines for maximum compactness
        
        story.append(Spacer(1, 2))  # Minimal spacing for single-page optimization
        
        # Remove footer - no footer content added
        # Footer section completely removed as requested
        
        # Build PDF
        doc.build(story)
        
        logger.info(f"✅ Classic PDF generated: {output_path}")
        return output_path
