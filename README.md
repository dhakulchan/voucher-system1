# ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå (Tour Voucher Management System)

‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏¢ Flask ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Invoice Ninja API

## ‚ú® ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å

### ÔøΩ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£ PDF ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
- QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
- ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏ö‡∏±‡∏ï‡∏£

### üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå

### üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á

### üåê ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤
- ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
- ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå

### üí∞ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Invoice Ninja
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô

### üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥

## üõ†Ô∏è ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ

- **Backend**: Flask, Python 3.8+
- **Database**: MySQL
- **Frontend**: Bootstrap 5, HTML5, CSS3
- **PDF Generation**: ReportLab
- **QR Codes**: qrcode library
- **API Integration**: Invoice Ninja REST API
- **Email**: SMTP integration

## üßæ Logging & Observability

‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å `print()` ‡πÑ‡∏õ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö logging ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå `utils/logging_config.py`).

### ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Log Level
‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö log ‡∏ú‡πà‡∏≤‡∏ô environment variable `LOG_LEVEL` (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: INFO)

‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤: DEBUG, INFO, WARNING, ERROR, CRITICAL

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
```bash
export LOG_LEVEL=DEBUG
python run.py
```

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î log:
```
YYYY-MM-DD HH:MM:SS,mmm | LEVEL    | package.module | message
```

### ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
- DEBUG: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå / caching / sanitized HTML
- INFO: ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF, ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå)
- WARNING: ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á (‡∏ü‡∏≠‡∏ô‡∏ï‡πå fallback, ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Invoice Ninja ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà critical)
- ERROR: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)

## üî§ Thai Font System & Fallback

‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á (NotoSansThai) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô `static/fonts/` ‡∏´‡∏£‡∏∑‡∏≠ `fonts/`
2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï download ‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î `NotoSansThai-Regular.ttf` ‡πÅ‡∏•‡∏∞ `NotoSansThai-Bold.ttf`
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì sha256 ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
4. Cache ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á I/O ‡∏ã‡πâ‡∏≥)
5. ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‚Üí fallback ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Thonburi / DejaVuSans / Helvetica ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö

‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏Å: `services/font_utils.py` (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `ensure_thai_fonts`) ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô `services/pdf_generator.py`.

### ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô `static/fonts/` ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà (cache ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏ã‡∏™‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠ restart):
```bash
rm -f static/fonts/NotoSansThai-*.ttf
export LOG_LEVEL=DEBUG
python run.py
```
‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô log: `Downloaded font NotoSansThai-Regular.ttf ...`

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢
| ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ | ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ | ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ |
|-------|--------|-----------|
| ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° | ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î | ‡∏ï‡∏£‡∏ß‡∏à log WARNING/ERROR ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏ü‡∏•‡πå |
| PDF ‡πÑ‡∏ó‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ä‡πâ font ‡∏≠‡∏∑‡πà‡∏ô | ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° glyph | ‡∏ï‡∏£‡∏ß‡∏à fallback chain ‡πÉ‡∏ô log |
| ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ä‡πâ‡∏≤ | Network ‡∏ä‡πâ‡∏≤ / GitHub timeout | ‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô `static/fonts/` |

## üß™ Sanitized HTML ‡πÉ‡∏ô PDF
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ `_clean_simple_html` ‡πÉ‡∏ô `pdf_generator` ‡∏à‡∏∞:
- ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏Å: b, strong, i, em, u, br, p, ul, ol, li
- ‡∏ï‡∏±‡∏î script/style/iframe/object/embed/meta/link
- ‡∏•‡∏ö event handlers (`onclick="..."` ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô)
- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô `javascript:` ‡πÅ‡∏•‡∏∞ `data:` URI
‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ä‡∏∏‡∏î `allowed` ‡πÉ‡∏ô‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á


## üìã Requirements

### System Requirements
- Python 3.8+
- MySQL 5.7+ or MariaDB 10.2+
- 1GB RAM minimum
- 500MB disk space

### Python Dependencies
See `requirements.txt` for complete list:
- Flask 2.3.3
- Flask-SQLAlchemy 3.0.5
- Flask-Login 0.6.3
- MySQL-connector-python 8.1.0
- ReportLab 4.0.4
- qrcode[pil] 7.4.2

## üöÄ Quick Start

### 1. Clone & Setup
```bash
cd /Applications/python/voucher-ro_v1.0
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 2. Database Setup
```sql
-- Create MySQL database
CREATE DATABASE tour_voucher_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'voucher_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON tour_voucher_db.* TO 'voucher_user'@'localhost';
FLUSH PRIVILEGES;
```

### 3. Environment Configuration
Copy `.env` file and update with your settings:
```bash
cp .env .env.local
# Edit .env.local with your database and API credentials
```

### 4. Initialize Database
```bash
python run.py
# This will create all tables and an admin user
```

### 5. Run Application
```bash
python run.py
# Access at http://localhost:5000
```

**Default Admin Login:**
- Username: `admin`
- Password: `admin123`

## üìÅ Project Structure

```
voucher-ro_v1.0/
‚îú‚îÄ‚îÄ app.py                 # Flask application factory
‚îú‚îÄ‚îÄ run.py                 # Application runner
‚îú‚îÄ‚îÄ config.py              # Configuration settings
‚îú‚îÄ‚îÄ requirements.txt       # Python dependencies
‚îú‚îÄ‚îÄ .env                   # Environment variables
‚îú‚îÄ‚îÄ models/                # Database models
‚îÇ   ‚îú‚îÄ‚îÄ user.py           # User authentication
‚îÇ   ‚îú‚îÄ‚îÄ customer.py       # Customer management
‚îÇ   ‚îî‚îÄ‚îÄ booking.py        # Booking system
‚îú‚îÄ‚îÄ routes/                # Application routes
‚îÇ   ‚îú‚îÄ‚îÄ auth.py           # Authentication routes
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.py      # Dashboard & analytics
‚îÇ   ‚îú‚îÄ‚îÄ booking.py        # Booking management
‚îÇ   ‚îú‚îÄ‚îÄ voucher.py        # Voucher generation
‚îÇ   ‚îî‚îÄ‚îÄ api.py            # REST API endpoints
‚îú‚îÄ‚îÄ services/              # Business logic
‚îÇ   ‚îú‚îÄ‚îÄ invoice_ninja.py  # Invoice Ninja integration
‚îÇ   ‚îú‚îÄ‚îÄ pdf_generator.py  # PDF generation
‚îÇ   ‚îú‚îÄ‚îÄ qr_generator.py   # QR code generation
‚îÇ   ‚îî‚îÄ‚îÄ email_service.py  # Email functionality
‚îú‚îÄ‚îÄ utils/                 # Utility functions
‚îÇ   ‚îî‚îÄ‚îÄ booking_utils.py  # Booking helpers
‚îú‚îÄ‚îÄ templates/             # HTML templates
‚îÇ   ‚îú‚îÄ‚îÄ base.html         # Base template
‚îÇ   ‚îú‚îÄ‚îÄ auth/             # Authentication pages
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/        # Dashboard pages
‚îÇ   ‚îú‚îÄ‚îÄ booking/          # Booking management
‚îÇ   ‚îî‚îÄ‚îÄ voucher/          # Voucher pages
‚îî‚îÄ‚îÄ static/               # Static files
    ‚îú‚îÄ‚îÄ generated/        # Generated PDFs
    ‚îî‚îÄ‚îÄ qr_codes/         # QR code images
```

## ÔøΩ PDF Font Configuration

Environment flags:


Run example:
```bash
PDF_DISABLE_FONT_SUBSETTING=true PDF_PREDOWNLOAD_FONTS=true python run.py
```

To re-download fonts manually:
```bash
rm -f static/fonts/NotoSansThai-*.ttf
PDF_PREDOWNLOAD_FONTS=true python run.py
```

Tests include `test_pdf_no_square_glyphs.py` to ensure no square/bullet placeholder glyphs remain.

## ÔøΩüîå API Integration

## PDF Generation
... existing content ...

### PDF Configuration Environment Variables
The PDF layer can be tuned at runtime using the following environment variables (all optional). Boolean values accept 1/0, true/false, yes/no (case‚Äëinsensitive).

| Variable | Default | Description |
|----------|---------|-------------|
| PDF_DISABLE_FONT_SUBSETTING | false | When true, disable ReportLab font subsetting to retain full glyph sets (larger file size, safer for Thai/CJK). |
| PDF_PREDOWNLOAD_FONTS | true | Attempt to download required Noto fonts on startup. |
| PDF_FORCE_EMBED_FONTS | false | Forces embedding of all fallback fonts by adding invisible glyph usage to guarantee inclusion. |
| PDF_FALLBACK_FONTS | ThaiFont,NotoSansThai,NotoSansThai-Regular,DejaVuSans,Helvetica,Times-Roman | Ordered list scanned when selecting a font for Thai/CJK text blocks. |
| PDF_FONT_DIR | (unset) | Directory scanned for all .ttf files to auto‚Äëregister (names derived from filename). |
| PDF_ENABLE_COMPRESSION | true | Toggle ReportLab page compression (affects file size). |
| PDF_QR_CACHE_TTL | 0 | Seconds to cache generated QR PNGs (0 = no cache). |
| PDF_TABLE_ZEBRA | true | Enable zebra striping for voucher/service tables. |
| PDF_TERMS_LIST_STYLE | number | Terms bullet style: number | dash | none. |
| PDF_ALLOWED_TAGS | b,strong,i,em,u,br,p,ul,ol,li | Override sanitization whitelist (intersection with safe superset). |

Example (.env):
```
PDF_DISABLE_FONT_SUBSETTING=true
PDF_FORCE_EMBED_FONTS=true
PDF_FALLBACK_FONTS=ThaiFont,NotoSansThai,DejaVuSans
PDF_TABLE_ZEBRA=false
PDF_TERMS_LIST_STYLE=dash
PDF_ALLOWED_TAGS=b,strong,br,p
PDF_QR_CACHE_TTL=86400
```

### QR Cache Cleanup
If QR caching is enabled (`PDF_QR_CACHE_TTL` > 0), PNG files accumulate under `static/qr_codes`.
Utility script: `python -m utils.qr_cache_cleanup`.

Commands:
```
python -m utils.qr_cache_cleanup --dry-run   # show what would be removed
python -m utils.qr_cache_cleanup            # delete expired files
python -m utils.qr_cache_cleanup --ttl 3600 # override TTL for this run
```
Example cron (daily 02:00):
```
0 2 * * * /usr/bin/python /path/to/app/utils/qr_cache_cleanup.py >> /var/log/qr_cleanup.log 2>&1
```
TTL = 0 means no caching (script removes nothing).


### Font Fallback Logic
Whenever Thai (U+0E00‚ÄìU+0E7F) or basic CJK (U+4E00‚ÄìU+9FFF) characters are detected in a paragraph, the generator attempts to switch to the first registered font in `PDF_FALLBACK_FONTS` to ensure glyph coverage.

#### Detailed Font Strategy
Flow:
1. Register built‚Äëin / downloaded fonts (Thai, optionally external directory) at startup.
2. For each paragraph / text block: scan for Thai or CJK codepoints.
3. If found, iterate `PDF_FALLBACK_FONTS` in order; first registered name wins.
4. If none found and Thai only, fall back to `NotoSansThai` if registered.
5. If still none, stay with base font (may produce missing glyphs ‚Üí visible as tofu; covered by tests).

You can add a CJK capable font by mounting a directory and setting:
```
PDF_FONT_DIR=/opt/fonts
PDF_FALLBACK_FONTS=NotoSansCJKsc-Regular,NotoSansThai,DejaVuSans,Helvetica
```
Place `NotoSansCJKsc-Regular.ttf` inside `/opt/fonts`.

Utility `utils/pdf_fonts.py` centralizes selection logic so both voucher and simple generators stay consistent.

### Multi‚ÄëScript (Thai + CJK + Latin) Support
Tests (`test_multiscript_fonts.py`) validate that a single PDF can contain Thai + Chinese (or other CJK) + Latin text without tofu squares. The test logic now:
* SKIP (not fail) automatically if no CJK font is registered.
* ASSERT presence of Thai + at least one Han character + Latin tokens when a CJK font is present.

Quick setup:
1. Download a CJK font (examples):
  * Noto Sans CJK SC: `NotoSansCJKsc-Regular.otf`
  * Noto Sans CJK TC: `NotoSansCJKtc-Regular.otf`
  * Source Han Sans (Adobe) variant
2. Place the file into a directory, e.g. `fonts/` at project root.
3. Export environment variables BEFORE running tests:
```
export PDF_FONT_DIR=$(pwd)/fonts
export PDF_FALLBACK_FONTS=NotoSansCJKsc-Regular,NotoSansThai,DejaVuSans,Helvetica
export PDF_DISABLE_FONT_SUBSETTING=true      # (optional but improves reliability of glyph extraction)
export PDF_FORCE_EMBED_FONTS=true            # (optional; ensures font fully embedded)
```
4. Run only the multi‚Äëscript test:
```
make multiscript-check
```
5. (Optional) Inspect fonts actually embedded:
```
python -m utils.font_inventory static/generated/*.pdf | grep Font
```

Troubleshooting:
| Symptom | Cause | Fix |
|---------|-------|-----|
| Test skipped | No CJK font registered | Verify `PDF_FONT_DIR` & filename ends with .ttf/.otf |
| Chinese glyphs missing | Subsetting removed glyphs | Disable subsetting + force embed |
| File size large | Full embedding of large CJK font | Re‚Äëenable subsetting or use a subset font |
| Still tofu squares | Wrong font family (no Han glyphs) | Use NotoSansCJK or SourceHan Sans |

CI Hint: If you want the multi‚Äëscript test to always run in CI, add the font to the repo or fetch it in a setup step, then export the env vars in the CI job.

### Performance Benchmarking
Script: `scripts/pdf_benchmark.py`
Measures combinations of three toggles:
* `PDF_ENABLE_COMPRESSION`
* `PDF_TABLE_ZEBRA`
* `PDF_FORCE_EMBED_FONTS`

Metrics per combination (voucher & simple generators): mean, median, p95, p99 time (ms) and average file size (bytes).

Run quick benchmark (3 runs each):
```
python scripts/pdf_benchmark.py --runs 3
```
Artifacts:
```
scripts/benchmark_output/pdf_benchmark.csv
scripts/benchmark_output/pdf_benchmark.md
```

Makefile target:
```
make benchmark      # runs with --runs 3
```

For higher statistical confidence (‚â•5 runs):
```
python scripts/pdf_benchmark.py --runs 10
```

### Font Inventory Utility
Inspect which font resource names appear inside a generated PDF (heuristic):
```
python -m utils.font_inventory static/generated/your_file.pdf
```
Useful to confirm fallback / embedding decisions.

### Developer Workflow Enhancements
Pre-commit hooks included (.pre-commit-config.yaml): black, ruff (auto-fix), and a fast pytest subset.
Install:
```
pip install pre-commit
pre-commit install
```
Run manually on all files:
```
pre-commit run --all-files
```

### Sanitization
Simple HTML sanitizer removes disallowed tags/attributes, strips event handlers, and normalizes newlines to `<br/>`. To allow an additional tag, add it to `PDF_ALLOWED_TAGS` (must still be in the internal safe set).

### Invoice Ninja Setup
1. Install Invoice Ninja or use hosted version
2. Generate API token in Settings > Account Management
3. Update `.env` with your Invoice Ninja URL and token

### API Endpoints
- `POST /api/customers` - Create customer
- `POST /api/bookings` - Create booking
- `POST /api/invoice-ninja/quote` - Create quote
- `POST /api/invoice-ninja/invoice` - Create invoice

## üìä Usage Guide

### Creating a Tour Voucher
1. **Login** to admin dashboard
2. **Create Customer** (if new)
3. **Create Booking** with tour type
4. **Generate Quote/Invoice** via Invoice Ninja
5. **Generate Tour Voucher PDF** with QR code
6. **Email or Print** voucher

### Hotel Reservation Order
1. Create booking with type "hotel"
2. Fill hotel details (name, dates, room type)
3. Generate Hotel RO PDF
4. Send to hotel for confirmation

### MPV Transport Booking
1. Create booking with type "transport"
2. Set pickup/destination details
3. Generate MPV booking PDF
4. Confirm with transport provider

## üé® Customization

### Company Branding
Update `config.py` with your company details:
```python
COMPANY_NAME = "Your Travel Company"
COMPANY_ADDRESS = "Your Address"
COMPANY_PHONE = "+66-xxx-xxx-xxx"
COMPANY_EMAIL = "info@yourcompany.com"
```

### PDF Templates
Modify `services/pdf_generator.py` to customize:
- Layout and styling
- Company logos
- Additional fields
- QR code positioning

### Email Templates
Edit `services/email_service.py` for:
- Custom email content
- HTML templates
- Attachment handling

## üöÄ Deployment

### Production Setup
1. Use production MySQL database
2. Set `FLASK_ENV=production`
3. Configure reverse proxy (Nginx/Apache)
4. Use WSGI server (Gunicorn/uWSGI)
5. Set up SSL certificates

### Docker Deployment
```bash
# Build image
docker build -t tour-voucher-system .

# Run with environment variables
docker run -p 5000:5000 --env-file .env tour-voucher-system
```

## üîí Security

- Password hashing with Werkzeug
- Session management with Flask-Login
- SQL injection prevention with SQLAlchemy
- CSRF protection with Flask-WTF
- Environment variable configuration

## üìù API Documentation

### Authentication
All API endpoints require authentication via session cookies or API tokens.

### Booking API
```bash
# Create booking
curl -X POST http://localhost:5000/api/bookings \
  -H "Content-Type: application/json" \
  -d '{
    "customer_id": 1,
    "booking_type": "tour",
    "total_amount": 1500.00,
    "guest_list": ["John Doe", "Jane Doe"]
  }'
```

### Invoice Ninja Integration
```bash
# Create quote
curl -X POST http://localhost:5000/api/invoice-ninja/quote \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": 1,
    "items": [{
      "product_key": "TOUR001",
      "description": "Bangkok City Tour",
      "cost": 1500.00,
      "quantity": 1
    }]
  }'
```

## üêõ Troubleshooting

### Common Issues

1. **Database Connection Error**
   - Check MySQL service is running
   - Verify credentials in `.env`
   - Ensure database exists

2. **PDF Generation Failed**
   - Install ReportLab: `pip install reportlab`
   - Check file permissions in `static/generated/`

3. **QR Code Error**
   - Install qrcode: `pip install qrcode[pil]`
   - Verify PIL/Pillow installation

4. **Email Sending Failed**
   - Check SMTP settings in `.env`
   - Verify email credentials
   - Test with `EmailService.test_email_connection()`

### Debug Mode
Run with debug enabled:
```bash
export FLASK_ENV=development
python run.py
```

## ü§ù Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/new-feature`)
3. Commit changes (`git commit -am 'Add new feature'`)
4. Push to branch (`git push origin feature/new-feature`)
5. Create Pull Request

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

## üìû Support

For support and questions:
- Email: support@dhakulchan.com
- Phone: +66-xxx-xxx-xxx

## üôè Acknowledgments

- Flask community for excellent framework
- Invoice Ninja for API integration
- Bootstrap team for responsive UI components
- ReportLab for PDF generation capabilities

---

**Built with ‚ù§Ô∏è for the tourism industry**
# voucher-system1
# voucher-system1
# voucher-system1
# voucher-system1
# voucher-system1
# voucher-system1
