from flask import Blueprint, request, jsonify
from flask_login import login_required, current_user
from models.customer import Customer
from models.booking import Booking
from extensions import db
from services.invoice_ninja import InvoiceNinjaService
from utils.booking_utils import generate_booking_reference
import json

api_bp = Blueprint('api', __name__)

@api_bp.route('/docs')
def docs():
    """API Documentation"""
    api_endpoints = {
        'customers': {
            'GET /api/customers': 'Get all customers',
            'POST /api/customers': 'Create new customer',
            'GET /api/customers/<id>': 'Get customer by ID',
            'PUT /api/customers/<id>': 'Update customer',
            'DELETE /api/customers/<id>': 'Delete customer'
        },
        'bookings': {
            'GET /api/bookings': 'Get all bookings',
            'POST /api/bookings': 'Create new booking',
            'GET /api/bookings/<id>': 'Get booking by ID',
            'PUT /api/bookings/<id>': 'Update booking',
            'DELETE /api/bookings/<id>': 'Delete booking'
        },
        'vouchers': {
            'GET /api/vouchers': 'Get all vouchers',
            'POST /api/vouchers': 'Create new voucher',
            'GET /api/vouchers/<id>': 'Get voucher by ID'
        }
    }
    
    return jsonify({
        'status': 'success',
        'message': 'Welcome to the API',
        'title': 'Dhakul Chan Management System API',
        'version': '1.0'
    })

@api_bp.route('/customers', methods=['GET', 'POST'])
@login_required
def customers():
    """Customer API endpoints"""
    if request.method == 'GET':
        customers = Customer.query.all()
        return jsonify([customer.to_dict() for customer in customers])
    
    elif request.method == 'POST':
        try:
            data = request.get_json()
            
            # Handle both old and new customer field structure
            if data.get('first_name') or data.get('last_name'):
                # New structure with separate fields
                first_name = data.get('first_name', '').strip()
                last_name = data.get('last_name', '').strip()
                name = f"{first_name} {last_name}".strip()
                
                customer = Customer(
                    name=name,
                    first_name=first_name,
                    last_name=last_name,
                    email=data.get('email'),
                    phone=data.get('phone'),
                    address=data.get('address'),
                    nationality=data.get('nationality'),
                    notes=data.get('notes')
                )
            else:
                # Old structure with single name field
                customer = Customer(
                    name=data.get('name'),
                    email=data.get('email'),
                    phone=data.get('phone'),
                    address=data.get('address'),
                    nationality=data.get('nationality'),
                    notes=data.get('notes')
                )
            
            db.session.add(customer)
            db.session.commit()
            return jsonify(customer.to_dict()), 201
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400

@api_bp.route('/customers/<int:customer_id>', methods=['GET', 'PUT', 'DELETE'])
@login_required
def customer_detail(customer_id):
    """Individual customer API endpoints"""
    customer = Customer.query.get_or_404(customer_id)
    
    if request.method == 'GET':
        return jsonify(customer.to_dict())
    
    elif request.method == 'PUT':
        try:
            data = request.get_json()
            
            # Handle both old and new customer field structure
            if data.get('first_name') is not None or data.get('last_name') is not None:
                # Update separate name fields
                customer.first_name = data.get('first_name', customer.first_name)
                customer.last_name = data.get('last_name', customer.last_name)
                # Update combined name field
                if customer.first_name or customer.last_name:
                    customer.name = f"{customer.first_name or ''} {customer.last_name or ''}".strip()
            else:
                # Update single name field
                customer.name = data.get('name', customer.name)
            
            customer.email = data.get('email', customer.email)
            customer.phone = data.get('phone', customer.phone)
            customer.address = data.get('address', customer.address)
            customer.nationality = data.get('nationality', customer.nationality)
            customer.notes = data.get('notes', customer.notes)
            db.session.commit()
            return jsonify(customer.to_dict())
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400
    
    elif request.method == 'DELETE':
        try:
            db.session.delete(customer)
            db.session.commit()
            return '', 204
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400

@api_bp.route('/bookings', methods=['GET', 'POST'])
@login_required
def bookings():
    """Booking API endpoints"""
    if request.method == 'GET':
        bookings = Booking.query.all()
        return jsonify([booking.to_dict() for booking in bookings])
    
    elif request.method == 'POST':
        try:
            data = request.get_json()
            booking = Booking(
                customer_id=data.get('customer_id'),
                booking_reference=generate_booking_reference(),
                booking_type=data.get('booking_type'),
                status=data.get('status', 'pending'),
                created_by=current_user.id
            )
            
            # Set additional fields based on data
            for field in ['arrival_date', 'departure_date', 'traveling_period_start', 
                         'traveling_period_end', 'total_pax', 'total_amount', 'currency',
                         'agency_reference', 'hotel_name', 'room_type', 'special_request',
                         'pickup_point', 'destination', 'vehicle_type', 'internal_note', 'flight_info']:
                if field in data:
                    setattr(booking, field, data[field])
            
            # Handle guest list and daily services
            if 'guest_list' in data:
                booking.set_guest_list(data['guest_list'])
            if 'daily_services' in data:
                booking.set_daily_services(data['daily_services'])
            
            db.session.add(booking)
            db.session.commit()
            return jsonify(booking.to_dict()), 201
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400

@api_bp.route('/bookings/<int:booking_id>', methods=['GET', 'PUT', 'DELETE'])
@login_required
def booking_detail(booking_id):
    """Individual booking API endpoints"""
    booking = Booking.query.get_or_404(booking_id)
    
    if request.method == 'GET':
        return jsonify(booking.to_dict())
    
    elif request.method == 'PUT':
        try:
            data = request.get_json()
            
            # Update fields
            for field in ['booking_type', 'status', 'arrival_date', 'departure_date', 
                         'traveling_period_start', 'traveling_period_end', 'total_pax', 
                         'total_amount', 'currency', 'agency_reference', 'hotel_name', 
                         'room_type', 'special_request', 'pickup_point', 'destination', 
                         'vehicle_type', 'internal_note', 'flight_info']:
                if field in data:
                    setattr(booking, field, data[field])
            
            # Handle guest list and daily services
            if 'guest_list' in data:
                booking.set_guest_list(data['guest_list'])
            if 'daily_services' in data:
                booking.set_daily_services(data['daily_services'])
            
            db.session.commit()
            return jsonify(booking.to_dict())
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400
    
    elif request.method == 'DELETE':
        try:
            db.session.delete(booking)
            db.session.commit()
            return '', 204
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400

@api_bp.route('/invoice-ninja/quote', methods=['POST'])
@login_required
def create_quote():
    """Create quote via Invoice Ninja API"""
    try:
        data = request.get_json()
        invoice_service = InvoiceNinjaService()
        
        quote = invoice_service.create_quote(
            client_id=data.get('client_id'),
            items=data.get('items', []),
            notes=data.get('notes', ''),
            due_date=data.get('due_date')
        )
        
        return jsonify(quote)
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@api_bp.route('/invoice-ninja/invoice', methods=['POST'])
@login_required
def create_invoice():
    """Create invoice via Invoice Ninja API"""
    try:
        data = request.get_json()
        invoice_service = InvoiceNinjaService()
        
        invoice = invoice_service.create_invoice(
            client_id=data.get('client_id'),
            items=data.get('items', []),
            notes=data.get('notes', ''),
            due_date=data.get('due_date')
        )
        
        return jsonify(invoice)
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@api_bp.route('/stats/dashboard')
@login_required
def dashboard_stats():
    """Get dashboard statistics"""
    from datetime import datetime, timedelta
    from sqlalchemy import func
    
    # Basic counts
    total_customers = Customer.query.count()
    total_bookings = Booking.query.count()
    pending_bookings = Booking.query.filter_by(status='pending').count()
    confirmed_bookings = Booking.query.filter_by(status='confirmed').count()
    
    # Revenue stats
    total_revenue = db.session.query(func.sum(Booking.total_amount)).filter(
        Booking.status == 'confirmed'
    ).scalar() or 0
    
    # Monthly stats
    current_month = datetime.now().replace(day=1)
    monthly_bookings = Booking.query.filter(Booking.created_at >= current_month).count()
    monthly_revenue = db.session.query(func.sum(Booking.total_amount)).filter(
        Booking.created_at >= current_month,
        Booking.status == 'confirmed'
    ).scalar() or 0
    
    return jsonify({
        'total_customers': total_customers,
        'total_bookings': total_bookings,
        'pending_bookings': pending_bookings,
        'confirmed_bookings': confirmed_bookings,
        'total_revenue': float(total_revenue),
        'monthly_bookings': monthly_bookings,
        'monthly_revenue': float(monthly_revenue)
    })
