from flask import Blueprint, render_template, jsonify
from flask_login import login_required
from models.customer import Customer
from extensions import db
from services.invoice_ninja import InvoiceNinjaService
from services.booking_invoice import BookingInvoiceService
from sqlalchemy.exc import IntegrityError

sync_bp = Blueprint('sync', __name__, url_prefix='/sync')

@sync_bp.route('/')
@login_required
def index():
    """Sync dashboard: show counts and quick actions"""
    total = Customer.query.count()
    synced = Customer.query.filter(Customer.invoice_ninja_client_id.isnot(None)).count()
    pending = total - synced
    return render_template('sync/index.html', total=total, synced=synced, pending=pending)

@sync_bp.route('/api/stats')
@login_required
def api_stats():
    total = Customer.query.count()
    synced = Customer.query.filter(Customer.invoice_ninja_client_id.isnot(None)).count()
    pending = total - synced
    return jsonify({'total': total, 'synced': synced, 'pending': pending})

@sync_bp.route('/api/sync-customers')
@login_required
def api_sync_customers():
    """Sync unsynced customers to Invoice Ninja (search before create)."""
    inv = InvoiceNinjaService()
    bis = BookingInvoiceService()
    synced_count = 0
    skipped_duplicates = 0
    results = []
    customers = Customer.query.filter(Customer.invoice_ninja_client_id.is_(None)).all()
    for c in customers:
        try:
            client = bis.get_or_create_client(c)
            client_id = client.get('id') if client else None
            if not client_id:
                results.append({'id': c.id, 'error': 'no-client-id'})
                continue

            # If another local customer already linked to this Invoice Ninja client, skip to honor unique index
            other = Customer.query.filter(
                Customer.invoice_ninja_client_id == client_id,
                Customer.id != c.id
            ).first()
            if other:
                skipped_duplicates += 1
                results.append({'id': c.id, 'skipped': 'duplicate-client-link', 'client_id': client_id, 'other_customer_id': other.id})
                continue

            # Safe to link and commit immediately
            if not c.invoice_ninja_client_id:
                c.invoice_ninja_client_id = client_id
                db.session.add(c)
                try:
                    db.session.commit()
                    synced_count += 1
                    results.append({'id': c.id, 'client_id': c.invoice_ninja_client_id})
                except IntegrityError as ie:
                    db.session.rollback()
                    results.append({'id': c.id, 'error': 'commit-unique-failed', 'detail': str(ie)})
                except Exception as e:
                    db.session.rollback()
                    results.append({'id': c.id, 'error': 'commit-failed', 'detail': str(e)})
        except Exception as e:
            db.session.rollback()
            results.append({'id': c.id, 'error': str(e)})
    return jsonify({'ok': True, 'synced_count': synced_count, 'skipped_duplicates': skipped_duplicates, 'results': results})
